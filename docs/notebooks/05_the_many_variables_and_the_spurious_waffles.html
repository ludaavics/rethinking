<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Chapter 5: The Many Variables And The Spurious Waffles &#8212; Statistical Rethinking</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/insipid.css?v=b2d00be7" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

    <script src="../_static/documentation_options.js?v=63867087"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script defer src="../_static/insipid.js"></script>
    <script defer src="../_static/insipid-sidebar.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Chapter 6: The Haunted DAG &amp; The Causal Terror" href="06_the_haunted_dag_and_the_causal_terror.html" />
    <link rel="prev" title="Chapter 4: Geocentric Models" href="04_geocentric_models.html" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
  </head><body>
    <script type="text/javascript">
        document.body.classList.add('js');
    </script>
    <input type="checkbox" id="sidebar-checkbox" style="display: none;">
    <label id="overlay" for="sidebar-checkbox"></label>
    <div class="sidebar-resize-handle"></div>
    <script type="text/javascript">
        try {
            let sidebar = localStorage.getItem('sphinx-sidebar');
            const sidebar_width = localStorage.getItem('sphinx-sidebar-width');
            if (sidebar_width) {
                document.documentElement.style.setProperty('--sidebar-width', sidebar_width);
            }
            // show sidebar on wide screen
            if (!sidebar && window.matchMedia('(min-width: 100rem)').matches) {
                sidebar = 'visible';
                // NB: We don't store the value in localStorage!
            }
            if (sidebar === 'visible') {
                document.getElementById('sidebar-checkbox').checked = true;
            }
        } catch(e) {
            console.info(e);
        }
    </script>
    <header id="topbar-placeholder">
      <div id="topbar">
        <div id="titlebar">
          <div class="buttons">
            <label for="sidebar-checkbox" id="sidebar-button" role="button" tabindex="0" aria-controls="sphinxsidebar" accesskey="M">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>
            </label>
            <button id="search-button" type="button" title="Search" aria-label="Search" aria-expanded="false" aria-controls="search-form" accesskey="S">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
            </button>
          </div>
          <div class="title">
            <a class="parent" href="../index.html" accesskey="U">Statistical Rethinking</a>
            <a class="top" href="#">Chapter 5: The Many Variables And The Spurious Waffles</a>
          </div>
          <div class="buttons">
            <button id="fullscreen-button" type="button" aria-hidden="true">
              <span class="enable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M212.686 315.314L120 408l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C10.697 480 0 469.255 0 456V344c0-21.382 25.803-32.09 40.922-16.971L72 360l92.686-92.686c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.249 6.248 6.249 16.378 0 22.627zm22.628-118.628L328 104l-32.922-31.029C279.958 57.851 290.666 32 312.048 32h112C437.303 32 448 42.745 448 56v112c0 21.382-25.803 32.09-40.922 16.971L376 152l-92.686 92.686c-6.248 6.248-16.379 6.248-22.627 0l-25.373-25.373c-6.249-6.248-6.249-16.378 0-22.627z"/></svg>
              </span>
              <span class="disable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M4.686 427.314L104 328l-32.922-31.029C55.958 281.851 66.666 256 88.048 256h112C213.303 256 224 266.745 224 280v112c0 21.382-25.803 32.09-40.922 16.971L152 376l-99.314 99.314c-6.248 6.248-16.379 6.248-22.627 0L4.686 449.941c-6.248-6.248-6.248-16.379 0-22.627zM443.314 84.686L344 184l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C234.697 256 224 245.255 224 232V120c0-21.382 25.803-32.09 40.922-16.971L296 136l99.314-99.314c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.248 6.248 6.248 16.379 0 22.627z"/></svg>
              </span>
            </button>
          </div>
        </div>
        <div id="searchbox" role="search">
          <form id="search-form" class="search" style="display: none" action="../search.html" method="get">
            <input type="search" name="q" placeholder="Search ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <button>Go</button>
          </form>
        </div>
      </div>
    </header>
    <nav>
      <a href="04_geocentric_models.html" class="nav-icon previous" title="previous:&#13;Chapter 4: Geocentric Models" aria-label="Previous topic" accesskey="P" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6 0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>
      </a>
      <a href="06_the_haunted_dag_and_the_causal_terror.html" class="nav-icon next" title="next:&#13;Chapter 6: The Haunted DAG &amp; The Causal Terror" aria-label="Next topic" accesskey="N" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg>
      </a>
    </nav>

    <nav class="relbar">
      <a class="previous" href="04_geocentric_models.html" aria-label="Previous topic" >
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>
        </div>
        <div class="title">
          <span class="text">
            <span class="direction">previous</span>
            Chapter 4: Geocentric Models
          </span>
        </div>
      </a>
      <a class="next" href="06_the_haunted_dag_and_the_causal_terror.html" aria-label="Next topic" >
        <div class="title">
          <span class="text">
            <span class="direction">next</span>
            Chapter 6: The Haunted DAG &amp; The Causal Terror
          </span>
        </div>
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"/></svg>
        </div>
      </a>
    </nav>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<section id="Chapter-5:-The-Many-Variables-And-The-Spurious-Waffles">
<h1>Chapter 5: The Many Variables And The Spurious Waffles<a class="headerlink" href="#Chapter-5:-The-Many-Variables-And-The-Spurious-Waffles" title="Link to this heading">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> jupyter_black
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<script type="application/javascript" id="jupyter_black">
(function() {
    if (window.IPython === undefined) {
        return
    }
    var msg = "WARNING: it looks like you might have loaded " +
        "jupyter_black in a non-lab notebook with " +
        "`is_lab=True`. Please double check, and if " +
        "loading with `%load_ext` please review the README!"
    console.log(msg)
    alert(msg)
})()
</script></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">daft</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.infer.autoguide</span> <span class="kn">import</span> <span class="n">AutoLaplaceApproximation</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">84735</span>
<span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

<span class="n">optim</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Code">
<h2>Code<a class="headerlink" href="#Code" title="Link to this heading">¶</a></h2>
<section id="Code-5.1">
<h3>Code 5.1<a class="headerlink" href="#Code-5.1" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/WaffleDivorce.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MedianAgeMarriage&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;MedianAgeMarriage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span>
    <span class="s2">&quot;MedianAgeMarriage&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Divorce&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Divorce&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Divorce&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Location</th>
      <th>Loc</th>
      <th>Population</th>
      <th>MedianAgeMarriage</th>
      <th>Marriage</th>
      <th>Marriage SE</th>
      <th>Divorce</th>
      <th>Divorce SE</th>
      <th>WaffleHouses</th>
      <th>South</th>
      <th>Slaves1860</th>
      <th>Population1860</th>
      <th>PropSlaves1860</th>
      <th>A</th>
      <th>D</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alabama</td>
      <td>AL</td>
      <td>4.78</td>
      <td>25.3</td>
      <td>20.2</td>
      <td>1.27</td>
      <td>12.7</td>
      <td>0.79</td>
      <td>128</td>
      <td>1</td>
      <td>435080</td>
      <td>964201</td>
      <td>0.45</td>
      <td>-0.606290</td>
      <td>1.654205</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Alaska</td>
      <td>AK</td>
      <td>0.71</td>
      <td>25.2</td>
      <td>26.0</td>
      <td>2.93</td>
      <td>12.5</td>
      <td>2.05</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.00</td>
      <td>-0.686699</td>
      <td>1.544364</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arizona</td>
      <td>AZ</td>
      <td>6.33</td>
      <td>25.8</td>
      <td>20.3</td>
      <td>0.98</td>
      <td>10.8</td>
      <td>0.74</td>
      <td>18</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.00</td>
      <td>-0.204241</td>
      <td>0.610716</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Arkansas</td>
      <td>AR</td>
      <td>2.92</td>
      <td>24.3</td>
      <td>26.4</td>
      <td>1.70</td>
      <td>13.5</td>
      <td>1.22</td>
      <td>41</td>
      <td>1</td>
      <td>111115</td>
      <td>435450</td>
      <td>0.26</td>
      <td>-1.410387</td>
      <td>2.093569</td>
    </tr>
    <tr>
      <th>4</th>
      <td>California</td>
      <td>CA</td>
      <td>37.25</td>
      <td>26.8</td>
      <td>19.1</td>
      <td>0.39</td>
      <td>8.0</td>
      <td>0.24</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>379994</td>
      <td>0.00</td>
      <td>0.599857</td>
      <td>-0.927058</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-5.2">
<h3>Code 5.2<a class="headerlink" href="#Code-5.2" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MedianAgeMarriage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.2436303013880823
</pre></div></div>
</div>
</section>
<section id="Code-5.3">
<h3>Code 5.3<a class="headerlink" href="#Code-5.3" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_1</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_age_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;divorce&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">divorce</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-5.4">
<h3>Code 5.4<a class="headerlink" href="#Code-5.4" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Median Marriage Age (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Divorce Rate (std)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">age</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">prior_predictive_samples_5_1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model_5_1</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">)(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="n">age</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">prior_predictive_samples_5_1</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">age</span><span class="p">,</span>
        <span class="n">sample</span><span class="p">,</span>
        <span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_10_0.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_10_0.png" />
</div>
</div>
</section>
<section id="Code-5.5">
<h3>Code 5.5<a class="headerlink" href="#Code-5.5" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guide_5_1</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_1</span><span class="p">)</span>
<span class="n">svi_5_1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_1</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_1</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████| 5000/5000 [00:03&lt;00:00, 1457.05it/s, init loss: 206.5594, avg. loss [4751-5000]: 60.6793]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_5_1</span> <span class="o">=</span> <span class="n">guide_5_1</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_1</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_1</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_5_1</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;mu&quot;</span><span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_5_1</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
     alpha      0.00      0.10      0.00     -0.15      0.16  10318.78      1.00
  beta_age     -0.56      0.11     -0.56     -0.75     -0.39   9788.94      1.00
     sigma      0.80      0.08      0.79      0.67      0.92   9772.34      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">age</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">posterior_predictive_5_1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">guide_5_1</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">posterior_samples_5_1</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_5_1</span> <span class="o">=</span> <span class="n">posterior_predictive_5_1</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">age</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">mu_posterior_predictive_5_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">posterior_predictive_samples_5_1</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">age</span>
<span class="p">)</span>
<span class="n">mu_mean_5_1</span> <span class="o">=</span> <span class="n">mu_posterior_predictive_5_1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">mu_hpdi_5_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">mu_posterior_predictive_5_1</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="n">age</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">mu_mean_5_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span> <span class="n">mu_hpdi_5_1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mu_hpdi_5_1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/ltiako/.pyenv/versions/3.12.3/envs/rethinking/lib/python3.12/site-packages/numpy/core/fromnumeric.py:59: FutureWarning: &#39;DataFrame.swapaxes&#39; is deprecated and will be removed in a future version. Please use &#39;DataFrame.transpose&#39; instead.
  return bound(*args, **kwds)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x13d38e570&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_14_2.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_14_2.png" />
</div>
</div>
</section>
<section id="Code-5.6">
<h3>Code 5.6<a class="headerlink" href="#Code-5.6" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Marriage&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Marriage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Marriage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">model_5_2</span><span class="p">(</span>
    <span class="n">marriage</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_marriage&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_marriage_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_marriage</span> <span class="o">*</span> <span class="n">marriage</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;divorce&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">divorce</span>


<span class="n">guide_5_2</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_2</span><span class="p">)</span>
<span class="n">svi_5_2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_2</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_2</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████| 5000/5000 [00:02&lt;00:00, 1885.65it/s, init loss: 271.3738, avg. loss [4751-5000]: 67.4975]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_5_2</span> <span class="o">=</span> <span class="n">guide_5_2</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_2</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_2</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_5_2</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;mu&quot;</span><span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_5_2</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                     mean       std    median      5.5%     94.5%     n_eff     r_hat
          alpha      0.08      0.11      0.08     -0.10      0.25  10318.78      1.00
  beta_marriage      0.35      0.13      0.35      0.14      0.55   9789.40      1.00
          sigma      0.93      0.09      0.93      0.78      1.08   9772.75      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">marriage</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">posterior_predictive_5_2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">guide_5_2</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">posterior_samples_5_2</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_5_2</span> <span class="o">=</span> <span class="n">posterior_predictive_5_2</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">marriage</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">mu_posterior_predictive_5_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">posterior_predictive_samples_5_2</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">age</span>
<span class="p">)</span>
<span class="n">mu_mean_5_2</span> <span class="o">=</span> <span class="n">mu_posterior_predictive_5_2</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">mu_hpdi_5_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">mu_posterior_predictive_5_2</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="n">age</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">mu_mean_5_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span> <span class="n">mu_hpdi_5_2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mu_hpdi_5_2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/ltiako/.pyenv/versions/3.12.3/envs/rethinking/lib/python3.12/site-packages/numpy/core/fromnumeric.py:59: FutureWarning: &#39;DataFrame.swapaxes&#39; is deprecated and will be removed in a future version. Please use &#39;DataFrame.transpose&#39; instead.
  return bound(*args, **kwds)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x13c6dfc80&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_18_2.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_18_2.png" />
</div>
</div>
</section>
<section id="Code-5.7">
<h3>Code 5.7<a class="headerlink" href="#Code-5.7" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_5_1</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">dag_5_1</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)])</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_5_1</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_5_1</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: &gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_20_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_20_1.png" />
</div>
</div>
</section>
<section id="Code-5.8">
<h3>Code 5.8<a class="headerlink" href="#Code-5.8" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DMA_dag2</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">DMA_dag2</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">)])</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">DMA_dag2</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">DMA_dag2</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="n">conditional_independencies</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">DMA_dag2</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">DMA_dag2</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">edge</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subset</span><span class="p">))</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditional_independencies</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_d_separator</span><span class="p">(</span><span class="n">DMA_dag2</span><span class="p">,</span> <span class="p">{</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span> <span class="p">{</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="nb">set</span><span class="p">(</span><span class="n">subset</span><span class="p">)):</span>
                <span class="n">conditional_independencies</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subset</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> _||_ </span><span class="si">{</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; | </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">subset</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
D _||_ M | A
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_22_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_22_1.png" />
</div>
</div>
</section>
<section id="Code-5.9">
<h3>Code 5.9<a class="headerlink" href="#Code-5.9" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DMA_dag1</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">DMA_dag1</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)])</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">DMA_dag1</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">DMA_dag1</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="n">conditional_independencies</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">DMA_dag1</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">DMA_dag1</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">edge</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subset</span><span class="p">))</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditional_independencies</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_d_separator</span><span class="p">(</span><span class="n">DMA_dag1</span><span class="p">,</span> <span class="p">{</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span> <span class="p">{</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="nb">set</span><span class="p">(</span><span class="n">subset</span><span class="p">)):</span>
                <span class="n">conditional_independencies</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subset</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> _||_ </span><span class="si">{</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; | </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">subset</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_24_0.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_24_0.png" />
</div>
</div>
</section>
<section id="Code-5.10">
<h3>Code 5.10<a class="headerlink" href="#Code-5.10" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_3</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span>
    <span class="n">marriage</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_age_prior</span><span class="p">))</span>
    <span class="n">beta_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_marriage&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_marriage_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span> <span class="o">+</span> <span class="n">beta_marriage</span> <span class="o">*</span> <span class="n">marriage</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;divorce&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">divorce</span>


<span class="n">guide_5_3</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_3</span><span class="p">)</span>
<span class="n">svi_5_3</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_3</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_3</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>

<span class="n">posterior_samples_5_3</span> <span class="o">=</span> <span class="n">guide_5_3</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_3</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_3</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_5_3</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_5_3</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████| 5000/5000 [00:02&lt;00:00, 1747.34it/s, init loss: 794.2787, avg. loss [4751-5000]: 60.8140]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                     mean       std    median      5.5%     94.5%     n_eff     r_hat
          alpha      0.00      0.10      0.00     -0.15      0.16  10166.76      1.00
       beta_age     -0.61      0.15     -0.61     -0.87     -0.38   9443.81      1.00
  beta_marriage     -0.06      0.15     -0.07     -0.31      0.17  10004.23      1.00
          sigma      0.80      0.08      0.79      0.67      0.92   9544.84      1.00

</pre></div></div>
</div>
</section>
<section id="Code-5.11">
<h3>Code 5.11<a class="headerlink" href="#Code-5.11" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">coeftab</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;m5.1&quot;</span><span class="p">:</span> <span class="n">guide_5_1</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_1</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1_000</span><span class="p">)),</span>
    <span class="s2">&quot;m5.2&quot;</span><span class="p">:</span> <span class="n">guide_5_2</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_2</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1_000</span><span class="p">)),</span>
    <span class="s2">&quot;m5.3&quot;</span><span class="p">:</span> <span class="n">guide_5_3</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_3</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1_000</span><span class="p">)),</span>
<span class="p">}</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">coeftab</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
    <span class="n">model_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">coeftab</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_marriage&quot;</span><span class="p">],</span>
    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_28_0.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_28_0.png" />
</div>
</div>
</section>
<section id="Code-5.12">
<h3>Code 5.12<a class="headerlink" href="#Code-5.12" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">age</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,))</span>
<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">marriage</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=-</span><span class="n">age</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">divorce</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">age</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-5.13">
<h3>Code 5.13<a class="headerlink" href="#Code-5.13" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_4</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">marriage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_age_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;marriage&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">marriage</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">marriage</span>


<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">guide_5_4</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_4</span><span class="p">)</span>
<span class="n">svi_5_4</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_4</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_4</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">5_000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███| 5000/5000 [00:02&lt;00:00, 2211.52it/s, init loss: 1161.3422, avg. loss [4751-5000]: 53.7594]
</pre></div></div>
</div>
</section>
<section id="Code-5.14">
<h3>Code 5.14<a class="headerlink" href="#Code-5.14" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_5_4</span> <span class="o">=</span> <span class="n">guide_5_4</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_4</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_4</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_5_4</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_5_4</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">mu_mean_5_4</span> <span class="o">=</span> <span class="n">posterior_samples_5_4</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mu_residual_5_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu_mean_5_4</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;M_residual&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">mu_residual_5_4</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
     alpha      0.00      0.09      0.00     -0.13      0.15  10324.41      1.00
  beta_age     -0.70      0.10     -0.70     -0.86     -0.56   9984.89      1.00
     sigma      0.69      0.07      0.69      0.59      0.81   9917.43      1.00

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>40</th>
      <th>41</th>
      <th>42</th>
      <th>43</th>
      <th>44</th>
      <th>45</th>
      <th>46</th>
      <th>47</th>
      <th>48</th>
      <th>49</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>M_residual</th>
      <td>-0.405839</td>
      <td>1.065054</td>
      <td>-0.09819</td>
      <td>0.664002</td>
      <td>0.148483</td>
      <td>0.688116</td>
      <td>0.071987</td>
      <td>1.089168</td>
      <td>1.411507</td>
      <td>-0.629508</td>
      <td>...</td>
      <td>-0.263378</td>
      <td>-0.672745</td>
      <td>-0.119809</td>
      <td>0.943935</td>
      <td>-0.506171</td>
      <td>0.292052</td>
      <td>0.247707</td>
      <td>-0.048024</td>
      <td>-0.633111</td>
      <td>1.739942</td>
    </tr>
  </tbody>
</table>
<p>1 rows × 50 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age at Marriage (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Marriage Rate (std)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="n">mu_mean_5_4</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x13e4d43e0&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_35_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_35_1.png" />
</div>
</div>
</section>
<section id="Code-5.15">
<h3>Code 5.15<a class="headerlink" href="#Code-5.15" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mu_mean_5_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterior_samples_5_3</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
<span class="n">mu_hpdi_5_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">posterior_samples_5_3</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">posterior_predictive_5_3</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">guide_5_3</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">posterior_samples_5_3</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_5_3</span> <span class="o">=</span> <span class="n">posterior_predictive_5_3</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">D_hpdi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
    <span class="n">posterior_predictive_samples_5_3</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-5.16">
<h3>Code 5.16<a class="headerlink" href="#Code-5.16" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Observed Divorce&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Predicted Divorce&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="n">mu_mean_5_3</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mu_hpdi_5_3</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mu_hpdi_5_3</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mu_hpdi_5_3</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_39_0.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_39_0.png" />
</div>
</div>
</section>
<section id="Code-5.17">
<h3>Code 5.17<a class="headerlink" href="#Code-5.17" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Loc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;UT&quot;</span><span class="p">,</span> <span class="s2">&quot;RI&quot;</span><span class="p">,</span> <span class="s2">&quot;ME&quot;</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Loc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">mu_mean_5_3</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">),</span>
            <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset pixels&quot;</span><span class="p">,</span>
        <span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/ltiako/.pyenv/versions/3.12.3/envs/rethinking/lib/python3.12/site-packages/matplotlib/text.py:1464: FutureWarning: Calling float on a single element Series is deprecated and will raise a TypeError in the future. Use float(ser.iloc[0]) instead
  y = float(self.convert_yunits(y))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_41_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_41_1.png" />
</div>
</div>
</section>
<section id="Code-5.18">
<h3>Code 5.18<a class="headerlink" href="#Code-5.18" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x_real</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,))</span>
<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">x_spur</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">x_real</span><span class="p">,</span> <span class="n">x_spur</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x_real&quot;</span><span class="p">,</span> <span class="s2">&quot;x_spur&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>x_real</th>
      <th>x_spur</th>
      <th>y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.5078651</td>
      <td>1.7760372</td>
      <td>1.7760372</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.104137994</td>
      <td>0.739776</td>
      <td>0.739776</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.61742014</td>
      <td>1.5895143</td>
      <td>1.5895143</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-2.0651052</td>
      <td>-1.5216781</td>
      <td>-1.5216781</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.6546873</td>
      <td>-1.8327042</td>
      <td>-1.8327042</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-5.19">
<h3>Code 5.19<a class="headerlink" href="#Code-5.19" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/WaffleDivorce.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MedianAgeMarriage&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;MedianAgeMarriage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span>
    <span class="s2">&quot;MedianAgeMarriage&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Marriage&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Marriage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Marriage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Divorce&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Divorce&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Divorce&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">model_5_3a</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span>
    <span class="n">marriage</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_marriage_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">alpha_divorce_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_divorce_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_divorce_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_divorce_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># A -&gt; M</span>
    <span class="n">alpha_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;alpha_marriage&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_marriage_prior</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">beta_marriage_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;beta_marriage_age&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_marriage_age_prior</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">mu_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;mu_marriage&quot;</span><span class="p">,</span>
        <span class="n">alpha_marriage</span> <span class="o">+</span> <span class="n">beta_marriage_age</span> <span class="o">*</span> <span class="n">age</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">sigma_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;sigma_marriage&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_marriage_prior</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;marriage&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu_marriage</span><span class="p">,</span> <span class="n">sigma_marriage</span><span class="p">),</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">marriage</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># A -&gt; D &lt;- M</span>
    <span class="n">alpha_divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;alpha_divorce&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_divorce_prior</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">beta_divorce_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;beta_divorce_age&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_divorce_age_prior</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">beta_divorce_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;beta_divorce_marriage&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_divorce_marriage_prior</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">mu_divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;mu_divorce&quot;</span><span class="p">,</span>
        <span class="n">alpha_divorce</span> <span class="o">+</span> <span class="n">beta_divorce_age</span> <span class="o">*</span> <span class="n">age</span> <span class="o">+</span> <span class="n">beta_divorce_marriage</span> <span class="o">*</span> <span class="n">marriage</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">sigma_divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;sigma_divorce&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_divorce_prior</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;divorce&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu_divorce</span><span class="p">,</span> <span class="n">sigma_divorce</span><span class="p">),</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">divorce</span>


<span class="n">guide_5_3a</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_3a</span><span class="p">)</span>
<span class="n">svi_5_3a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_3a</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_3a</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██| 5000/5000 [00:03&lt;00:00, 1496.35it/s, init loss: 4109.7266, avg. loss [4751-5000]: 114.6630]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_5_3a</span> <span class="o">=</span> <span class="n">guide_5_3a</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_3a</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_3a</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_5_3a</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu_marriage&quot;</span><span class="p">,</span> <span class="s2">&quot;mu_divorce&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_5_3a</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                             mean       std    median      5.5%     94.5%     n_eff     r_hat
          alpha_divorce     -0.00      0.10     -0.00     -0.15      0.16   9684.35      1.00
         alpha_marriage     -0.00      0.09     -0.00     -0.15      0.14  10000.10      1.00
       beta_divorce_age     -0.61      0.15     -0.61     -0.84     -0.35   9895.35      1.00
  beta_divorce_marriage     -0.06      0.15     -0.06     -0.30      0.18   9788.35      1.00
      beta_marriage_age     -0.74      0.10     -0.74     -0.91     -0.59  10182.34      1.00
          sigma_divorce      0.80      0.08      0.79      0.66      0.92   9739.71      1.00
         sigma_marriage      0.73      0.08      0.72      0.61      0.84  10270.09      1.00

</pre></div></div>
</div>
</section>
<section id="Code-5.20">
<h3>Code 5.20<a class="headerlink" href="#Code-5.20" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ages</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Codes-5.21">
<h3>Codes 5.21<a class="headerlink" href="#Codes-5.21" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_predictive_5_3a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_3a</span><span class="p">,</span>
    <span class="n">posterior_samples</span><span class="o">=</span><span class="n">posterior_samples_5_3a</span><span class="p">,</span>
    <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;marriage&quot;</span><span class="p">,</span> <span class="s2">&quot;divorce&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">divorce_age_counterfactual_5_3a</span> <span class="o">=</span> <span class="n">posterior_predictive_5_3a</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">ages</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">marriage_mean_5_3a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">divorce_age_counterfactual_5_3a</span><span class="p">[</span><span class="s2">&quot;marriage&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="p">)</span>
<span class="n">marriage_hpdi_5_3a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">divorce_age_counterfactual_5_3a</span><span class="p">[</span><span class="s2">&quot;marriage&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">divorce_mean_5_3a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">divorce_age_counterfactual_5_3a</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="p">)</span>
<span class="n">divorce_hpdi_5_3a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">divorce_age_counterfactual_5_3a</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-5.22">
<h3>Code 5.22<a class="headerlink" href="#Code-5.22" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">divorce_mean_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">ages</span><span class="p">,</span>
    <span class="n">divorce_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">divorce_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Manipulated Age (std)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Counterfactual Divorce Rate (std)&quot;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">marriage_mean_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">ages</span><span class="p">,</span>
    <span class="n">marriage_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">marriage_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Manipulated Age at Marriage (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Counteractual Impact on Marriage Rate (std)&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Text(0.5, 0, &#39;Manipulated Age at Marriage (std)&#39;),
 Text(0, 0.5, &#39;Counteractual Impact on Marriage Rate (std)&#39;)]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_52_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_52_1.png" />
</div>
</div>
</section>
<section id="Code-5.23">
<h3>Code 5.23<a class="headerlink" href="#Code-5.23" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">marriages</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">divorce_marriage_counterfactual_samples_5_3a</span> <span class="o">=</span> <span class="n">posterior_predictive_5_3a</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">marriages</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">divorce_marriage_counterfactual_mean_5_3a</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">divorce_marriage_counterfactual_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
    <span class="o">.</span><span class="n">T</span>
<span class="p">)</span>
<span class="n">divorce_marriage_counterfactual_hpdi_5_3a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
        <span class="n">divorce_marriage_counterfactual_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marriages</span><span class="p">,</span> <span class="n">divorce_marriage_counterfactual_mean_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">marriages</span><span class="p">,</span>
    <span class="n">divorce_marriage_counterfactual_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">divorce_marriage_counterfactual_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Manipulated Marriage Rate (std)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Counterfactual Divorce Rate (std)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total counterfactual impact of Marriage Rate on Divorce Rate&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Total counterfactual impact of Marriage Rate on Divorce Rate&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_54_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_54_1.png" />
</div>
</div>
</section>
<section id="Code-5.24">
<h3>Code 5.24<a class="headerlink" href="#Code-5.24" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ages</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-5.25">
<h3>Code 5.25<a class="headerlink" href="#Code-5.25" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_5_3a</span> <span class="o">=</span> <span class="n">guide_5_3a</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_3a</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">posterior_samples_5_3a</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_5_3a</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">marriage_counterfactual_5_3a</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
    <span class="n">posterior_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;alpha_marriage&quot;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">posterior_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;beta_marriage_age&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ages</span><span class="p">,</span>
    <span class="n">posterior_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;sigma_marriage&quot;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>

<span class="n">marriage_mean_5_3a</span> <span class="o">=</span> <span class="n">marriage_counterfactual_5_3a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">marriage_hpdi_5_3a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">marriage_counterfactual_5_3a</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-5.26">
<h3>Code 5.26<a class="headerlink" href="#Code-5.26" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">divorce_counterfactual_5_3a</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
    <span class="n">posterior_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;alpha_divorce&quot;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">posterior_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;beta_divorce_age&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ages</span>
    <span class="o">+</span> <span class="n">posterior_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;beta_divorce_marriage&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">marriage_counterfactual_5_3a</span><span class="p">,</span>
    <span class="n">posterior_samples_5_3a</span><span class="p">[</span><span class="s2">&quot;sigma_divorce&quot;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">divorce_mean_5_3a</span> <span class="o">=</span> <span class="n">divorce_counterfactual_5_3a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">divorce_hpdi_5_3a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">divorce_counterfactual_5_3a</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">divorce_mean_5_3a</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">ages</span><span class="p">,</span>
    <span class="n">divorce_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">divorce_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Manipulated Age (std)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Counterfactual Divorce Rate (std)&quot;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">marriage_mean_5_3a</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">ages</span><span class="p">,</span>
    <span class="n">marriage_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">marriage_hpdi_5_3a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Manipulated Age at Marriage (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Counteractual Impact on Marriage Rate (std)&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Text(0.5, 0, &#39;Manipulated Age at Marriage (std)&#39;),
 Text(0, 0.5, &#39;Counteractual Impact on Marriage Rate (std)&#39;)]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_61_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_61_1.png" />
</div>
</div>
</section>
<section id="Code-5.27">
<h3>Code 5.27<a class="headerlink" href="#Code-5.27" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/milk.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>clade</th>
      <th>species</th>
      <th>kcal.per.g</th>
      <th>perc.fat</th>
      <th>perc.protein</th>
      <th>perc.lactose</th>
      <th>mass</th>
      <th>neocortex.perc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Strepsirrhine</td>
      <td>Eulemur fulvus</td>
      <td>0.49</td>
      <td>16.60</td>
      <td>15.42</td>
      <td>67.98</td>
      <td>1.95</td>
      <td>55.16</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Strepsirrhine</td>
      <td>E macaco</td>
      <td>0.51</td>
      <td>19.27</td>
      <td>16.91</td>
      <td>63.82</td>
      <td>2.09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Strepsirrhine</td>
      <td>E mongoz</td>
      <td>0.46</td>
      <td>14.11</td>
      <td>16.85</td>
      <td>69.04</td>
      <td>2.51</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Strepsirrhine</td>
      <td>E rubriventer</td>
      <td>0.48</td>
      <td>14.91</td>
      <td>13.18</td>
      <td>71.91</td>
      <td>1.62</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Strepsirrhine</td>
      <td>Lemur catta</td>
      <td>0.60</td>
      <td>27.28</td>
      <td>19.50</td>
      <td>53.22</td>
      <td>2.19</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-5.28">
<h3>Code 5.28<a class="headerlink" href="#Code-5.28" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;kcal.per.g&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;neocortex.perc&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-5.29">
<h3>Code 5.29<a class="headerlink" href="#Code-5.29" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_5_draft</span><span class="p">(</span>
    <span class="n">N</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">beta_N_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_N</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_N&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_N_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_N</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">K</span>


<span class="k">try</span><span class="p">:</span>
    <span class="n">guide_5_5_draft</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_5_draft</span><span class="p">)</span>
    <span class="n">svi_5_5_draft</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_5_5_draft</span><span class="p">,</span>
        <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_5_draft</span><span class="p">,</span>
        <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
        <span class="n">N</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">K</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Normal distribution got invalid loc parameter.
</pre></div></div>
</div>
</section>
<section id="Code-5.30">
<h3>Code 5.30<a class="headerlink" href="#Code-5.30" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;neocortex.perc&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0     55.16
1       NaN
2       NaN
3       NaN
4       NaN
5     64.54
6     64.54
7     67.64
8       NaN
9     68.85
10    58.85
11    61.69
12    60.32
13      NaN
14      NaN
15    69.97
16      NaN
17    70.41
18      NaN
19    73.40
20      NaN
21    67.53
22      NaN
23    71.26
24    72.60
25      NaN
26    70.24
27    76.30
28    75.49
Name: neocortex.perc, dtype: float64
</pre></div></div>
</div>
</section>
<section id="5.31">
<h3>5.31<a class="headerlink" href="#5.31" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dcc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">dcc</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>clade</th>
      <th>species</th>
      <th>kcal.per.g</th>
      <th>perc.fat</th>
      <th>perc.protein</th>
      <th>perc.lactose</th>
      <th>mass</th>
      <th>neocortex.perc</th>
      <th>K</th>
      <th>N</th>
      <th>M</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Strepsirrhine</td>
      <td>Eulemur fulvus</td>
      <td>0.49</td>
      <td>16.60</td>
      <td>15.42</td>
      <td>67.98</td>
      <td>1.95</td>
      <td>55.16</td>
      <td>-0.940041</td>
      <td>-2.080196</td>
      <td>-0.463904</td>
    </tr>
    <tr>
      <th>5</th>
      <td>New World Monkey</td>
      <td>Alouatta seniculus</td>
      <td>0.47</td>
      <td>21.22</td>
      <td>23.58</td>
      <td>55.20</td>
      <td>5.25</td>
      <td>64.54</td>
      <td>-1.063955</td>
      <td>-0.508641</td>
      <td>0.129697</td>
    </tr>
    <tr>
      <th>6</th>
      <td>New World Monkey</td>
      <td>A palliata</td>
      <td>0.56</td>
      <td>29.66</td>
      <td>23.46</td>
      <td>46.88</td>
      <td>5.37</td>
      <td>64.54</td>
      <td>-0.506340</td>
      <td>-0.508641</td>
      <td>0.143242</td>
    </tr>
    <tr>
      <th>7</th>
      <td>New World Monkey</td>
      <td>Cebus apella</td>
      <td>0.89</td>
      <td>53.41</td>
      <td>15.80</td>
      <td>30.79</td>
      <td>2.51</td>
      <td>67.64</td>
      <td>1.538249</td>
      <td>0.010742</td>
      <td>-0.312595</td>
    </tr>
    <tr>
      <th>9</th>
      <td>New World Monkey</td>
      <td>S sciureus</td>
      <td>0.92</td>
      <td>50.58</td>
      <td>22.33</td>
      <td>27.09</td>
      <td>0.68</td>
      <td>68.85</td>
      <td>1.724120</td>
      <td>0.213470</td>
      <td>-1.095320</td>
    </tr>
    <tr>
      <th>10</th>
      <td>New World Monkey</td>
      <td>Cebuella pygmaea</td>
      <td>0.80</td>
      <td>41.35</td>
      <td>20.85</td>
      <td>37.80</td>
      <td>0.12</td>
      <td>58.85</td>
      <td>0.980633</td>
      <td>-1.461962</td>
      <td>-2.134963</td>
    </tr>
    <tr>
      <th>11</th>
      <td>New World Monkey</td>
      <td>Callimico goeldii</td>
      <td>0.46</td>
      <td>3.93</td>
      <td>25.30</td>
      <td>70.77</td>
      <td>0.47</td>
      <td>61.69</td>
      <td>-1.125913</td>
      <td>-0.986139</td>
      <td>-1.316698</td>
    </tr>
    <tr>
      <th>12</th>
      <td>New World Monkey</td>
      <td>Callithrix jacchus</td>
      <td>0.71</td>
      <td>38.38</td>
      <td>20.09</td>
      <td>41.53</td>
      <td>0.32</td>
      <td>60.32</td>
      <td>0.423018</td>
      <td>-1.215673</td>
      <td>-1.547097</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Old World Monkey</td>
      <td>Miopithecus talpoin</td>
      <td>0.68</td>
      <td>40.15</td>
      <td>18.08</td>
      <td>41.77</td>
      <td>1.55</td>
      <td>69.97</td>
      <td>0.237147</td>
      <td>0.401118</td>
      <td>-0.601501</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Old World Monkey</td>
      <td>M mulatta</td>
      <td>0.97</td>
      <td>55.51</td>
      <td>13.17</td>
      <td>31.32</td>
      <td>3.24</td>
      <td>70.41</td>
      <td>2.033906</td>
      <td>0.474837</td>
      <td>-0.159585</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Old World Monkey</td>
      <td>Papio spp</td>
      <td>0.84</td>
      <td>54.31</td>
      <td>10.97</td>
      <td>34.72</td>
      <td>12.30</td>
      <td>73.40</td>
      <td>1.228462</td>
      <td>0.975791</td>
      <td>0.639970</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Ape</td>
      <td>Hylobates lar</td>
      <td>0.62</td>
      <td>34.51</td>
      <td>12.57</td>
      <td>52.92</td>
      <td>5.37</td>
      <td>67.53</td>
      <td>-0.134597</td>
      <td>-0.007687</td>
      <td>0.143242</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ape</td>
      <td>Pongo pygmaeus</td>
      <td>0.54</td>
      <td>37.78</td>
      <td>7.37</td>
      <td>54.85</td>
      <td>35.48</td>
      <td>71.26</td>
      <td>-0.630255</td>
      <td>0.617249</td>
      <td>1.274910</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Ape</td>
      <td>Gorilla gorilla gorilla</td>
      <td>0.49</td>
      <td>27.18</td>
      <td>16.29</td>
      <td>56.53</td>
      <td>79.43</td>
      <td>72.60</td>
      <td>-0.940041</td>
      <td>0.841756</td>
      <td>1.757934</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Ape</td>
      <td>Pan paniscus</td>
      <td>0.48</td>
      <td>21.18</td>
      <td>11.68</td>
      <td>67.14</td>
      <td>40.74</td>
      <td>70.24</td>
      <td>-1.001998</td>
      <td>0.446355</td>
      <td>1.357765</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Ape</td>
      <td>P troglodytes</td>
      <td>0.55</td>
      <td>36.84</td>
      <td>9.54</td>
      <td>53.62</td>
      <td>33.11</td>
      <td>76.30</td>
      <td>-0.568297</td>
      <td>1.461666</td>
      <td>1.233474</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Ape</td>
      <td>Homo sapiens</td>
      <td>0.71</td>
      <td>50.49</td>
      <td>9.84</td>
      <td>39.67</td>
      <td>54.95</td>
      <td>75.49</td>
      <td>0.423018</td>
      <td>1.325956</td>
      <td>1.537100</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-5.32">
<h3>Code 5.32<a class="headerlink" href="#Code-5.32" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">svi_5_5_draft</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_5_draft</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_5_draft</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
    <span class="n">N</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">K</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████| 5000/5000 [00:02&lt;00:00, 1847.90it/s, init loss: 53.4755, avg. loss [4751-5000]: 27.4494]
</pre></div></div>
</div>
</section>
<section id="Code-5.33">
<h3>Code 5.33<a class="headerlink" href="#Code-5.33" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">prior_samples_5_5_draft</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_5_draft</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Neocortext Percentage (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Kcal/g of Milk (std)&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Priors:</span><span class="se">\n</span><span class="s2">alpha ~ N(0,1)</span><span class="se">\n</span><span class="s2">beta ~ N(0,1)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">prior_samples_5_5_draft</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_75_0.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_75_0.png" />
</div>
</div>
</section>
<section id="Code-5.34">
<h3>Code 5.34<a class="headerlink" href="#Code-5.34" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_5</span><span class="p">(</span>
    <span class="n">N</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_N_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_N</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_N&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_N_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_N</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">K</span>


<span class="n">guide_5_5</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_5</span><span class="p">)</span>
<span class="n">svi_5_5</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_5</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_5</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
    <span class="n">N</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">K</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>

<span class="n">prior_samples_5_5</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_5_5</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">50</span><span class="p">)(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Neocortext Percentage (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Kcal/g of Milk (std)&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Priors:</span><span class="se">\n</span><span class="s2">alpha ~ N(0,0.2)</span><span class="se">\n</span><span class="s2">beta ~ N(0,0.5)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">prior_samples_5_5</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████| 5000/5000 [00:02&lt;00:00, 2044.05it/s, init loss: 61.9034, avg. loss [4751-5000]: 25.2326]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_77_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_77_1.png" />
</div>
</div>
</section>
<section id="Code-5.35">
<h3>Code 5.35<a class="headerlink" href="#Code-5.35" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_5_5</span> <span class="o">=</span> <span class="n">guide_5_5</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_5</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_5</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_5_5</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span><span class="n">_posterior_samples_5_5</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
     alpha      0.01      0.15      0.01     -0.24      0.26    914.61      1.00
    beta_N      0.11      0.21      0.10     -0.21      0.48    995.35      1.00
     sigma      1.02      0.17      1.01      0.74      1.28   1037.41      1.00

</pre></div></div>
</div>
</section>
<section id="Code-5.36">
<h3>Code 5.36<a class="headerlink" href="#Code-5.36" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">posterior_predictive_5_5</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_5</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">posterior_samples_5_5</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1_000</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_5_5</span> <span class="o">=</span> <span class="n">posterior_predictive_5_5</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>

<span class="n">mu_mean_5_5</span> <span class="o">=</span> <span class="n">posterior_predictive_samples_5_5</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mu_hpdi_5_5</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
    <span class="n">posterior_predictive_samples_5_5</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">],</span> <span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">mu_mean_5_5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">mu_hpdi_5_5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu_hpdi_5_5</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x13f814ef0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_81_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_81_1.png" />
</div>
</div>
</section>
<section id="Code-5.37">
<h3>Code 5.37<a class="headerlink" href="#Code-5.37" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_6</span><span class="p">(</span>
    <span class="n">M</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_M_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_M</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_M&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_M_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_M</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">K</span>


<span class="n">guide_5_6</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_6</span><span class="p">)</span>
<span class="n">svi_5_6</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_6</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_6</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">M</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">K</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">1_000</span><span class="p">)</span>

<span class="n">posterior_samples_5_6</span> <span class="o">=</span> <span class="n">guide_5_6</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_6</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_6</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_5_6</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span><span class="n">_posterior_samples_5_6</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████| 1000/1000 [00:01&lt;00:00, 707.12it/s, init loss: 85.2329, avg. loss [951-1000]: 24.4157]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
     alpha      0.04      0.15      0.04     -0.21      0.28    914.61      1.00
    beta_M     -0.28      0.18     -0.29     -0.54      0.06    992.45      1.00
     sigma      0.99      0.17      0.98      0.74      1.27   1033.37      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">posterior_predictive_5_6</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_6</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">posterior_samples_5_6</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_5_6</span> <span class="o">=</span> <span class="n">posterior_predictive_5_6</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>

<span class="n">mu_mean_5_6</span> <span class="o">=</span> <span class="n">posterior_predictive_samples_5_6</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mu_hpdi_5_6</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
    <span class="n">posterior_predictive_samples_5_6</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;log body mass (std)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;kcal/g (std)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu_mean_5_6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu_hpdi_5_6</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu_hpdi_5_6</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x13f9900e0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_84_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_84_1.png" />
</div>
</div>
</section>
<section id="Code-5.38">
<h3>Code 5.38<a class="headerlink" href="#Code-5.38" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_7</span><span class="p">(</span>
    <span class="n">M</span><span class="p">,</span>
    <span class="n">N</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_N_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_M_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_M</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_M&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_M_prior</span><span class="p">))</span>
    <span class="n">beta_N</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_N&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_N_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_M</span> <span class="o">*</span> <span class="n">M</span> <span class="o">+</span> <span class="n">beta_N</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">K</span>


<span class="n">guide_5_7</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_7</span><span class="p">)</span>
<span class="n">svi_5_7</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_7</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_7</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">N</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">M</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">K</span><span class="o">=</span><span class="n">dcc</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>

<span class="n">posterior_samples_5_7</span> <span class="o">=</span> <span class="n">guide_5_7</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_7</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_7</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_5_7</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span><span class="n">_posterior_samples_5_7</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████| 5000/5000 [00:03&lt;00:00, 1521.40it/s, init loss: 92.9729, avg. loss [4751-5000]: 22.1066]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
     alpha      0.03      0.13      0.03     -0.19      0.24   1008.94      1.00
    beta_M     -0.71      0.22     -0.71     -1.07     -0.36   1013.26      1.00
    beta_N      0.64      0.25      0.64      0.21      1.00    968.41      1.00
     sigma      0.77      0.14      0.75      0.55      1.00    700.47      1.00

</pre></div></div>
</div>
</section>
<section id="Code-5.39">
<h3>Code 5.39<a class="headerlink" href="#Code-5.39" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coeftab</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;m5.5&quot;</span><span class="p">:</span> <span class="n">guide_5_5</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">svi_5_5</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;m5.6&quot;</span><span class="p">:</span> <span class="n">guide_5_6</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">svi_5_6</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;m5.7&quot;</span><span class="p">:</span> <span class="n">guide_5_7</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">svi_5_7</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">}</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">coeftab</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
    <span class="n">model_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">coeftab</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;beta_M&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_N&quot;</span><span class="p">],</span>
    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_88_0.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_88_0.png" />
</div>
</div>
</section>
<section id="Code-5.40">
<h3>Code 5.40<a class="headerlink" href="#Code-5.40" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">posterior_predictive_5_7</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_7</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">posterior_samples_5_7</span>
<span class="p">)</span>
<span class="n">intervention_M_samples_5_7</span> <span class="o">=</span> <span class="n">posterior_predictive_5_7</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">intervention_M_mu_mean_5_7</span> <span class="o">=</span> <span class="n">intervention_M_samples_5_7</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">intervention_M_mu_hpdi_5_7</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
    <span class="n">intervention_M_samples_5_7</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;log body mass (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;kcal/g (std)&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Counterfactual holding N=0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">intervention_M_mu_mean_5_7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">M</span><span class="p">,</span>
    <span class="n">intervention_M_mu_hpdi_5_7</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">intervention_M_mu_hpdi_5_7</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x13fc14cb0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_90_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_90_1.png" />
</div>
</div>
</section>
<section id="Code-5.41">
<h3>Code 5.41<a class="headerlink" href="#Code-5.41" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># M -&gt; K &lt;- N</span>
<span class="c1"># M -&gt; N</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,))</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="n">df_sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">})</span>
<span class="n">df_sim</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>M</th>
      <th>N</th>
      <th>K</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>M</th>
      <td>1.000000</td>
      <td>0.685234</td>
      <td>-0.048061</td>
    </tr>
    <tr>
      <th>N</th>
      <td>0.685234</td>
      <td>1.000000</td>
      <td>0.519596</td>
    </tr>
    <tr>
      <th>K</th>
      <td>-0.048061</td>
      <td>0.519596</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-5.42">
<h3>Code 5.42<a class="headerlink" href="#Code-5.42" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># M -&gt; K &lt;- N</span>
<span class="c1"># N -&gt; M</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="n">df_sim2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">})</span>
<span class="n">df_sim2</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>M</th>
      <th>N</th>
      <th>K</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>M</th>
      <td>1.000000</td>
      <td>0.685234</td>
      <td>-0.525818</td>
    </tr>
    <tr>
      <th>N</th>
      <td>0.685234</td>
      <td>1.000000</td>
      <td>-0.022142</td>
    </tr>
    <tr>
      <th>K</th>
      <td>-0.525818</td>
      <td>-0.022142</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># M -&gt; K &lt;- N</span>
<span class="c1"># M &lt;- U -&gt; N</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="n">df_sim2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">})</span>
<span class="n">df_sim2</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>M</th>
      <th>N</th>
      <th>K</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>M</th>
      <td>1.000000</td>
      <td>0.526510</td>
      <td>-0.344749</td>
    </tr>
    <tr>
      <th>N</th>
      <td>0.526510</td>
      <td>1.000000</td>
      <td>0.411331</td>
    </tr>
    <tr>
      <th>K</th>
      <td>-0.344749</td>
      <td>0.411331</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>### Code 5.43</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag5_7</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">dag5_7</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)])</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)}</span>
<span class="n">MElist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">new_dag</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
            <span class="n">new_dag</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">edge</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">flip</span> <span class="k">else</span> <span class="n">edge</span>
                    <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">flip</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dag5_7</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">simple_cycles</span><span class="p">(</span><span class="n">new_dag</span><span class="p">)):</span>
                <span class="n">MElist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_dag</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_dag</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span>
    <span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Markov Equivalent DAGs&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">dag</span> <span class="ow">in</span> <span class="n">MElist</span><span class="p">:</span>
    <span class="n">plot_dag</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Markov Equivalent DAGs
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_2.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_3.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_4.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_5.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_5.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_6.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_97_6.png" />
</div>
</div>
</section>
<section id="Code-5.44">
<h3>Code 5.44<a class="headerlink" href="#Code-5.44" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/Howell1.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>height</th>
      <th>weight</th>
      <th>age</th>
      <th>male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>151.765</td>
      <td>47.825606</td>
      <td>63.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>139.700</td>
      <td>36.485807</td>
      <td>63.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>136.525</td>
      <td>31.864838</td>
      <td>65.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>156.845</td>
      <td>53.041914</td>
      <td>41.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>145.415</td>
      <td>41.276872</td>
      <td>51.0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-5.45">
<h3>Code 5.45<a class="headerlink" href="#Code-5.45" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mu_female</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">178</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,))</span>
<span class="n">mu_male</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">178</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span> <span class="o">+</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,))</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;mu_female&quot;</span><span class="p">:</span> <span class="n">mu_female</span><span class="p">,</span> <span class="s2">&quot;mu_male&quot;</span><span class="p">:</span> <span class="n">mu_male</span><span class="p">},</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                 mean       std    median      5.0%     95.0%     n_eff     r_hat
  mu_female    178.21     20.22    178.24    145.65    212.05   9943.61      1.00
    mu_male    178.00     22.38    178.00    142.54    216.06   9552.78      1.00

</pre></div></div>
</div>
</section>
<section id="Code-5.46">
<h3>Code 5.46<a class="headerlink" href="#Code-5.46" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">male</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">male</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;male&quot;</span><span class="p">]]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>height</th>
      <th>weight</th>
      <th>age</th>
      <th>male</th>
      <th>sex</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>151.765</td>
      <td>47.825606</td>
      <td>63.0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>139.700</td>
      <td>36.485807</td>
      <td>63.0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>136.525</td>
      <td>31.864838</td>
      <td>65.0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>156.845</td>
      <td>53.041914</td>
      <td>41.0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>145.415</td>
      <td>41.276872</td>
      <td>51.0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-5.47">
<h3>Code 5.47<a class="headerlink" href="#Code-5.47" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_8</span><span class="p">(</span>
    <span class="n">sex</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">178</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
    <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sex</span><span class="p">))):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">[</span><span class="n">sex</span><span class="p">])</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">height</span>


<span class="n">guide_5_8</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_8</span><span class="p">)</span>
<span class="n">svi_5_8</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_8</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_8</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">sex</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>

<span class="n">posterior_samples_5_8</span> <span class="o">=</span> <span class="n">guide_5_8</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_8</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_8</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_5_8</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_5_8</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█| 5000/5000 [00:02&lt;00:00, 2218.77it/s, init loss: 5633.5122, avg. loss [4751-5000]: 2584.2413]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
  alpha[0]    134.86      1.57    134.89    132.35    137.38    914.61      1.00
  alpha[1]    142.57      1.62    142.50    140.26    145.33    994.85      1.00
     sigma     27.44      0.83     27.45     26.19     28.78   1038.25      1.00

</pre></div></div>
</div>
</section>
<section id="Code-5.48">
<h3>Code 5.48<a class="headerlink" href="#Code-5.48" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_5_8</span> <span class="o">=</span> <span class="n">guide_5_8</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_8</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">posterior_samples_5_8</span><span class="p">[</span><span class="s2">&quot;diff_fm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">posterior_samples_5_8</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">posterior_samples_5_8</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_8</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_5_8</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_5_8</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
  alpha[0]    134.86      1.57    134.89    132.35    137.38    914.61      1.00
  alpha[1]    142.57      1.62    142.50    140.26    145.33    994.85      1.00
   diff_fm     -7.70      2.26     -7.71    -11.10     -3.87    909.92      1.00
     sigma     27.44      0.83     27.45     26.19     28.78   1038.25      1.00

</pre></div></div>
</div>
</section>
<section id="Code-5.49">
<h3>Code 5.49<a class="headerlink" href="#Code-5.49" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/milk.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;clade&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>clade</th>
      <th>species</th>
      <th>kcal.per.g</th>
      <th>perc.fat</th>
      <th>perc.protein</th>
      <th>perc.lactose</th>
      <th>mass</th>
      <th>neocortex.perc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Strepsirrhine</td>
      <td>Eulemur fulvus</td>
      <td>0.49</td>
      <td>16.60</td>
      <td>15.42</td>
      <td>67.98</td>
      <td>1.95</td>
      <td>55.16</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Strepsirrhine</td>
      <td>E macaco</td>
      <td>0.51</td>
      <td>19.27</td>
      <td>16.91</td>
      <td>63.82</td>
      <td>2.09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Strepsirrhine</td>
      <td>E mongoz</td>
      <td>0.46</td>
      <td>14.11</td>
      <td>16.85</td>
      <td>69.04</td>
      <td>2.51</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Strepsirrhine</td>
      <td>E rubriventer</td>
      <td>0.48</td>
      <td>14.91</td>
      <td>13.18</td>
      <td>71.91</td>
      <td>1.62</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Strepsirrhine</td>
      <td>Lemur catta</td>
      <td>0.60</td>
      <td>27.28</td>
      <td>19.50</td>
      <td>53.22</td>
      <td>2.19</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;Strepsirrhine&#39;, &#39;New World Monkey&#39;, &#39;Old World Monkey&#39;, &#39;Ape&#39;],
      dtype=object)
</pre></div></div>
</div>
</section>
<section id="Code-5.50">
<h3>Code 5.50<a class="headerlink" href="#Code-5.50" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;clade&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;clade_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;clade&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>clade</th>
      <th>species</th>
      <th>kcal.per.g</th>
      <th>perc.fat</th>
      <th>perc.protein</th>
      <th>perc.lactose</th>
      <th>mass</th>
      <th>neocortex.perc</th>
      <th>clade_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Strepsirrhine</td>
      <td>Eulemur fulvus</td>
      <td>0.49</td>
      <td>16.60</td>
      <td>15.42</td>
      <td>67.98</td>
      <td>1.95</td>
      <td>55.16</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Strepsirrhine</td>
      <td>E macaco</td>
      <td>0.51</td>
      <td>19.27</td>
      <td>16.91</td>
      <td>63.82</td>
      <td>2.09</td>
      <td>NaN</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Strepsirrhine</td>
      <td>E mongoz</td>
      <td>0.46</td>
      <td>14.11</td>
      <td>16.85</td>
      <td>69.04</td>
      <td>2.51</td>
      <td>NaN</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Strepsirrhine</td>
      <td>E rubriventer</td>
      <td>0.48</td>
      <td>14.91</td>
      <td>13.18</td>
      <td>71.91</td>
      <td>1.62</td>
      <td>NaN</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Strepsirrhine</td>
      <td>Lemur catta</td>
      <td>0.60</td>
      <td>27.28</td>
      <td>19.50</td>
      <td>53.22</td>
      <td>2.19</td>
      <td>NaN</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-5.51">
<h3>Code 5.51<a class="headerlink" href="#Code-5.51" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;kcal.per.g&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">model_5_9</span><span class="p">(</span>
    <span class="n">clade_id</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;clade&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">classes_</span><span class="p">)):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">clade_id</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">K</span>


<span class="n">guide_5_9</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_9</span><span class="p">)</span>
<span class="n">svi_5_9</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_9</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_9</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">clade_id</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;clade_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">K</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████| 5000/5000 [00:02&lt;00:00, 2137.70it/s, init loss: 92.6402, avg. loss [4751-5000]: 36.3026]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_5_9</span> <span class="o">=</span> <span class="n">guide_5_9</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_9</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">posterior_samples_5_9</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">({</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">posterior_samples_5_9</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;alpha[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">labels</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">([</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">classes_</span><span class="p">))</span>
    <span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;expected kcal (std)&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
  alpha[0]     -0.50      0.22     -0.50     -0.84     -0.13    909.54      1.00
  alpha[1]      0.38      0.22      0.39      0.01      0.71    933.70      1.00
  alpha[2]      0.69      0.27      0.68      0.29      1.14    907.42      1.00
  alpha[3]     -0.60      0.27     -0.60     -1.03     -0.16   1045.82      1.00
     sigma      0.76      0.10      0.75      0.59      0.91    956.86      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[Text(0, 0.0, &#39;alpha[3]: Strepsirrhine&#39;),
  Text(0, 2.475, &#39;alpha[2]: Old World Monkey&#39;),
  Text(0, 4.950000000000001, &#39;alpha[1]: New World Monkey&#39;),
  Text(0, 7.425000000000001, &#39;alpha[0]: Ape&#39;)],
 Text(0.5, 0, &#39;expected kcal (std)&#39;)]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_114_2.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_114_2.png" />
</div>
</div>
</section>
<section id="Code-5.52">
<h3>Code 5.52<a class="headerlink" href="#Code-5.52" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;house&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-5.53">
<h3>Code 5.53<a class="headerlink" href="#Code-5.53" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_10</span><span class="p">(</span>
    <span class="n">clade</span><span class="p">,</span>
    <span class="n">house</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_clade_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">alpha_house_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;clade&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">classes_</span><span class="p">)):</span>
        <span class="n">alpha_clade</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha_clade&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_clade_prior</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;house&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">house</span><span class="p">))):</span>
        <span class="n">alpha_house</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha_house&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_house_prior</span><span class="p">))</span>

    <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha_clade</span><span class="p">[</span><span class="n">clade</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha_house</span><span class="p">[</span><span class="n">house</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">K</span>


<span class="n">guide_5_10</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_10</span><span class="p">)</span>
<span class="n">svi_5_10</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_10</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_10</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">clade</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;clade_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">house</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;house&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">K</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
<span class="n">posterior_samples_5_10</span> <span class="o">=</span> <span class="n">guide_5_10</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_10</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_5_10</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_5_10</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_5_10</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████| 5000/5000 [00:04&lt;00:00, 1198.40it/s, init loss: 75.6186, avg. loss [4751-5000]: 36.8170]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                    mean       std    median      5.5%     94.5%     n_eff     r_hat
alpha_clade[0]     -0.42      0.27     -0.42     -0.86     -0.02   1005.14      1.00
alpha_clade[1]      0.38      0.27      0.38     -0.03      0.82    710.31      1.00
alpha_clade[2]      0.69      0.29      0.70      0.23      1.13    959.69      1.01
alpha_clade[3]     -0.54      0.31     -0.53     -1.06     -0.07    931.35      1.00
alpha_house[0]     -0.04      0.28     -0.04     -0.47      0.42    936.97      1.00
alpha_house[1]      0.20      0.30      0.20     -0.29      0.68    861.94      1.00
alpha_house[2]      0.11      0.28      0.11     -0.31      0.55    949.16      1.00
alpha_house[3]     -0.12      0.27     -0.11     -0.57      0.32   1017.12      1.00
         sigma      0.74      0.11      0.73      0.56      0.90    749.52      1.00

</pre></div></div>
</div>
</section>
</section>
<section id="Easy">
<h2>Easy<a class="headerlink" href="#Easy" title="Link to this heading">¶</a></h2>
<section id="5E1">
<h3>5E1<a class="headerlink" href="#5E1" title="Link to this heading">¶</a></h3>
<p>Models 2 and 4.</p>
</section>
<section id="5E2">
<h3>5E2<a class="headerlink" href="#5E2" title="Link to this heading">¶</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{split}
A_i &amp; \sim N(\mu_i, \sigma) \\
\mu_i &amp; = a + b_l \cdot L_o + b_{p} \cdot P_i
\end{split}\end{split}\]</div>
</section>
<section id="5E3">
<h3>5E3<a class="headerlink" href="#5E3" title="Link to this heading">¶</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{split}
T_i &amp; \sim N(\mu_i, \sigma) \\
\mu_i &amp; = a + b_F \cdot F_i + b_S \cdot S_i
\end{split}\end{split}\]</div>
<p><span class="math notranslate nohighlight">\(b_F\)</span> and <span class="math notranslate nohighlight">\(b_S\)</span> should both be positive.</p>
</section>
<section id="5E4">
<h3>5E4<a class="headerlink" href="#5E4" title="Link to this heading">¶</a></h3>
<p>Models 1, 3, 4 and 5.</p>
</section>
</section>
<section id="Medium">
<h2>Medium<a class="headerlink" href="#Medium" title="Link to this heading">¶</a></h2>
<section id="5M1">
<h3>5M1<a class="headerlink" href="#5M1" title="Link to this heading">¶</a></h3>
<p>Predictors: temperature during the summer and A/C usage. Target: number of sun burns</p>
</section>
<section id="5M2">
<h3>5M2<a class="headerlink" href="#5M2" title="Link to this heading">¶</a></h3>
<p>Predictors: temperature during the summer and A/C usage. Target: number of heat strokes</p>
</section>
<section id="5M3">
<h3>5M3<a class="headerlink" href="#5M3" title="Link to this heading">¶</a></h3>
<p>High divorce rate might lead to multiple marriage and hence high marriage rate.</p>
</section>
<section id="5M4">
<h3>5M4<a class="headerlink" href="#5M4" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>clade</th>
      <th>species</th>
      <th>kcal.per.g</th>
      <th>perc.fat</th>
      <th>perc.protein</th>
      <th>perc.lactose</th>
      <th>mass</th>
      <th>neocortex.perc</th>
      <th>clade_id</th>
      <th>K</th>
      <th>house</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Strepsirrhine</td>
      <td>Eulemur fulvus</td>
      <td>0.49</td>
      <td>16.60</td>
      <td>15.42</td>
      <td>67.98</td>
      <td>1.95</td>
      <td>55.16</td>
      <td>3</td>
      <td>-0.940041</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Strepsirrhine</td>
      <td>E macaco</td>
      <td>0.51</td>
      <td>19.27</td>
      <td>16.91</td>
      <td>63.82</td>
      <td>2.09</td>
      <td>NaN</td>
      <td>3</td>
      <td>-0.816126</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Strepsirrhine</td>
      <td>E mongoz</td>
      <td>0.46</td>
      <td>14.11</td>
      <td>16.85</td>
      <td>69.04</td>
      <td>2.51</td>
      <td>NaN</td>
      <td>3</td>
      <td>-1.125913</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Strepsirrhine</td>
      <td>E rubriventer</td>
      <td>0.48</td>
      <td>14.91</td>
      <td>13.18</td>
      <td>71.91</td>
      <td>1.62</td>
      <td>NaN</td>
      <td>3</td>
      <td>-1.001998</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Strepsirrhine</td>
      <td>Lemur catta</td>
      <td>0.60</td>
      <td>27.28</td>
      <td>19.50</td>
      <td>53.22</td>
      <td>2.19</td>
      <td>NaN</td>
      <td>3</td>
      <td>-0.258511</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/WaffleDivorce.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;_LDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.75</span><span class="p">,</span>
    <span class="mf">4.53</span><span class="p">,</span>
    <span class="mf">6.18</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mf">2.01</span><span class="p">,</span>
    <span class="mf">2.82</span><span class="p">,</span>
    <span class="mf">0.43</span><span class="p">,</span>
    <span class="mf">0.55</span><span class="p">,</span>
    <span class="mf">0.38</span><span class="p">,</span>
    <span class="mf">0.75</span><span class="p">,</span>
    <span class="mf">0.82</span><span class="p">,</span>
    <span class="mf">5.18</span><span class="p">,</span>
    <span class="mf">26.35</span><span class="p">,</span>
    <span class="mf">0.44</span><span class="p">,</span>
    <span class="mf">0.66</span><span class="p">,</span>
    <span class="mf">0.87</span><span class="p">,</span>
    <span class="mf">1.25</span><span class="p">,</span>
    <span class="mf">0.77</span><span class="p">,</span>
    <span class="mf">0.64</span><span class="p">,</span>
    <span class="mf">0.81</span><span class="p">,</span>
    <span class="mf">0.72</span><span class="p">,</span>
    <span class="mf">0.39</span><span class="p">,</span>
    <span class="mf">0.44</span><span class="p">,</span>
    <span class="mf">0.58</span><span class="p">,</span>
    <span class="mf">0.72</span><span class="p">,</span>
    <span class="mf">1.14</span><span class="p">,</span>
    <span class="mf">4.78</span><span class="p">,</span>
    <span class="mf">1.29</span><span class="p">,</span>
    <span class="mf">0.61</span><span class="p">,</span>
    <span class="mf">0.37</span><span class="p">,</span>
    <span class="mf">3.34</span><span class="p">,</span>
    <span class="mf">0.41</span><span class="p">,</span>
    <span class="mf">0.82</span><span class="p">,</span>
    <span class="mf">1.48</span><span class="p">,</span>
    <span class="mf">0.52</span><span class="p">,</span>
    <span class="mf">1.2</span><span class="p">,</span>
    <span class="mf">3.85</span><span class="p">,</span>
    <span class="mf">0.4</span><span class="p">,</span>
    <span class="mf">0.37</span><span class="p">,</span>
    <span class="mf">0.83</span><span class="p">,</span>
    <span class="mf">1.27</span><span class="p">,</span>
    <span class="mf">0.75</span><span class="p">,</span>
    <span class="mf">1.21</span><span class="p">,</span>
    <span class="mf">67.97</span><span class="p">,</span>
    <span class="mf">0.74</span><span class="p">,</span>
    <span class="mf">1.13</span><span class="p">,</span>
    <span class="mf">3.99</span><span class="p">,</span>
    <span class="mf">0.92</span><span class="p">,</span>
    <span class="mf">0.44</span><span class="p">,</span>
    <span class="mf">11.5</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MedianAgeMarriage&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Marriage&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Divorce&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;_LDS&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Location</th>
      <th>Loc</th>
      <th>Population</th>
      <th>MedianAgeMarriage</th>
      <th>Marriage</th>
      <th>Marriage SE</th>
      <th>Divorce</th>
      <th>Divorce SE</th>
      <th>WaffleHouses</th>
      <th>South</th>
      <th>Slaves1860</th>
      <th>Population1860</th>
      <th>PropSlaves1860</th>
      <th>_LDS</th>
      <th>A</th>
      <th>M</th>
      <th>D</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alabama</td>
      <td>AL</td>
      <td>4.78</td>
      <td>25.3</td>
      <td>20.2</td>
      <td>1.27</td>
      <td>12.7</td>
      <td>0.79</td>
      <td>128</td>
      <td>1</td>
      <td>435080</td>
      <td>964201</td>
      <td>0.45</td>
      <td>0.75</td>
      <td>-0.606290</td>
      <td>0.022644</td>
      <td>1.654205</td>
      <td>-0.263815</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Alaska</td>
      <td>AK</td>
      <td>0.71</td>
      <td>25.2</td>
      <td>26.0</td>
      <td>2.93</td>
      <td>12.5</td>
      <td>2.05</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.00</td>
      <td>4.53</td>
      <td>-0.686699</td>
      <td>1.549802</td>
      <td>1.544364</td>
      <td>0.108644</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arizona</td>
      <td>AZ</td>
      <td>6.33</td>
      <td>25.8</td>
      <td>20.3</td>
      <td>0.98</td>
      <td>10.8</td>
      <td>0.74</td>
      <td>18</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.00</td>
      <td>6.18</td>
      <td>-0.204241</td>
      <td>0.048974</td>
      <td>0.610716</td>
      <td>0.271225</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Arkansas</td>
      <td>AR</td>
      <td>2.92</td>
      <td>24.3</td>
      <td>26.4</td>
      <td>1.70</td>
      <td>13.5</td>
      <td>1.22</td>
      <td>41</td>
      <td>1</td>
      <td>111115</td>
      <td>435450</td>
      <td>0.26</td>
      <td>1.00</td>
      <td>-1.410387</td>
      <td>1.655123</td>
      <td>2.093569</td>
      <td>-0.239182</td>
    </tr>
    <tr>
      <th>4</th>
      <td>California</td>
      <td>CA</td>
      <td>37.25</td>
      <td>26.8</td>
      <td>19.1</td>
      <td>0.39</td>
      <td>8.0</td>
      <td>0.24</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>379994</td>
      <td>0.00</td>
      <td>2.01</td>
      <td>0.599857</td>
      <td>-0.266989</td>
      <td>-0.927058</td>
      <td>-0.139662</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span>
    <span class="n">marriage</span><span class="p">,</span>
    <span class="n">church</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_church_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_age_prior</span><span class="p">))</span>
    <span class="n">beta_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_marriage&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_marriage_prior</span><span class="p">))</span>
    <span class="n">beta_church</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_church&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_church_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span> <span class="o">+</span> <span class="n">beta_marriage</span> <span class="o">*</span> <span class="n">marriage</span> <span class="o">+</span> <span class="n">beta_church</span> <span class="o">*</span> <span class="n">church</span>
    <span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;divorce&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">divorce</span>


<span class="n">guide</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">svi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">church</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████| 2500/2500 [00:01&lt;00:00, 1361.25it/s, init loss: 138.0810, avg. loss [2376-2500]: 58.2086]
</pre></div></div>
</div>
posterior_samples = guide.sample_posterior(jrng, svi.params, sample_shape=(1_000,))
posterior_samples.pop("mu")
numpyro.diagnostics.print_summary(posterior_samples, prob=0.89, group_by_chain=False)</section>
<section id="5M5">
<h3>5M5<a class="headerlink" href="#5M5" title="Link to this heading">¶</a></h3>
<p>regress price of gasoline against avg number of steps per day per person and average number of resturant meals per day per person</p>
</section>
</section>
<section id="Hard">
<h2>Hard<a class="headerlink" href="#Hard" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/foxes.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;avgfood&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;groupsize&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>avgfood</th>
      <th>groupsize</th>
      <th>area</th>
      <th>weight</th>
      <th>F</th>
      <th>S</th>
      <th>A</th>
      <th>W</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0.37</td>
      <td>2</td>
      <td>1.09</td>
      <td>5.02</td>
      <td>-1.924829</td>
      <td>-1.524089</td>
      <td>-2.239596</td>
      <td>0.414135</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0.37</td>
      <td>2</td>
      <td>1.09</td>
      <td>2.84</td>
      <td>-1.924829</td>
      <td>-1.524089</td>
      <td>-2.239596</td>
      <td>-1.427046</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>0.53</td>
      <td>2</td>
      <td>2.05</td>
      <td>5.33</td>
      <td>-1.118035</td>
      <td>-1.524089</td>
      <td>-1.205508</td>
      <td>0.675954</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>0.53</td>
      <td>2</td>
      <td>2.05</td>
      <td>6.07</td>
      <td>-1.118035</td>
      <td>-1.524089</td>
      <td>-1.205508</td>
      <td>1.300942</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>0.49</td>
      <td>2</td>
      <td>2.12</td>
      <td>5.85</td>
      <td>-1.319734</td>
      <td>-1.524089</td>
      <td>-1.130106</td>
      <td>1.115135</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<section id="5H1">
<h3>5H1<a class="headerlink" href="#5H1" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_h1a</span><span class="p">(</span>
    <span class="n">area</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_area_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_area</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_area&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_area_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_area</span> <span class="o">*</span> <span class="n">area</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weight</span>


<span class="n">guide_h1a</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_h1a</span><span class="p">)</span>
<span class="n">svi_h1a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_h1a</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_h1a</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███| 2500/2500 [00:01&lt;00:00, 1726.98it/s, init loss: 368.0105, avg. loss [2376-2500]: 164.7589]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_h1a</span> <span class="o">=</span> <span class="n">guide_h1a</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_h1a</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_h1a</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_h1a</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;mu&quot;</span><span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_h1a</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                 mean       std    median      5.5%     94.5%     n_eff     r_hat
      alpha     -0.04      0.08     -0.03     -0.16      0.09    914.61      1.00
  beta_area      0.02      0.09      0.01     -0.10      0.16    994.84      1.00
      sigma      0.99      0.06      0.99      0.89      1.09   1038.25      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">area</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">predictive_h1a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model_h1a</span><span class="p">,</span> <span class="n">posterior_samples_h1a</span><span class="p">)</span>
<span class="n">predictive_samples_h1a</span> <span class="o">=</span> <span class="n">predictive_h1a</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">)</span>

<span class="n">mu_mean_h1a</span> <span class="o">=</span> <span class="n">predictive_samples_h1a</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mu_hpdi_h1a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">predictive_samples_h1a</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Area (std)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Body weight (std)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">mu_mean_h1a</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">mu_hpdi_h1a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mu_hpdi_h1a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x1418299a0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_130_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_130_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_h1b</span><span class="p">(</span>
    <span class="n">group_size</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_group_size_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_group_size</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;beta_group_size&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_group_size_prior</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_group_size</span> <span class="o">*</span> <span class="n">group_size</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weight</span>


<span class="n">guide_h1b</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_h1b</span><span class="p">)</span>
<span class="n">svi_h1b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_h1b</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_h1b</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">group_size</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███| 2500/2500 [00:01&lt;00:00, 1706.47it/s, init loss: 402.9226, avg. loss [2376-2500]: 163.2761]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_h1b</span> <span class="o">=</span> <span class="n">guide_h1b</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_h1b</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_h1b</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_h1b</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;mu&quot;</span><span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_h1b</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                       mean       std    median      5.5%     94.5%     n_eff     r_hat
            alpha     -0.01      0.08     -0.01     -0.14      0.12    914.61      1.00
  beta_group_size     -0.16      0.09     -0.16     -0.28     -0.01    994.83      1.00
            sigma      0.99      0.06      0.98      0.89      1.09   1037.35      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">group_size</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">predictive_h1b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model_h1b</span><span class="p">,</span> <span class="n">posterior_samples_h1b</span><span class="p">)</span>
<span class="n">predictive_samples_h1b</span> <span class="o">=</span> <span class="n">predictive_h1b</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">group_size</span><span class="o">=</span><span class="n">group_size</span><span class="p">)</span>

<span class="n">mu_mean_h1b</span> <span class="o">=</span> <span class="n">predictive_samples_h1b</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mu_hpdi_h1b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">predictive_samples_h1b</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Group Size (std)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Body weight (std)&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">group_size</span><span class="p">,</span> <span class="n">mu_mean_h1b</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">group_size</span><span class="p">,</span> <span class="n">mu_hpdi_h1b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mu_hpdi_h1b</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x141d4b050&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_133_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_133_1.png" />
</div>
</div>
<p>Area not important, group size slightly more, but still not very strong.</p>
</section>
<section id="5H2">
<h3>5H2<a class="headerlink" href="#5H2" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_h2</span><span class="p">(</span>
    <span class="n">area</span><span class="p">,</span>
    <span class="n">group_size</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_area_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_group_size_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_area</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_area&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_area_prior</span><span class="p">))</span>
    <span class="n">beta_group_size</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;beta_group_size&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_group_size_prior</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_area</span> <span class="o">*</span> <span class="n">area</span> <span class="o">+</span> <span class="n">beta_group_size</span> <span class="o">*</span> <span class="n">group_size</span>
    <span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weight</span>


<span class="n">guide_h2</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_h2</span><span class="p">)</span>
<span class="n">svi_h2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_h2</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_h2</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">group_size</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>

<span class="n">posterior_samples_h2</span> <span class="o">=</span> <span class="n">guide_h2</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_h2</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_h2</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_h2</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;mu&quot;</span><span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_h2</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███| 2500/2500 [00:01&lt;00:00, 1796.75it/s, init loss: 398.5841, avg. loss [2376-2500]: 159.9980]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                       mean       std    median      5.5%     94.5%     n_eff     r_hat
            alpha     -0.00      0.08     -0.01     -0.13      0.12   1008.94      1.00
        beta_area      0.36      0.14      0.36      0.14      0.60   1010.43      1.00
  beta_group_size     -0.51      0.14     -0.51     -0.72     -0.29    976.47      1.00
            sigma      0.95      0.07      0.95      0.85      1.05    866.78      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">area</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">group_size</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">predictive_h2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model_h2</span><span class="p">,</span> <span class="n">posterior_samples_h2</span><span class="p">)</span>
<span class="n">area_counterfactual_h2</span> <span class="o">=</span> <span class="n">predictive_h2</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">,</span> <span class="n">group_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">group_size_counterfactual_h2</span> <span class="o">=</span> <span class="n">predictive_h2</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">group_size</span><span class="o">=</span><span class="n">group_size</span><span class="p">)</span>

<span class="n">area_counterfactual_mu_mean_h2</span> <span class="o">=</span> <span class="n">area_counterfactual_h2</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">area_counterfactual_mu_hpdi_h2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
    <span class="n">area_counterfactual_h2</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
<span class="p">)</span>
<span class="n">group_size_counterfactual_mu_mean_h2</span> <span class="o">=</span> <span class="n">group_size_counterfactual_h2</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">group_size_counterfactual_mu_hpdi_h2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
    <span class="n">group_size_counterfactual_h2</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
<span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1_h2</span><span class="p">,</span> <span class="n">ax2_h2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1_h2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Area Counterfactual&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Area (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Body Weight (std)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2_h2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group Size Counterfactual&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Group Size (std)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Body Weight (std)&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax1_h2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">area_counterfactual_mu_mean_h2</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">ax1_h2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">area</span><span class="p">,</span>
    <span class="n">area_counterfactual_mu_hpdi_h2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">area_counterfactual_mu_hpdi_h2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax2_h2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">group_size</span><span class="p">,</span> <span class="n">group_size_counterfactual_mu_mean_h2</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">ax2_h2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">group_size</span><span class="p">,</span>
    <span class="n">group_size_counterfactual_mu_hpdi_h2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">group_size_counterfactual_mu_hpdi_h2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x141f11ee0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_137_1.png" src="../_images/notebooks_05_the_many_variables_and_the_spurious_waffles_137_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>S</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A</th>
      <td>1.000000</td>
      <td>0.827594</td>
    </tr>
    <tr>
      <th>S</th>
      <td>0.827594</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
Both relationships are now strong.
This is because A and G and strongly positively correlated, but have opposite impacts on W. So when looking at A by itself, as we increase A, we tend to increase G, masking the impact of either on W (and vice versa when looking at G only).</section>
<section id="5H3">
<h3>5H3<a class="headerlink" href="#5H3" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_h3</span><span class="p">(</span>
    <span class="n">area</span><span class="p">,</span>
    <span class="n">food</span><span class="p">,</span>
    <span class="n">group_size</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_area_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_food_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_group_size_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_area</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_area&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_area_prior</span><span class="p">))</span>
    <span class="n">beta_food</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_food&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_food_prior</span><span class="p">))</span>
    <span class="n">beta_group_size</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;beta_group_size&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_group_size_prior</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">area</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
            <span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_food</span> <span class="o">*</span> <span class="n">food</span> <span class="o">+</span> <span class="n">beta_group_size</span> <span class="o">*</span> <span class="n">group_size</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
            <span class="s2">&quot;mu&quot;</span><span class="p">,</span>
            <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_area</span> <span class="o">*</span> <span class="n">area</span> <span class="o">+</span> <span class="n">beta_food</span> <span class="o">*</span> <span class="n">food</span> <span class="o">+</span> <span class="n">beta_group_size</span> <span class="o">*</span> <span class="n">group_size</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weight</span>


<span class="n">guide_h3</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_h3</span><span class="p">)</span>
<span class="n">svi_h3a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_h3</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_h3</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">food</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">group_size</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>

<span class="n">posterior_samples_h3a</span> <span class="o">=</span> <span class="n">guide_h3</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_h3a</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_h3a</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_h3a</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_area&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_h3a</span><span class="p">,</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">svi_h3b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_h3</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_h3</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">food</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">group_size</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>

<span class="n">posterior_samples_h3b</span> <span class="o">=</span> <span class="n">guide_h3</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_h3b</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_posterior_samples_h3b</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">posterior_samples_h3b</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;mu&quot;</span><span class="p">}</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">_posterior_samples_h3b</span><span class="p">,</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███| 2500/2500 [00:01&lt;00:00, 1448.94it/s, init loss: 280.2519, avg. loss [2376-2500]: 160.5481]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                       mean       std    median      5.5%     94.5%     n_eff     r_hat
            alpha      0.00      0.08      0.00     -0.12      0.14    909.54      1.00
        beta_food      0.52      0.19      0.51      0.24      0.83    906.33      1.00
  beta_group_size     -0.53      0.19     -0.53     -0.81     -0.22    936.91      1.00
            sigma      0.99      0.07      0.99      0.88      1.09    980.44      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███| 2500/2500 [00:02&lt;00:00, 1105.61it/s, init loss: 291.1429, avg. loss [2376-2500]: 159.4464]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                       mean       std    median      5.5%     94.5%     n_eff     r_hat
            alpha     -0.00      0.08     -0.00     -0.13      0.13    909.54      1.00
        beta_area      0.29      0.49      0.30     -0.55      1.02    933.81      1.00
        beta_food      0.31      0.19      0.31      0.04      0.62    906.22      1.00
  beta_group_size     -0.62      0.18     -0.62     -0.90     -0.33    938.13      1.00
            sigma      0.96      0.06      0.96      0.84      1.05    946.11      1.00

</pre></div></div>
</div>
<p>Food is better for two reasons: - beta coefficient is stronger - causally it makes more sense that food causes bigger weight and area is just a proxy for food</p>
<p>When both are included, their effect is reduced because they are correlated.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

          <div class="sidebar-resize-handle"></div>

<h3><a href="../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="02_small_and_large_worlds.html">Chapter 2: Small Worlds And Large Worlds</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_sampling_the_imaginary.html">Chapter 3: Sampling the Imaginary</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_geocentric_models.html">Chapter 4: Geocentric Models</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Chapter 5: The Many Variables And The Spurious Waffles</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_the_haunted_dag_and_the_causal_terror.html">Chapter 6: The Haunted DAG &amp; The Causal Terror</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_ulysse_s_copmpass.html">Chapter 7: Ulysse’s Compass</a></li>
</ul>

<div><hr class="docutils"></div>
<ul>
  <li class="toctree-l1"><a class="reference internal" href="../genindex.html" accesskey="I">General Index</a></li>
</ul>
<div id="ethical-ad-placement"></div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <nav class="relbar">
      <a class="previous" href="04_geocentric_models.html" aria-label="Previous topic" >
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>
        </div>
        <div class="title">
          <span class="text">
            <span class="direction">previous</span>
            Chapter 4: Geocentric Models
          </span>
        </div>
      </a>
      <a class="next" href="06_the_haunted_dag_and_the_causal_terror.html" aria-label="Next topic" >
        <div class="title">
          <span class="text">
            <span class="direction">next</span>
            Chapter 6: The Haunted DAG &amp; The Causal Terror
          </span>
        </div>
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"/></svg>
        </div>
      </a>
    </nav>

    <footer role="contentinfo">
      &#169; Copyright 2022, Ludovic Tiako.
      Created using <a class="reference external" href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
      <a class="reference external" href="https://insipid-sphinx-theme.readthedocs.io/">Insipid Theme</a>.
    </footer>
  </body>
</html>