<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Chapter 13: Models With Memory &#8212; Statistical Rethinking</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/insipid.css?v=b2d00be7" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

    <script src="../_static/documentation_options.js?v=63867087"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script defer src="../_static/insipid.js"></script>
    <script defer src="../_static/insipid-sidebar.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Chapter 12: Monsters and Mixtures" href="12_monsters_and_mixtures.html" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
  </head><body>
    <script type="text/javascript">
        document.body.classList.add('js');
    </script>
    <input type="checkbox" id="sidebar-checkbox" style="display: none;">
    <label id="overlay" for="sidebar-checkbox"></label>
    <div class="sidebar-resize-handle"></div>
    <script type="text/javascript">
        try {
            let sidebar = localStorage.getItem('sphinx-sidebar');
            const sidebar_width = localStorage.getItem('sphinx-sidebar-width');
            if (sidebar_width) {
                document.documentElement.style.setProperty('--sidebar-width', sidebar_width);
            }
            // show sidebar on wide screen
            if (!sidebar && window.matchMedia('(min-width: 100rem)').matches) {
                sidebar = 'visible';
                // NB: We don't store the value in localStorage!
            }
            if (sidebar === 'visible') {
                document.getElementById('sidebar-checkbox').checked = true;
            }
        } catch(e) {
            console.info(e);
        }
    </script>
    <header id="topbar-placeholder">
      <div id="topbar">
        <div id="titlebar">
          <div class="buttons">
            <label for="sidebar-checkbox" id="sidebar-button" role="button" tabindex="0" aria-controls="sphinxsidebar" accesskey="M">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>
            </label>
            <button id="search-button" type="button" title="Search" aria-label="Search" aria-expanded="false" aria-controls="search-form" accesskey="S">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
            </button>
          </div>
          <div class="title">
            <a class="parent" href="../index.html" accesskey="U">Statistical Rethinking</a>
            <a class="top" href="#">Chapter 13: Models With Memory</a>
          </div>
          <div class="buttons">
            <button id="fullscreen-button" type="button" aria-hidden="true">
              <span class="enable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M212.686 315.314L120 408l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C10.697 480 0 469.255 0 456V344c0-21.382 25.803-32.09 40.922-16.971L72 360l92.686-92.686c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.249 6.248 6.249 16.378 0 22.627zm22.628-118.628L328 104l-32.922-31.029C279.958 57.851 290.666 32 312.048 32h112C437.303 32 448 42.745 448 56v112c0 21.382-25.803 32.09-40.922 16.971L376 152l-92.686 92.686c-6.248 6.248-16.379 6.248-22.627 0l-25.373-25.373c-6.249-6.248-6.249-16.378 0-22.627z"/></svg>
              </span>
              <span class="disable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M4.686 427.314L104 328l-32.922-31.029C55.958 281.851 66.666 256 88.048 256h112C213.303 256 224 266.745 224 280v112c0 21.382-25.803 32.09-40.922 16.971L152 376l-99.314 99.314c-6.248 6.248-16.379 6.248-22.627 0L4.686 449.941c-6.248-6.248-6.248-16.379 0-22.627zM443.314 84.686L344 184l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C234.697 256 224 245.255 224 232V120c0-21.382 25.803-32.09 40.922-16.971L296 136l99.314-99.314c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.248 6.248 6.248 16.379 0 22.627z"/></svg>
              </span>
            </button>
          </div>
        </div>
        <div id="searchbox" role="search">
          <form id="search-form" class="search" style="display: none" action="../search.html" method="get">
            <input type="search" name="q" placeholder="Search ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <button>Go</button>
          </form>
        </div>
      </div>
    </header>
    <nav>
      <a href="12_monsters_and_mixtures.html" class="nav-icon previous" title="previous:&#13;Chapter 12: Monsters and Mixtures" aria-label="Previous topic" accesskey="P" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6 0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>
      </a>
    </nav>

    <nav class="relbar">
      <a class="previous" href="12_monsters_and_mixtures.html" aria-label="Previous topic" >
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>
        </div>
        <div class="title">
          <span class="text">
            <span class="direction">previous</span>
            Chapter 12: Monsters and Mixtures
          </span>
        </div>
      </a>
    </nav>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<section id="Chapter-13:-Models-With-Memory">
<h1>Chapter 13: Models With Memory<a class="headerlink" href="#Chapter-13:-Models-With-Memory" title="Link to this heading">Â¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> jupyter_black
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span><span class="p">,</span> <span class="n">Predictive</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">numpyro</span><span class="o">.</span><span class="n">enable_x64</span><span class="p">()</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">set_host_device_count</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">84735</span>
<span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">jrngs</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:jax._src.xla_bridge:An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</pre></div></div>
</div>
<section id="Code">
<h2>Code<a class="headerlink" href="#Code" title="Link to this heading">Â¶</a></h2>
<section id="Code-13.1">
<h3>Code 13.1<a class="headerlink" href="#Code-13.1" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/reedfrogs.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>density</th>
      <th>pred</th>
      <th>size</th>
      <th>surv</th>
      <th>propsurv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>9</td>
      <td>0.900000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>10</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>7</td>
      <td>0.700000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>10</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>10</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10</td>
      <td>pred</td>
      <td>big</td>
      <td>4</td>
      <td>0.400000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10</td>
      <td>pred</td>
      <td>big</td>
      <td>9</td>
      <td>0.900000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10</td>
      <td>pred</td>
      <td>big</td>
      <td>7</td>
      <td>0.700000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>10</td>
      <td>pred</td>
      <td>big</td>
      <td>6</td>
      <td>0.600000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10</td>
      <td>pred</td>
      <td>small</td>
      <td>7</td>
      <td>0.700000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>10</td>
      <td>pred</td>
      <td>small</td>
      <td>5</td>
      <td>0.500000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>10</td>
      <td>pred</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
    </tr>
    <tr>
      <th>15</th>
      <td>10</td>
      <td>pred</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>25</td>
      <td>no</td>
      <td>big</td>
      <td>24</td>
      <td>0.960000</td>
    </tr>
    <tr>
      <th>17</th>
      <td>25</td>
      <td>no</td>
      <td>big</td>
      <td>23</td>
      <td>0.920000</td>
    </tr>
    <tr>
      <th>18</th>
      <td>25</td>
      <td>no</td>
      <td>big</td>
      <td>22</td>
      <td>0.880000</td>
    </tr>
    <tr>
      <th>19</th>
      <td>25</td>
      <td>no</td>
      <td>big</td>
      <td>25</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>20</th>
      <td>25</td>
      <td>no</td>
      <td>small</td>
      <td>23</td>
      <td>0.920000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>25</td>
      <td>no</td>
      <td>small</td>
      <td>23</td>
      <td>0.920000</td>
    </tr>
    <tr>
      <th>22</th>
      <td>25</td>
      <td>no</td>
      <td>small</td>
      <td>23</td>
      <td>0.920000</td>
    </tr>
    <tr>
      <th>23</th>
      <td>25</td>
      <td>no</td>
      <td>small</td>
      <td>21</td>
      <td>0.840000</td>
    </tr>
    <tr>
      <th>24</th>
      <td>25</td>
      <td>pred</td>
      <td>big</td>
      <td>6</td>
      <td>0.240000</td>
    </tr>
    <tr>
      <th>25</th>
      <td>25</td>
      <td>pred</td>
      <td>big</td>
      <td>13</td>
      <td>0.520000</td>
    </tr>
    <tr>
      <th>26</th>
      <td>25</td>
      <td>pred</td>
      <td>big</td>
      <td>4</td>
      <td>0.160000</td>
    </tr>
    <tr>
      <th>27</th>
      <td>25</td>
      <td>pred</td>
      <td>big</td>
      <td>9</td>
      <td>0.360000</td>
    </tr>
    <tr>
      <th>28</th>
      <td>25</td>
      <td>pred</td>
      <td>small</td>
      <td>13</td>
      <td>0.520000</td>
    </tr>
    <tr>
      <th>29</th>
      <td>25</td>
      <td>pred</td>
      <td>small</td>
      <td>20</td>
      <td>0.800000</td>
    </tr>
    <tr>
      <th>30</th>
      <td>25</td>
      <td>pred</td>
      <td>small</td>
      <td>8</td>
      <td>0.320000</td>
    </tr>
    <tr>
      <th>31</th>
      <td>25</td>
      <td>pred</td>
      <td>small</td>
      <td>10</td>
      <td>0.400000</td>
    </tr>
    <tr>
      <th>32</th>
      <td>35</td>
      <td>no</td>
      <td>big</td>
      <td>34</td>
      <td>0.971429</td>
    </tr>
    <tr>
      <th>33</th>
      <td>35</td>
      <td>no</td>
      <td>big</td>
      <td>33</td>
      <td>0.942857</td>
    </tr>
    <tr>
      <th>34</th>
      <td>35</td>
      <td>no</td>
      <td>big</td>
      <td>33</td>
      <td>0.942857</td>
    </tr>
    <tr>
      <th>35</th>
      <td>35</td>
      <td>no</td>
      <td>big</td>
      <td>31</td>
      <td>0.885714</td>
    </tr>
    <tr>
      <th>36</th>
      <td>35</td>
      <td>no</td>
      <td>small</td>
      <td>31</td>
      <td>0.885714</td>
    </tr>
    <tr>
      <th>37</th>
      <td>35</td>
      <td>no</td>
      <td>small</td>
      <td>35</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>38</th>
      <td>35</td>
      <td>no</td>
      <td>small</td>
      <td>33</td>
      <td>0.942857</td>
    </tr>
    <tr>
      <th>39</th>
      <td>35</td>
      <td>no</td>
      <td>small</td>
      <td>32</td>
      <td>0.914286</td>
    </tr>
    <tr>
      <th>40</th>
      <td>35</td>
      <td>pred</td>
      <td>big</td>
      <td>4</td>
      <td>0.114286</td>
    </tr>
    <tr>
      <th>41</th>
      <td>35</td>
      <td>pred</td>
      <td>big</td>
      <td>12</td>
      <td>0.342857</td>
    </tr>
    <tr>
      <th>42</th>
      <td>35</td>
      <td>pred</td>
      <td>big</td>
      <td>13</td>
      <td>0.371429</td>
    </tr>
    <tr>
      <th>43</th>
      <td>35</td>
      <td>pred</td>
      <td>big</td>
      <td>14</td>
      <td>0.400000</td>
    </tr>
    <tr>
      <th>44</th>
      <td>35</td>
      <td>pred</td>
      <td>small</td>
      <td>22</td>
      <td>0.628571</td>
    </tr>
    <tr>
      <th>45</th>
      <td>35</td>
      <td>pred</td>
      <td>small</td>
      <td>12</td>
      <td>0.342857</td>
    </tr>
    <tr>
      <th>46</th>
      <td>35</td>
      <td>pred</td>
      <td>small</td>
      <td>31</td>
      <td>0.885714</td>
    </tr>
    <tr>
      <th>47</th>
      <td>35</td>
      <td>pred</td>
      <td>small</td>
      <td>17</td>
      <td>0.485714</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.2">
<h3>Code 13.2<a class="headerlink" href="#Code-13.2" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make the tank cluster variable</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;tank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">model_13_1</span><span class="p">(</span><span class="n">tank</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;tank&quot;</span><span class="p">,</span> <span class="mi">48</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>

    <span class="n">logit_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">tank</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">S</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;tank&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tank&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;surv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;density&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13_1</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_1</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_1</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">mcmc_13_1</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">idata_13_1</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "34e3503871374e7fbea1d2918f61954a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "462528802e9e44549710d8d500114b4f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4cbff410b272489684fe11da6e19f710", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1b920dd8fc10460ebd75f6a71ad71a98", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
      a[0]      1.73      0.78      1.71      0.53      3.05   2301.75      1.00
      a[1]      2.43      0.94      2.35      0.95      3.97   3068.75      1.00
      a[2]      0.75      0.62      0.72     -0.27      1.74   3325.06      1.00
      a[3]      2.42      0.93      2.38      0.79      3.79   2351.98      1.00
      a[4]      1.73      0.76      1.69      0.49      2.98   2889.72      1.00
      a[5]      1.69      0.73      1.65      0.47      2.86   2985.94      1.00
      a[6]      2.46      0.92      2.38      0.94      3.93   2119.57      1.00
      a[7]      1.71      0.79      1.65      0.44      2.97   2510.93      1.00
      a[8]     -0.38      0.59     -0.37     -1.30      0.61   2579.20      1.00
      a[9]      1.73      0.77      1.68      0.45      2.93   2303.80      1.00
     a[10]      0.76      0.62      0.74     -0.25      1.77   2513.90      1.00
     a[11]      0.37      0.61      0.37     -0.69      1.31   2600.64      1.00
     a[12]      0.77      0.65      0.76     -0.34      1.82   2373.80      1.00
     a[13]      0.00      0.59     -0.01     -0.89      0.98   3315.69      1.00
     a[14]      1.71      0.74      1.69      0.53      2.92   3384.39      1.00
     a[15]      1.73      0.78      1.71      0.46      2.99   2234.05      1.00
     a[16]      2.57      0.69      2.55      1.47      3.67   2662.12      1.00
     a[17]      2.17      0.63      2.13      1.18      3.27   2738.53      1.00
     a[18]      1.82      0.53      1.79      0.91      2.62   2573.57      1.00
     a[19]      3.10      0.79      3.02      1.86      4.35   2561.58      1.00
     a[20]      2.12      0.58      2.09      1.15      3.03   3167.49      1.00
     a[21]      2.15      0.61      2.11      1.14      3.06   2343.20      1.00
     a[22]      2.14      0.65      2.11      1.14      3.16   1964.85      1.00
     a[23]      1.54      0.49      1.51      0.75      2.33   2663.98      1.00
     a[24]     -1.09      0.45     -1.07     -1.81     -0.35   2851.87      1.00
     a[25]      0.09      0.40      0.10     -0.52      0.77   3080.72      1.00
     a[26]     -1.57      0.49     -1.56     -2.32     -0.76   2473.61      1.00
     a[27]     -0.55      0.41     -0.54     -1.16      0.18   2032.97      1.00
     a[28]      0.07      0.41      0.07     -0.62      0.70   2390.47      1.00
     a[29]      1.31      0.47      1.28      0.57      2.08   2235.89      1.00
     a[30]     -0.73      0.43     -0.72     -1.46     -0.02   2369.80      1.00
     a[31]     -0.37      0.39     -0.37     -0.99      0.26   3215.83      1.00
     a[32]      2.84      0.66      2.79      1.88      4.00   2722.34      1.00
     a[33]      2.47      0.57      2.44      1.59      3.41   2605.24      1.00
     a[34]      2.46      0.57      2.42      1.55      3.37   2384.59      1.00
     a[35]      1.92      0.48      1.91      1.17      2.74   2823.83      1.00
     a[36]      1.90      0.50      1.87      1.18      2.77   2564.70      1.00
     a[37]      3.36      0.79      3.29      2.03      4.60   2876.70      1.00
     a[38]      2.47      0.61      2.42      1.50      3.53   1998.23      1.00
     a[39]      2.16      0.51      2.13      1.37      3.03   3143.85      1.00
     a[40]     -1.92      0.48     -1.89     -2.68     -1.12   2432.72      1.00
     a[41]     -0.64      0.35     -0.63     -1.24     -0.06   3612.94      1.00
     a[42]     -0.51      0.34     -0.51     -1.05      0.02   2579.43      1.00
     a[43]     -0.39      0.34     -0.39     -0.95      0.19   2717.27      1.00
     a[44]      0.51      0.34      0.51     -0.03      1.06   2581.82      1.00
     a[45]     -0.63      0.34     -0.62     -1.17     -0.07   3285.91      1.00
     a[46]      1.91      0.48      1.89      1.11      2.66   2433.45      1.00
     a[47]     -0.05      0.34     -0.05     -0.59      0.51   2134.54      1.00

Number of divergences: 0
</pre></div></div>
</div>
</section>
<section id="Code-13.13">
<h3>Code 13.13<a class="headerlink" href="#Code-13.13" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_2</span><span class="p">(</span><span class="n">tank</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;tank&quot;</span><span class="p">,</span> <span class="mi">48</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>

    <span class="n">logit_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">tank</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">S</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;tank&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tank&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;surv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;density&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13_2</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_2</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">mcmc_13_2</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">idata_13_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cf8aa90d9cc246cab101bf4ccc057c06", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8c3834c72f474c17875e401e225198ed", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1fd7ed1997a94dcbaa5d8f2e316492f3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2b0daf4e0fc347f8b2ca68588039e349", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
      a[0]      2.11      0.87      2.05      0.76      3.52   2423.43      1.00
      a[1]      3.06      1.10      2.95      1.19      4.77   1844.34      1.00
      a[2]      0.96      0.68      0.94     -0.14      2.04   3005.50      1.00
      a[3]      3.05      1.11      2.95      1.20      4.71   1892.60      1.00
      a[4]      2.14      0.88      2.09      0.70      3.58   2091.67      1.00
      a[5]      2.14      0.87      2.09      0.81      3.63   2019.13      1.00
      a[6]      3.05      1.06      2.96      1.39      4.78   1971.50      1.00
      a[7]      2.14      0.87      2.08      0.79      3.56   2343.53      1.00
      a[8]     -0.19      0.61     -0.19     -1.20      0.78   3628.13      1.00
      a[9]      2.17      0.85      2.11      0.82      3.51   2031.51      1.00
     a[10]      1.02      0.72      1.00     -0.24      2.10   1612.72      1.00
     a[11]      0.58      0.64      0.56     -0.44      1.69   2237.84      1.00
     a[12]      1.02      0.68      1.00     -0.07      2.10   2205.71      1.00
     a[13]      0.18      0.61      0.18     -0.79      1.19   2825.72      1.00
     a[14]      2.14      0.87      2.10      0.76      3.49   2466.19      1.00
     a[15]      2.12      0.89      2.06      0.63      3.49   2392.23      1.00
     a[16]      2.88      0.76      2.83      1.65      4.03   2326.10      1.00
     a[17]      2.43      0.70      2.38      1.30      3.51   1953.74      1.00
     a[18]      2.02      0.58      1.98      1.11      2.96   2335.88      1.00
     a[19]      3.68      1.01      3.58      2.02      5.16   1714.36      1.00
     a[20]      2.40      0.68      2.34      1.34      3.54   2328.14      1.00
     a[21]      2.42      0.69      2.37      1.27      3.50   2320.16      1.00
     a[22]      2.39      0.69      2.34      1.31      3.45   1661.99      1.00
     a[23]      1.69      0.55      1.66      0.85      2.59   2304.49      1.00
     a[24]     -1.01      0.46     -1.00     -1.73     -0.23   2660.27      1.00
     a[25]      0.16      0.40      0.16     -0.49      0.81   2746.81      1.00
     a[26]     -1.41      0.48     -1.39     -2.20     -0.64   2255.13      1.00
     a[27]     -0.48      0.41     -0.48     -1.10      0.23   2320.56      1.00
     a[28]      0.17      0.39      0.17     -0.46      0.79   2355.92      1.00
     a[29]      1.45      0.50      1.44      0.63      2.19   2988.21      1.00
     a[30]     -0.64      0.42     -0.64     -1.36      0.00   2603.03      1.00
     a[31]     -0.29      0.40     -0.29     -0.97      0.30   3010.16      1.00
     a[32]      3.19      0.80      3.13      1.98      4.52   2231.59      1.00
     a[33]      2.68      0.64      2.63      1.75      3.80   2121.42      1.00
     a[34]      2.72      0.65      2.68      1.59      3.64   1827.94      1.00
     a[35]      2.06      0.53      2.01      1.19      2.90   1980.28      1.00
     a[36]      2.05      0.51      2.02      1.17      2.84   3228.43      1.00
     a[37]      3.86      0.92      3.79      2.24      5.20   1914.76      1.00
     a[38]      2.70      0.67      2.65      1.61      3.74   2086.74      1.00
     a[39]      2.34      0.54      2.30      1.49      3.24   2082.41      1.00
     a[40]     -1.80      0.48     -1.76     -2.51     -0.97   2284.24      1.00
     a[41]     -0.58      0.35     -0.57     -1.16     -0.00   2605.88      1.00
     a[42]     -0.44      0.36     -0.43     -1.03      0.13   3979.86      1.00
     a[43]     -0.34      0.34     -0.34     -0.89      0.23   3182.92      1.00
     a[44]      0.60      0.36      0.58      0.02      1.17   3136.64      1.00
     a[45]     -0.57      0.35     -0.56     -1.16      0.01   2965.70      1.00
     a[46]      2.05      0.50      2.01      1.24      2.88   2869.64      1.00
     a[47]      0.02      0.34      0.03     -0.53      0.58   2265.14      1.00
     a_bar      1.35      0.26      1.34      0.92      1.74   1958.50      1.00
   sigma_a      1.62      0.21      1.60      1.28      1.96   1055.50      1.00

Number of divergences: 0
</pre></div></div>
</div>
</section>
<section id="Code-13.4">
<h3>Code 13.4<a class="headerlink" href="#Code-13.4" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;mcmc_13_1&quot;</span><span class="p">:</span> <span class="n">idata_13_1</span><span class="p">,</span> <span class="s2">&quot;mcmc_13_2&quot;</span><span class="p">:</span> <span class="n">idata_13_2</span><span class="p">},</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;waic&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_waic</th>
      <th>p_waic</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mcmc_13_2</th>
      <td>0</td>
      <td>201.979074</td>
      <td>21.622879</td>
      <td>0.000000</td>
      <td>1.000000e+00</td>
      <td>7.427969</td>
      <td>0.000000</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>mcmc_13_1</th>
      <td>1</td>
      <td>214.610068</td>
      <td>25.697153</td>
      <td>12.630994</td>
      <td>9.769963e-15</td>
      <td>4.585927</td>
      <td>4.160945</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.5">
<h3>Code 13.5<a class="headerlink" href="#Code-13.5" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract samples</span>
<span class="n">posterior_samples_13_2</span> <span class="o">=</span> <span class="n">mcmc_13_2</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>

<span class="c1"># compute median intercept for each tank</span>
<span class="c1"># also transform to probability with logistic</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;propsurv.est&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">posterior_samples_13_2</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># display raw proportions surviving in each tank</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;tank&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion surviving&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;propsurv&quot;</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;tank&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion survival&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">],</span> <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">])</span>

<span class="c1"># overlay posterior means</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;propsurv.est&quot;</span><span class="p">],</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>

<span class="c1"># mark posterior mean probability across tanks</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">posterior_samples_13_2</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">])),</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># draw vertical dividers between tank densities</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">16.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">32.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;small tanks&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;medium tanks&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;large tanks&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_11_0.png" src="../_images/notebooks_13_models_with_memory_11_0.png" />
</div>
</div>
</section>
<section id="Code-13.6">
<h3>Code 13.6<a class="headerlink" href="#Code-13.6" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># show first 100 populations in the posterior</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;log-odds survival&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">loc</span><span class="o">=</span><span class="n">posterior_samples_13_2</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">posterior_samples_13_2</span><span class="p">[</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># sample 8000 imaginary tanks from the poserior distribution</span>
<span class="n">idxs</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">8000</span><span class="p">,),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">3999</span><span class="p">)</span>
<span class="n">sim_tanks</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
    <span class="n">posterior_samples_13_2</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">][</span><span class="n">idxs</span><span class="p">],</span> <span class="n">posterior_samples_13_2</span><span class="p">[</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">][</span><span class="n">idxs</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">sim_tanks</span><span class="p">),</span> <span class="n">bw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;probability survival&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Text(0.5, 0, &#39;probability survival&#39;), Text(0, 0.5, &#39;density&#39;)]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_13_1.png" src="../_images/notebooks_13_models_with_memory_13_1.png" />
</div>
</div>
</section>
<section id="Code-13.7">
<h3>Code 13.7<a class="headerlink" href="#Code-13.7" title="Link to this heading">Â¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_bar</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">n_ponds</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">N_i</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">]),</span> <span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-13.8">
<h3>Code 13.8<a class="headerlink" href="#Code-13.8" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_pond</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="p">(</span><span class="n">n_ponds</span><span class="p">,))</span>
<span class="n">a_pond</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array([ 0.93798981, -0.55722657,  0.97709217,  1.92682734,  3.56034841,
        2.74366663,  3.17893611,  2.60927354,  2.3069955 ,  2.68554158,
        0.64463609,  0.13459253,  3.4130438 ,  0.61092344,  1.41443248,
        1.13276025,  1.3401911 ,  1.71325195,  3.2524383 ,  3.18611473,
        1.72698061,  1.09979343,  0.67642199,  1.47392057,  3.37883504,
        1.12267818,  2.24725077, -2.08293214,  3.04998387,  0.21079306,
        0.72585388,  0.58262294,  3.09915821,  0.47346011,  2.69700394,
        2.32428031,  1.20195152, -0.41904381, -0.71551782,  0.5791303 ,
        1.62128531,  0.97531581,  1.17494922,  1.31834906,  0.14019584,
        2.16789934, -0.6960494 ,  1.77637581,  3.02568801,  3.74509383,
        0.38287769,  0.01025844,  0.0038286 ,  3.696183  ,  2.93860331,
        1.8065584 ,  2.4585205 ,  0.63145181,  3.29633301,  1.40760273],      dtype=float64)
</pre></div></div>
</div>
</section>
<section id="Code-13.9">
<h3>Code 13.9<a class="headerlink" href="#Code-13.9" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pond&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_ponds</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N_i</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span> <span class="n">a_pond</span><span class="p">})</span>
<span class="n">dsim</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>N</th>
      <th>true</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>5</td>
      <td>0.937990</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>5</td>
      <td>-0.557227</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>5</td>
      <td>0.977092</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>5</td>
      <td>1.926827</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5</td>
      <td>3.560348</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5</td>
      <td>5</td>
      <td>2.743667</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6</td>
      <td>5</td>
      <td>3.178936</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7</td>
      <td>5</td>
      <td>2.609274</td>
    </tr>
    <tr>
      <th>8</th>
      <td>8</td>
      <td>5</td>
      <td>2.306995</td>
    </tr>
    <tr>
      <th>9</th>
      <td>9</td>
      <td>5</td>
      <td>2.685542</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10</td>
      <td>5</td>
      <td>0.644636</td>
    </tr>
    <tr>
      <th>11</th>
      <td>11</td>
      <td>5</td>
      <td>0.134593</td>
    </tr>
    <tr>
      <th>12</th>
      <td>12</td>
      <td>5</td>
      <td>3.413044</td>
    </tr>
    <tr>
      <th>13</th>
      <td>13</td>
      <td>5</td>
      <td>0.610923</td>
    </tr>
    <tr>
      <th>14</th>
      <td>14</td>
      <td>5</td>
      <td>1.414432</td>
    </tr>
    <tr>
      <th>15</th>
      <td>15</td>
      <td>10</td>
      <td>1.132760</td>
    </tr>
    <tr>
      <th>16</th>
      <td>16</td>
      <td>10</td>
      <td>1.340191</td>
    </tr>
    <tr>
      <th>17</th>
      <td>17</td>
      <td>10</td>
      <td>1.713252</td>
    </tr>
    <tr>
      <th>18</th>
      <td>18</td>
      <td>10</td>
      <td>3.252438</td>
    </tr>
    <tr>
      <th>19</th>
      <td>19</td>
      <td>10</td>
      <td>3.186115</td>
    </tr>
    <tr>
      <th>20</th>
      <td>20</td>
      <td>10</td>
      <td>1.726981</td>
    </tr>
    <tr>
      <th>21</th>
      <td>21</td>
      <td>10</td>
      <td>1.099793</td>
    </tr>
    <tr>
      <th>22</th>
      <td>22</td>
      <td>10</td>
      <td>0.676422</td>
    </tr>
    <tr>
      <th>23</th>
      <td>23</td>
      <td>10</td>
      <td>1.473921</td>
    </tr>
    <tr>
      <th>24</th>
      <td>24</td>
      <td>10</td>
      <td>3.378835</td>
    </tr>
    <tr>
      <th>25</th>
      <td>25</td>
      <td>10</td>
      <td>1.122678</td>
    </tr>
    <tr>
      <th>26</th>
      <td>26</td>
      <td>10</td>
      <td>2.247251</td>
    </tr>
    <tr>
      <th>27</th>
      <td>27</td>
      <td>10</td>
      <td>-2.082932</td>
    </tr>
    <tr>
      <th>28</th>
      <td>28</td>
      <td>10</td>
      <td>3.049984</td>
    </tr>
    <tr>
      <th>29</th>
      <td>29</td>
      <td>10</td>
      <td>0.210793</td>
    </tr>
    <tr>
      <th>30</th>
      <td>30</td>
      <td>25</td>
      <td>0.725854</td>
    </tr>
    <tr>
      <th>31</th>
      <td>31</td>
      <td>25</td>
      <td>0.582623</td>
    </tr>
    <tr>
      <th>32</th>
      <td>32</td>
      <td>25</td>
      <td>3.099158</td>
    </tr>
    <tr>
      <th>33</th>
      <td>33</td>
      <td>25</td>
      <td>0.473460</td>
    </tr>
    <tr>
      <th>34</th>
      <td>34</td>
      <td>25</td>
      <td>2.697004</td>
    </tr>
    <tr>
      <th>35</th>
      <td>35</td>
      <td>25</td>
      <td>2.324280</td>
    </tr>
    <tr>
      <th>36</th>
      <td>36</td>
      <td>25</td>
      <td>1.201952</td>
    </tr>
    <tr>
      <th>37</th>
      <td>37</td>
      <td>25</td>
      <td>-0.419044</td>
    </tr>
    <tr>
      <th>38</th>
      <td>38</td>
      <td>25</td>
      <td>-0.715518</td>
    </tr>
    <tr>
      <th>39</th>
      <td>39</td>
      <td>25</td>
      <td>0.579130</td>
    </tr>
    <tr>
      <th>40</th>
      <td>40</td>
      <td>25</td>
      <td>1.621285</td>
    </tr>
    <tr>
      <th>41</th>
      <td>41</td>
      <td>25</td>
      <td>0.975316</td>
    </tr>
    <tr>
      <th>42</th>
      <td>42</td>
      <td>25</td>
      <td>1.174949</td>
    </tr>
    <tr>
      <th>43</th>
      <td>43</td>
      <td>25</td>
      <td>1.318349</td>
    </tr>
    <tr>
      <th>44</th>
      <td>44</td>
      <td>25</td>
      <td>0.140196</td>
    </tr>
    <tr>
      <th>45</th>
      <td>45</td>
      <td>35</td>
      <td>2.167899</td>
    </tr>
    <tr>
      <th>46</th>
      <td>46</td>
      <td>35</td>
      <td>-0.696049</td>
    </tr>
    <tr>
      <th>47</th>
      <td>47</td>
      <td>35</td>
      <td>1.776376</td>
    </tr>
    <tr>
      <th>48</th>
      <td>48</td>
      <td>35</td>
      <td>3.025688</td>
    </tr>
    <tr>
      <th>49</th>
      <td>49</td>
      <td>35</td>
      <td>3.745094</td>
    </tr>
    <tr>
      <th>50</th>
      <td>50</td>
      <td>35</td>
      <td>0.382878</td>
    </tr>
    <tr>
      <th>51</th>
      <td>51</td>
      <td>35</td>
      <td>0.010258</td>
    </tr>
    <tr>
      <th>52</th>
      <td>52</td>
      <td>35</td>
      <td>0.003829</td>
    </tr>
    <tr>
      <th>53</th>
      <td>53</td>
      <td>35</td>
      <td>3.696183</td>
    </tr>
    <tr>
      <th>54</th>
      <td>54</td>
      <td>35</td>
      <td>2.938603</td>
    </tr>
    <tr>
      <th>55</th>
      <td>55</td>
      <td>35</td>
      <td>1.806558</td>
    </tr>
    <tr>
      <th>56</th>
      <td>56</td>
      <td>35</td>
      <td>2.458520</td>
    </tr>
    <tr>
      <th>57</th>
      <td>57</td>
      <td>35</td>
      <td>0.631452</td>
    </tr>
    <tr>
      <th>58</th>
      <td>58</td>
      <td>35</td>
      <td>3.296333</td>
    </tr>
    <tr>
      <th>59</th>
      <td>59</td>
      <td>35</td>
      <td>1.407603</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.10">
<h3>Code 13.10<a class="headerlink" href="#Code-13.10" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dtype(&#39;int64&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dtype(&#39;float64&#39;)
</pre></div></div>
</div>
</section>
<section id="Code-13.11">
<h3>Code 13.11<a class="headerlink" href="#Code-13.11" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span>
    <span class="n">total_count</span><span class="o">=</span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">probs</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>N</th>
      <th>true</th>
      <th>S</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>5</td>
      <td>0.937990</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>5</td>
      <td>-0.557227</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>5</td>
      <td>0.977092</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>5</td>
      <td>1.926827</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5</td>
      <td>3.560348</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.12">
<h3>Code 13.12<a class="headerlink" href="#Code-13.12" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_no_pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>N</th>
      <th>true</th>
      <th>S</th>
      <th>p_no_pool</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>5</td>
      <td>0.937990</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>5</td>
      <td>-0.557227</td>
      <td>2</td>
      <td>0.4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>5</td>
      <td>0.977092</td>
      <td>3</td>
      <td>0.6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>5</td>
      <td>1.926827</td>
      <td>2</td>
      <td>0.4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5</td>
      <td>3.560348</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="id1">
<h3>Code 13.13<a class="headerlink" href="#id1" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_3</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">pond</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;pond&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>

    <span class="n">logit_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">pond</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">S</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;pond&quot;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;pond&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13_3</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_3</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">idata_13_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "80ce9e67fca142009be2a8dc0dc92475", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "704840b99f054d009be2269dd64cd5fe", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6a49cc2e481b4e67a91e85d4b76f34a8", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "61290284d82246e290d212ad4658f3da", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="Code-13.14">
<h3>Code 13.14<a class="headerlink" href="#Code-13.14" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mcmc_13_3</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
      a[0]      2.52      1.04      2.46      0.86      4.24   2187.55      1.00
      a[1]      0.34      0.76      0.34     -0.85      1.59   2356.14      1.00
      a[2]      0.91      0.84      0.88     -0.49      2.27   2434.35      1.00
      a[3]      0.35      0.78      0.33     -1.01      1.51   2845.51      1.00
      a[4]      2.47      1.07      2.39      0.70      4.05   2068.78      1.00
      a[5]      2.47      0.99      2.43      0.91      4.08   1845.39      1.00
      a[6]      2.44      1.00      2.41      0.82      4.08   2793.98      1.00
      a[7]      1.59      0.85      1.54      0.31      3.08   1959.98      1.00
      a[8]      2.48      1.04      2.41      0.80      4.13   2411.30      1.00
      a[9]      2.47      1.02      2.39      0.79      4.01   1908.00      1.00
     a[10]      0.29      0.80      0.33     -1.07      1.56   2528.79      1.00
     a[11]      0.90      0.83      0.87     -0.39      2.28   2401.14      1.00
     a[12]      2.49      1.05      2.41      0.76      4.10   2065.41      1.00
     a[13]      1.65      0.87      1.60      0.35      3.18   2365.07      1.00
     a[14]      2.45      0.97      2.40      0.88      4.04   2059.76      1.00
     a[15]      1.53      0.67      1.52      0.39      2.56   2325.38      1.00
     a[16]      1.54      0.71      1.50      0.41      2.71   2713.20      1.00
     a[17]      2.10      0.79      2.04      0.78      3.38   2186.20      1.00
     a[18]      2.84      0.97      2.78      1.24      4.28   1335.60      1.00
     a[19]      2.09      0.80      2.05      0.88      3.51   2804.19      1.00
     a[20]      2.09      0.80      2.04      0.74      3.30   2622.73      1.00
     a[21]      1.10      0.66      1.06      0.04      2.11   2886.59      1.00
     a[22]      0.70      0.62      0.68     -0.32      1.69   1951.70      1.00
     a[23]      1.56      0.70      1.54      0.42      2.65   2269.91      1.00
     a[24]      2.80      0.95      2.71      1.31      4.34   1777.16      1.00
     a[25]      2.11      0.81      2.05      0.84      3.45   2463.97      1.00
     a[26]      2.12      0.85      2.07      0.68      3.43   2306.93      1.00
     a[27]     -0.71      0.61     -0.69     -1.66      0.36   2233.29      1.00
     a[28]      2.08      0.79      2.03      0.82      3.35   2365.46      1.00
     a[29]      0.72      0.60      0.70     -0.26      1.70   2851.67      1.00
     a[30]      1.47      0.49      1.44      0.66      2.23   2454.57      1.00
     a[31]      0.70      0.40      0.69      0.02      1.34   2653.09      1.00
     a[32]      2.77      0.71      2.72      1.60      3.89   2045.54      1.00
     a[33]      0.24      0.40      0.24     -0.43      0.86   3209.51      1.00
     a[34]      2.77      0.71      2.73      1.61      3.93   1951.94      1.00
     a[35]      2.80      0.73      2.75      1.61      3.91   2160.10      1.00
     a[36]      1.47      0.47      1.45      0.68      2.25   2699.32      1.00
     a[37]     -0.21      0.38     -0.19     -0.84      0.39   2618.76      1.00
     a[38]     -0.38      0.40     -0.38     -1.03      0.27   2772.68      1.00
     a[39]      1.25      0.47      1.24      0.48      1.97   2734.83      1.00
     a[40]      1.74      0.55      1.72      0.88      2.67   2816.48      1.00
     a[41]      0.71      0.42      0.69     -0.03      1.36   2727.21      1.00
     a[42]      1.71      0.50      1.68      0.90      2.53   2210.01      1.00
     a[43]      1.98      0.54      1.97      1.15      2.94   2849.11      1.00
     a[44]      0.54      0.40      0.53     -0.11      1.23   2707.70      1.00
     a[45]      3.06      0.70      3.01      1.91      4.14   1899.80      1.00
     a[46]     -0.85      0.37     -0.84     -1.44     -0.24   2461.55      1.00
     a[47]      2.32      0.53      2.29      1.46      3.17   2465.58      1.00
     a[48]      3.60      0.85      3.51      2.33      5.00   1544.30      1.00
     a[49]      2.07      0.52      2.03      1.22      2.88   2180.25      1.00
     a[50]      1.00      0.38      0.99      0.36      1.56   2584.95      1.00
     a[51]      0.63      0.36      0.63      0.04      1.24   2436.75      1.00
     a[52]      0.27      0.33      0.28     -0.28      0.81   3287.30      1.00
     a[53]      3.56      0.82      3.49      2.41      5.00   1423.59      1.00
     a[54]      3.05      0.69      2.99      2.01      4.26   1935.45      1.00
     a[55]      2.30      0.54      2.27      1.46      3.17   2645.82      1.00
     a[56]      2.31      0.52      2.29      1.45      3.15   1822.32      1.00
     a[57]      0.63      0.35      0.63      0.02      1.16   2608.94      1.00
     a[58]      2.64      0.59      2.61      1.69      3.57   1678.24      1.00
     a[59]      1.15      0.39      1.13      0.49      1.75   2458.04      1.00
     a_bar      1.61      0.21      1.60      1.30      1.97   1150.31      1.01
   sigma_a      1.27      0.19      1.26      0.96      1.55    720.59      1.01

Number of divergences: 0
</pre></div></div>
</div>
</section>
<section id="Code-13.15">
<h3>Code 13.15<a class="headerlink" href="#Code-13.15" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_13_3</span> <span class="o">=</span> <span class="n">mcmc_13_3</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_partial_pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span>
    <span class="n">posterior_samples_13_3</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>N</th>
      <th>true</th>
      <th>S</th>
      <th>p_no_pool</th>
      <th>p_partial_pool</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>5</td>
      <td>0.937990</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.925447</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>5</td>
      <td>-0.557227</td>
      <td>2</td>
      <td>0.4</td>
      <td>0.584397</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>5</td>
      <td>0.977092</td>
      <td>3</td>
      <td>0.6</td>
      <td>0.712754</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>5</td>
      <td>1.926827</td>
      <td>2</td>
      <td>0.4</td>
      <td>0.585443</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5</td>
      <td>3.560348</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.922104</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.16">
<h3>Code 13.16<a class="headerlink" href="#Code-13.16" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_true&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>N</th>
      <th>true</th>
      <th>S</th>
      <th>p_no_pool</th>
      <th>p_partial_pool</th>
      <th>p_true</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>5</td>
      <td>0.937990</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.925447</td>
      <td>0.718693</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>5</td>
      <td>-0.557227</td>
      <td>2</td>
      <td>0.4</td>
      <td>0.584397</td>
      <td>0.364189</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>5</td>
      <td>0.977092</td>
      <td>3</td>
      <td>0.6</td>
      <td>0.712754</td>
      <td>0.726531</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>5</td>
      <td>1.926827</td>
      <td>2</td>
      <td>0.4</td>
      <td>0.585443</td>
      <td>0.872898</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5</td>
      <td>3.560348</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.922104</td>
      <td>0.972357</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.17">
<h3>Code 13.17<a class="headerlink" href="#Code-13.17" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;no_pool_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_no_pool&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_true&quot;</span><span class="p">]</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;partial_pool_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_partial_pool&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_true&quot;</span><span class="p">]</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>N</th>
      <th>true</th>
      <th>S</th>
      <th>p_no_pool</th>
      <th>p_partial_pool</th>
      <th>p_true</th>
      <th>no_pool_error</th>
      <th>partial_pool_error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>5</td>
      <td>0.937990</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.925447</td>
      <td>0.718693</td>
      <td>0.281307</td>
      <td>0.206753</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>5</td>
      <td>-0.557227</td>
      <td>2</td>
      <td>0.4</td>
      <td>0.584397</td>
      <td>0.364189</td>
      <td>0.035811</td>
      <td>0.220207</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>5</td>
      <td>0.977092</td>
      <td>3</td>
      <td>0.6</td>
      <td>0.712754</td>
      <td>0.726531</td>
      <td>-0.126531</td>
      <td>-0.013777</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>5</td>
      <td>1.926827</td>
      <td>2</td>
      <td>0.4</td>
      <td>0.585443</td>
      <td>0.872898</td>
      <td>-0.472898</td>
      <td>-0.287455</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5</td>
      <td>3.560348</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.922104</td>
      <td>0.972357</td>
      <td>0.027643</td>
      <td>-0.050253</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.18">
<h3>Code 13.18<a class="headerlink" href="#Code-13.18" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">),</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;no_pool_error&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;nopool&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;pond&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;absolute error&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">),</span>
    <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;partial_pool_error&quot;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;partpool&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_37_0.png" src="../_images/notebooks_13_models_with_memory_37_0.png" />
</div>
</div>
</section>
<section id="Code-13.19">
<h3>Code 13.19<a class="headerlink" href="#Code-13.19" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">no_pool_avg</span> <span class="o">=</span> <span class="n">dsim</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)[</span><span class="s2">&quot;no_pool_error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">part_pool_avg</span> <span class="o">=</span> <span class="n">dsim</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)[</span><span class="s2">&quot;partial_pool_error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">no_pool_avg</span><span class="p">,</span> <span class="n">part_pool_avg</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>no_pool_error</th>
      <th>partial_pool_error</th>
    </tr>
    <tr>
      <th>N</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>0.003903</td>
      <td>0.018171</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.017398</td>
      <td>0.032248</td>
    </tr>
    <tr>
      <th>25</th>
      <td>0.029314</td>
      <td>0.044540</td>
    </tr>
    <tr>
      <th>35</th>
      <td>0.019229</td>
      <td>0.022018</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.20">
<h3>Code 13.20<a class="headerlink" href="#Code-13.20" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">n_ponds</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">Ni</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">]),</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">a_pond</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="p">(</span><span class="n">n_ponds</span><span class="p">,))</span>
<span class="n">dsim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pond&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_ponds</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">Ni</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span> <span class="n">a_pond</span><span class="p">})</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span>
    <span class="n">total_count</span><span class="o">=</span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">probs</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_no_pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span>
<span class="n">new_training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;pond&quot;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;pond&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">model_13_3new</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span>
    <span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_3</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">1_000</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1_000</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span>
<span class="p">)</span>
<span class="n">model_13_3new</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">**</span><span class="n">new_training_data</span><span class="p">)</span>

<span class="n">post</span> <span class="o">=</span> <span class="n">model_13_3new</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_partial_pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_true&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">nopool_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_no_pool&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dsim</span><span class="o">.</span><span class="n">p_true</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">partpool_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_partial_pool&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dsim</span><span class="o">.</span><span class="n">p_true</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">),</span> <span class="n">nopool_error</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;nopool&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;pond&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;absolute error&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">),</span>
    <span class="n">partpool_error</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;partpool&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9131a3f5ac54412fa8fc2007a48387dc", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a4dd1aa05b09444ebf2e09175db5e36f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "75e24de02fe24cc9adcf88caf07d731b", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9f162c51841a4463ae893dcf5b73f282", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_41_4.png" src="../_images/notebooks_13_models_with_memory_41_4.png" />
</div>
</div>
</section>
<section id="Code-13.21">
<h3>Code 13.21<a class="headerlink" href="#Code-13.21" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/chimpanzees.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;prosoc_left&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
      <th>treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>499</th>
      <td>7</td>
      <td>4.0</td>
      <td>1</td>
      <td>6</td>
      <td>64</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>500</th>
      <td>7</td>
      <td>6.0</td>
      <td>1</td>
      <td>6</td>
      <td>66</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>501</th>
      <td>7</td>
      <td>3.0</td>
      <td>1</td>
      <td>6</td>
      <td>68</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>502</th>
      <td>7</td>
      <td>7.0</td>
      <td>1</td>
      <td>6</td>
      <td>70</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>503</th>
      <td>7</td>
      <td>2.0</td>
      <td>1</td>
      <td>6</td>
      <td>72</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
<p>504 rows Ã 9 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_4</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">pulled_left</span><span class="p">):</span>
    <span class="c1"># hyper-priors</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sigma_g</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_g&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># adaptive priors</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;actor&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma_g</span><span class="p">))</span>

    <span class="c1"># old fashioned priors</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">b_treatment</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="c1"># likelihood</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">actor</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_treatment</span><span class="p">[</span><span class="n">treatment</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">pulled_left</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;treatment&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;block&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;pulled_left&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13_4</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_4</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">idata_13_4</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_4</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span>
    <span class="n">idata_13_4</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_g&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;b_treatment&quot;</span><span class="p">],</span>
    <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;rank_bars&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bdaeb08bcf4f4f7baa171fda45f8bb6e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "58ad498ca5a048aa81f7a9391b49c396", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ad08980c66b04d6dbc832ecc4ca4b3e9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5db478515f42493ca66718c633094300", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_44_4.png" src="../_images/notebooks_13_models_with_memory_44_4.png" />
</div>
</div>
</section>
<section id="Code-13.22">
<h3>Code 13.22<a class="headerlink" href="#Code-13.22" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mcmc_13_4</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                    mean       std    median      5.0%     95.0%     n_eff     r_hat
          a[0]     -0.34      0.36     -0.34     -0.94      0.27    328.53      1.00
          a[1]      4.71      1.37      4.47      2.74      6.62    501.29      1.00
          a[2]     -0.64      0.37     -0.64     -1.23     -0.03    334.24      1.00
          a[3]     -0.64      0.37     -0.65     -1.24     -0.04    322.97      1.00
          a[4]     -0.36      0.35     -0.37     -0.92      0.21    336.65      1.00
          a[5]      0.60      0.37      0.59      0.00      1.19    329.08      1.00
          a[6]      2.12      0.46      2.08      1.30      2.84    407.95      1.00
         a_bar      0.61      0.74      0.58     -0.61      1.75    733.51      1.00
b_treatment[0]     -0.15      0.30     -0.13     -0.61      0.36    346.33      1.00
b_treatment[1]      0.37      0.30      0.39     -0.08      0.90    322.31      1.01
b_treatment[2]     -0.49      0.30     -0.49     -0.96      0.04    372.54      1.00
b_treatment[3]      0.26      0.30      0.27     -0.25      0.73    329.01      1.00
          g[0]     -0.17      0.23     -0.11     -0.53      0.12    321.99      1.02
          g[1]      0.04      0.20      0.02     -0.23      0.37    626.85      1.00
          g[2]      0.05      0.18      0.03     -0.24      0.37    712.88      1.01
          g[3]      0.00      0.18      0.01     -0.30      0.29    691.73      1.00
          g[4]     -0.03      0.18     -0.02     -0.36      0.24    784.81      1.00
          g[5]      0.11      0.20      0.06     -0.20      0.44    496.28      1.00
       sigma_a      2.05      0.67      1.91      1.08      3.01    522.70      1.00
       sigma_g      0.22      0.17      0.17      0.02      0.45    199.47      1.02

Number of divergences: 51
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">idata_13_4</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;b_treatment&quot;</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&lt;Axes: title={&#39;center&#39;: &#39;94.0% HDI&#39;}&gt;], dtype=object)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_47_1.png" src="../_images/notebooks_13_models_with_memory_47_1.png" />
</div>
</div>
</section>
<section id="Code-13.23">
<h3>Code 13.23<a class="headerlink" href="#Code-13.23" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_5</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">pulled_left</span><span class="p">):</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;actor&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">b_treatment</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">actor</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_treatment</span><span class="p">[</span><span class="n">treatment</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">pulled_left</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;treatment&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;pulled_left&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13_5</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_5</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_5</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">mcmc_13_5</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">idata_13_5</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_5</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span>
    <span class="n">idata_13_5</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b_treatment&quot;</span><span class="p">],</span>
    <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;rank_bars&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d4338a75c70145b3853ac617eecab2a4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "95bc5955f0dd423cacda3e6dd86aa6fa", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1fc9a11f67594dad99ce72ac8a400037", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b130a1e8c13e4c86b08c011a860dd04a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                    mean       std    median      5.0%     95.0%     n_eff     r_hat
          a[0]     -0.33      0.35     -0.32     -0.95      0.20    405.96      1.01
          a[1]      4.74      1.28      4.53      2.81      6.68    858.62      1.00
          a[2]     -0.63      0.34     -0.62     -1.22     -0.09    395.98      1.01
          a[3]     -0.63      0.35     -0.62     -1.21     -0.06    409.71      1.01
          a[4]     -0.33      0.35     -0.33     -0.92      0.22    449.57      1.01
          a[5]      0.61      0.35      0.60     -0.01      1.14    396.07      1.01
          a[6]      2.13      0.46      2.13      1.42      2.89    526.38      1.00
         a_bar      0.64      0.74      0.64     -0.46      1.93    943.30      1.00
b_treatment[0]     -0.16      0.30     -0.15     -0.69      0.30    368.60      1.01
b_treatment[1]      0.37      0.30      0.36     -0.10      0.87    347.88      1.01
b_treatment[2]     -0.50      0.30     -0.50     -1.02     -0.03    388.26      1.01
b_treatment[3]      0.27      0.30      0.27     -0.22      0.75    358.33      1.01
       sigma_a      2.03      0.67      1.90      1.12      3.02    961.22      1.00

Number of divergences: 0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_49_5.png" src="../_images/notebooks_13_models_with_memory_49_5.png" />
</div>
</div>
</section>
<section id="Code-13.24">
<h3>Code 13.24<a class="headerlink" href="#Code-13.24" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;mcmc_13_4&quot;</span><span class="p">:</span> <span class="n">idata_13_4</span><span class="p">,</span> <span class="s2">&quot;mcmc_13_5&quot;</span><span class="p">:</span> <span class="n">idata_13_5</span><span class="p">},</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;waic&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_waic</th>
      <th>p_waic</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mcmc_13_5</th>
      <td>0</td>
      <td>531.073233</td>
      <td>8.582268</td>
      <td>0.000000</td>
      <td>1.0</td>
      <td>19.227100</td>
      <td>0.000000</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>mcmc_13_4</th>
      <td>1</td>
      <td>532.432329</td>
      <td>10.703010</td>
      <td>1.359096</td>
      <td>0.0</td>
      <td>19.328681</td>
      <td>1.670664</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.25">
<h3>Code 13.25<a class="headerlink" href="#Code-13.25" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_6</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">pulled_left</span><span class="p">):</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sigma_g</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_g&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;actor&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma_g</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">b_treatment</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;p&quot;</span><span class="p">,</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">actor</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_treatment</span><span class="p">[</span><span class="n">treatment</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">pulled_left</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;block&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;treatment&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;pulled_left&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13_6</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_6</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_6</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">idata_13_6</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_6</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;model 13.4&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcmc_13_4</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;model 13.6&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcmc_13_6</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9053b93ea4804bf8ac02aa89bd7ee57a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9c0b0803b8db4a879f5a381671ae9944", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d44c2ee25a404fa38562c0ee6b4be8af", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bf65f243961d4c5a8be325e9ab313f50", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model 13.4</th>
      <th>model 13.6</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.147274</td>
      <td>-0.107149</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.372126</td>
      <td>0.382862</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.494190</td>
      <td>-0.420218</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.256404</td>
      <td>0.277269</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;model 13.4&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcmc_13_4</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;model 13.6&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcmc_13_6</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model 13.4</th>
      <th>model 13.6</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.147274</td>
      <td>-0.107149</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.372126</td>
      <td>0.382862</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.494190</td>
      <td>-0.420218</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.256404</td>
      <td>0.277269</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.26">
<h3>Code 13.26<a class="headerlink" href="#Code-13.26" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_7</span><span class="p">():</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>


<span class="n">mcmc_13_7</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_7</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_7</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">mcmc_13_7</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">idata_13_7</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_7</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">idata_13_7</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;rank_bars&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0ae15f7481264c488ba949c0fefbcd88", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "243dd20fc8d1449a8998aeb24e8e4ba9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "aaa4e0c5d9354c258d8ddea75597984a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "fbdfe0682b80491d96a69164f92b8767", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
         v      2.51      2.20      2.09     -0.65      5.52     27.90      1.11
         x    335.45   1821.00      0.38   -113.87    173.54     24.51      1.14

Number of divergences: 153
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_56_5.png" src="../_images/notebooks_13_models_with_memory_56_5.png" />
</div>
</div>
</section>
<section id="Code-13.27">
<h3>Code 13.27<a class="headerlink" href="#Code-13.27" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_7_nc</span><span class="p">():</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">z</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>


<span class="n">mcmc_13_7_nc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_7_nc</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_7_nc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">mcmc_13_7_nc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span><span class="n">exclude_deterministic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">idata_13_7_nc</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_7_nc</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">idata_13_7_nc</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;rank_bars&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2174751a37c841feaee264ade5898b4d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1eb697e7f33e4b46b4f3eca0fe92938e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e820ec361e4b4c7abb4760b974787ee3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7d4de23dd65b46df99a220754fd1a570", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.0%     95.0%     n_eff     r_hat
         v      0.00      3.09      0.00     -4.94      5.08   1975.37      1.00
         x    -19.10    550.81     -0.00    -35.39     32.30   1817.80      1.00
         z     -0.00      1.05     -0.00     -1.74      1.72   1629.93      1.00

Number of divergences: 0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_58_5.png" src="../_images/notebooks_13_models_with_memory_58_5.png" />
</div>
</div>
</section>
<section id="Code-13.28">
<h3>Code 13.28<a class="headerlink" href="#Code-13.28" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mcmc_13_4b</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span>
    <span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">target_accept_prob</span><span class="o">=</span><span class="mf">0.9</span><span class="p">),</span>
    <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mcmc_13_4b</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">mcmc_13_4b</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a3f5886df6304eb08259ed940d43f2e0", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c7b6fc1e2e214b61ac98e847b303c113", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "70d7e6a850f74e90893904276d63c25e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0315a9fa0b84476491299cc0f02131a9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                    mean       std    median      5.0%     95.0%     n_eff     r_hat
          a[0]     -0.35      0.36     -0.36     -1.00      0.17    373.89      1.00
          a[1]      4.64      1.20      4.44      2.92      6.55    783.05      1.00
          a[2]     -0.66      0.37     -0.65     -1.25     -0.05    347.61      1.00
          a[3]     -0.65      0.37     -0.65     -1.27     -0.04    448.72      1.00
          a[4]     -0.36      0.36     -0.36     -0.89      0.24    439.80      1.00
          a[5]      0.59      0.35      0.59      0.08      1.23    390.01      1.00
          a[6]      2.11      0.46      2.10      1.37      2.86    460.45      1.00
         a_bar      0.59      0.76      0.57     -0.58      1.89    718.26      1.00
b_treatment[0]     -0.13      0.29     -0.14     -0.57      0.38    380.57      1.01
b_treatment[1]      0.40      0.29      0.39     -0.14      0.80    375.76      1.01
b_treatment[2]     -0.48      0.30     -0.49     -1.01      0.00    375.79      1.01
b_treatment[3]      0.28      0.29      0.28     -0.23      0.72    354.55      1.00
          g[0]     -0.17      0.22     -0.11     -0.56      0.10    344.01      1.00
          g[1]      0.04      0.18      0.02     -0.24      0.32    888.35      1.00
          g[2]      0.05      0.18      0.03     -0.23      0.34    782.20      1.01
          g[3]      0.01      0.18      0.00     -0.26      0.32    891.02      1.00
          g[4]     -0.04      0.18     -0.02     -0.35      0.22    767.17      1.01
          g[5]      0.12      0.20      0.07     -0.16      0.45    635.65      1.01
       sigma_a      2.00      0.64      1.87      1.05      2.96    932.99      1.00
       sigma_g      0.22      0.17      0.18      0.01      0.43    266.88      1.01

Number of divergences: 3
</pre></div></div>
</div>
</section>
<section id="Code-13.29">
<h3>Code 13.29<a class="headerlink" href="#Code-13.29" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_4nc</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">pulled_left</span><span class="p">):</span>
    <span class="c1"># hyper-priors</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sigma_g</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_g&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># adaptive priors</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">reparam</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">reparam</span><span class="o">.</span><span class="n">LocScaleReparam</span><span class="p">(</span><span class="mi">0</span><span class="p">)}</span>
    <span class="p">):</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;actor&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">z_block</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;z_block&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">z_block</span> <span class="o">*</span> <span class="n">sigma_g</span><span class="p">)</span>

    <span class="c1"># old fashioned priors</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">b_treatment</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="c1"># likelihood</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">actor</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_treatment</span><span class="p">[</span><span class="n">treatment</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">pulled_left</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;treatment&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;block&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;pulled_left&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13_4nc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13_4nc</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13_4nc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">mcmc_13_4nc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span><span class="n">exclude_deterministic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">idata_13_4nc</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13_4nc</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span>
    <span class="n">idata_13_4nc</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_g&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;b_treatment&quot;</span><span class="p">],</span>
    <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;rank_bars&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "928c82c8c9564b729860fa3590730d9f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3f845ad5c5144b50b4d733103d65fc5b", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "eee48f95e4d94103a3289a95d6b183c8", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9e08bd166ca341cfa53c4eebc62935a7", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                     mean       std    median      5.0%     95.0%     n_eff     r_hat
           a[0]     -0.37      0.37     -0.37     -1.03      0.18   1119.32      1.00
           a[1]      4.70      1.32      4.47      2.73      6.56   1615.98      1.00
           a[2]     -0.67      0.38     -0.67     -1.32     -0.11   1255.68      1.00
           a[3]     -0.68      0.37     -0.68     -1.28     -0.03   1119.20      1.00
           a[4]     -0.38      0.36     -0.37     -1.01      0.15   1200.88      1.00
           a[5]      0.57      0.37      0.57     -0.07      1.14   1252.00      1.00
           a[6]      2.10      0.45      2.08      1.37      2.87   1540.03      1.00
          a_bar      0.57      0.72      0.58     -0.57      1.72    433.79      1.00
a_decentered[0]     -0.51      0.38     -0.49     -1.14      0.09    447.96      1.01
a_decentered[1]      2.11      0.63      2.08      1.08      3.09   1126.75      1.00
a_decentered[2]     -0.67      0.40     -0.65     -1.33     -0.03    440.48      1.01
a_decentered[3]     -0.67      0.40     -0.66     -1.32     -0.05    447.08      1.01
a_decentered[4]     -0.51      0.38     -0.50     -1.14      0.09    443.60      1.01
a_decentered[5]     -0.00      0.35      0.00     -0.56      0.59    476.33      1.00
a_decentered[6]      0.81      0.44      0.78      0.16      1.56    669.20      1.00
 b_treatment[0]     -0.12      0.30     -0.13     -0.60      0.39    987.82      1.00
 b_treatment[1]      0.41      0.30      0.40     -0.08      0.90   1069.46      1.00
 b_treatment[2]     -0.46      0.30     -0.45     -0.97      0.03   1097.73      1.00
 b_treatment[3]      0.30      0.30      0.31     -0.19      0.79   1064.64      1.00
           g[0]     -0.16      0.21     -0.10     -0.51      0.12   1230.10      1.00
           g[1]      0.04      0.18      0.02     -0.23      0.34   2117.26      1.00
           g[2]      0.05      0.18      0.02     -0.21      0.35   1935.09      1.00
           g[3]      0.01      0.17      0.00     -0.28      0.29   2089.55      1.00
           g[4]     -0.03      0.18     -0.01     -0.30      0.28   2264.76      1.00
           g[5]      0.10      0.19      0.05     -0.14      0.44   1616.10      1.00
           p[0]      0.35      0.08      0.35      0.22      0.47   2000.29      1.00
           p[1]      0.35      0.08      0.35      0.22      0.47   2000.29      1.00
           p[2]      0.47      0.09      0.47      0.34      0.62   2032.11      1.00
           p[3]      0.35      0.08      0.35      0.22      0.47   2000.29      1.00
           p[4]      0.47      0.09      0.47      0.34      0.62   2032.11      1.00
           p[5]      0.47      0.09      0.47      0.34      0.62   2032.11      1.00
           p[6]      0.52      0.08      0.52      0.39      0.66   2729.58      1.00
           p[7]      0.52      0.08      0.52      0.39      0.66   2729.58      1.00
           p[8]      0.39      0.08      0.39      0.26      0.52   2683.15      1.00
           p[9]      0.39      0.08      0.39      0.26      0.52   2683.15      1.00
          p[10]      0.39      0.08      0.39      0.26      0.52   2683.15      1.00
          p[11]      0.52      0.08      0.52      0.39      0.66   2729.58      1.00
          p[12]      0.39      0.08      0.39      0.26      0.51   2637.97      1.00
          p[13]      0.52      0.08      0.52      0.40      0.66   2564.38      1.00
          p[14]      0.39      0.08      0.39      0.26      0.51   2637.97      1.00
          p[15]      0.52      0.08      0.52      0.40      0.66   2564.38      1.00
          p[16]      0.52      0.08      0.52      0.40      0.66   2564.38      1.00
          p[17]      0.39      0.08      0.39      0.26      0.51   2637.97      1.00
          p[18]      0.51      0.08      0.51      0.37      0.64   2789.42      1.00
          p[19]      0.38      0.08      0.38      0.25      0.50   2807.17      1.00
          p[20]      0.38      0.08      0.38      0.25      0.50   2807.17      1.00
          p[21]      0.38      0.08      0.38      0.25      0.50   2807.17      1.00
          p[22]      0.51      0.08      0.51      0.37      0.64   2789.42      1.00
          p[23]      0.51      0.08      0.51      0.37      0.64   2789.42      1.00
          p[24]      0.38      0.08      0.37      0.25      0.50   2664.75      1.00
          p[25]      0.38      0.08      0.37      0.25      0.50   2664.75      1.00
          p[26]      0.50      0.08      0.50      0.36      0.63   2848.94      1.00
          p[27]      0.50      0.08      0.50      0.36      0.63   2848.94      1.00
          p[28]      0.38      0.08      0.37      0.25      0.50   2664.75      1.00
          p[29]      0.50      0.08      0.50      0.36      0.63   2848.94      1.00
          p[30]      0.41      0.08      0.40      0.27      0.54   2664.22      1.00
          p[31]      0.53      0.08      0.54      0.39      0.66   2506.26      1.00
          p[32]      0.53      0.08      0.54      0.39      0.66   2506.26      1.00
          p[33]      0.53      0.08      0.54      0.39      0.66   2506.26      1.00
          p[34]      0.41      0.08      0.40      0.27      0.54   2664.22      1.00
          p[35]      0.41      0.08      0.40      0.27      0.54   2664.22      1.00
          p[36]      0.28      0.07      0.27      0.15      0.38   1871.03      1.00
          p[37]      0.28      0.07      0.27      0.15      0.38   1871.03      1.00
          p[38]      0.44      0.09      0.44      0.31      0.59   1717.88      1.00
          p[39]      0.28      0.07      0.27      0.15      0.38   1871.03      1.00
          p[40]      0.28      0.07      0.27      0.15      0.38   1871.03      1.00
          p[41]      0.28      0.07      0.27      0.15      0.38   1871.03      1.00
          p[42]      0.49      0.08      0.49      0.35      0.61   2648.60      1.00
          p[43]      0.32      0.07      0.31      0.20      0.43   2470.34      1.00
          p[44]      0.49      0.08      0.49      0.35      0.61   2648.60      1.00
          p[45]      0.32      0.07      0.31      0.20      0.43   2470.34      1.00
          p[46]      0.49      0.08      0.49      0.35      0.61   2648.60      1.00
          p[47]      0.32      0.07      0.31      0.20      0.43   2470.34      1.00
          p[48]      0.49      0.08      0.49      0.37      0.64   2661.63      1.00
          p[49]      0.32      0.07      0.31      0.20      0.43   2382.94      1.00
          p[50]      0.49      0.08      0.49      0.37      0.64   2661.63      1.00
          p[51]      0.49      0.08      0.49      0.37      0.64   2661.63      1.00
          p[52]      0.49      0.08      0.49      0.37      0.64   2661.63      1.00
          p[53]      0.32      0.07      0.31      0.20      0.43   2382.94      1.00
          p[54]      0.31      0.07      0.31      0.20      0.41   2872.85      1.00
          p[55]      0.48      0.08      0.48      0.36      0.62   2665.62      1.00
          p[56]      0.48      0.08      0.48      0.36      0.62   2665.62      1.00
          p[57]      0.31      0.07      0.31      0.20      0.41   2872.85      1.00
          p[58]      0.31      0.07      0.31      0.20      0.41   2872.85      1.00
          p[59]      0.31      0.07      0.31      0.20      0.41   2872.85      1.00
          p[60]      0.47      0.08      0.47      0.35      0.62   2341.47      1.00
          p[61]      0.47      0.08      0.47      0.35      0.62   2341.47      1.00
          p[62]      0.47      0.08      0.47      0.35      0.62   2341.47      1.00
          p[63]      0.30      0.07      0.30      0.19      0.42   2522.31      1.00
          p[64]      0.30      0.07      0.30      0.19      0.42   2522.31      1.00
          p[65]      0.47      0.08      0.47      0.35      0.62   2341.47      1.00
          p[66]      0.51      0.08      0.51      0.37      0.63   2491.94      1.00
          p[67]      0.51      0.08      0.51      0.37      0.63   2491.94      1.00
          p[68]      0.33      0.07      0.32      0.21      0.45   2385.02      1.00
          p[69]      0.51      0.08      0.51      0.37      0.63   2491.94      1.00
          p[70]      0.51      0.08      0.51      0.37      0.63   2491.94      1.00
          p[71]      0.33      0.07      0.32      0.21      0.45   2385.02      1.00
          p[72]      0.99      0.01      0.99      0.97      1.00   1515.30      1.00
          p[73]      0.98      0.02      0.99      0.95      1.00   1591.18      1.00
          p[74]      0.98      0.02      0.99      0.95      1.00   1591.18      1.00
          p[75]      0.98      0.02      0.99      0.95      1.00   1591.18      1.00
          p[76]      0.99      0.01      0.99      0.97      1.00   1515.30      1.00
          p[77]      0.99      0.01      0.99      0.97      1.00   1515.30      1.00
          p[78]      0.99      0.01      0.99      0.98      1.00   1447.12      1.00
          p[79]      0.99      0.01      0.99      0.98      1.00   1447.12      1.00
          p[80]      0.99      0.01      0.99      0.98      1.00   1447.12      1.00
          p[81]      0.98      0.02      0.99      0.96      1.00   1581.42      1.00
          p[82]      0.98      0.02      0.99      0.96      1.00   1581.42      1.00
          p[83]      0.98      0.02      0.99      0.96      1.00   1581.42      1.00
          p[84]      0.98      0.02      0.99      0.96      1.00   1703.89      1.00
          p[85]      0.98      0.02      0.99      0.96      1.00   1703.89      1.00
          p[86]      0.99      0.01      0.99      0.98      1.00   1559.24      1.00
          p[87]      0.99      0.01      0.99      0.98      1.00   1559.24      1.00
          p[88]      0.98      0.02      0.99      0.96      1.00   1703.89      1.00
          p[89]      0.99      0.01      0.99      0.98      1.00   1559.24      1.00
          p[90]      0.98      0.02      0.99      0.96      1.00   1822.00      1.00
          p[91]      0.98      0.02      0.99      0.96      1.00   1822.00      1.00
          p[92]      0.99      0.01      0.99      0.98      1.00   1682.74      1.00
          p[93]      0.98      0.02      0.99      0.96      1.00   1822.00      1.00
          p[94]      0.99      0.01      0.99      0.98      1.00   1682.74      1.00
          p[95]      0.99      0.01      0.99      0.98      1.00   1682.74      1.00
          p[96]      0.98      0.02      0.99      0.96      1.00   1630.06      1.00
          p[97]      0.99      0.01      0.99      0.97      1.00   1566.08      1.00
          p[98]      0.98      0.02      0.99      0.96      1.00   1630.06      1.00
          p[99]      0.99      0.01      0.99      0.97      1.00   1566.08      1.00
         p[100]      0.98      0.02      0.99      0.96      1.00   1630.06      1.00
         p[101]      0.99      0.01      0.99      0.97      1.00   1566.08      1.00
         p[102]      0.99      0.01      0.99      0.98      1.00   1526.19      1.00
         p[103]      0.98      0.02      0.99      0.96      1.00   1649.06      1.00
         p[104]      0.99      0.01      0.99      0.98      1.00   1526.19      1.00
         p[105]      0.99      0.01      0.99      0.98      1.00   1526.19      1.00
         p[106]      0.98      0.02      0.99      0.96      1.00   1649.06      1.00
         p[107]      0.98      0.02      0.99      0.96      1.00   1649.06      1.00
         p[108]      0.97      0.03      0.98      0.94      1.00   1654.05      1.00
         p[109]      0.97      0.03      0.98      0.94      1.00   1654.05      1.00
         p[110]      0.97      0.03      0.98      0.94      1.00   1654.05      1.00
         p[111]      0.98      0.02      0.98      0.95      1.00   1657.39      1.00
         p[112]      0.97      0.03      0.98      0.94      1.00   1654.05      1.00
         p[113]      0.97      0.03      0.98      0.94      1.00   1654.05      1.00
         p[114]      0.97      0.03      0.98      0.94      1.00   1654.05      1.00
         p[115]      0.98      0.02      0.98      0.95      1.00   1610.86      1.00
         p[116]      0.99      0.01      0.99      0.97      1.00   1684.39      1.00
         p[117]      0.98      0.02      0.98      0.95      1.00   1610.86      1.00
         p[118]      0.99      0.01      0.99      0.97      1.00   1684.39      1.00
         p[119]      0.99      0.01      0.99      0.97      1.00   1684.39      1.00
         p[120]      0.99      0.01      0.99      0.97      1.00   1684.39      1.00
         p[121]      0.99      0.01      0.99      0.97      1.00   1762.94      1.00
         p[122]      0.99      0.01      0.99      0.97      1.00   1762.94      1.00
         p[123]      0.98      0.02      0.98      0.95      1.00   1758.21      1.00
         p[124]      0.98      0.02      0.98      0.95      1.00   1758.21      1.00
         p[125]      0.99      0.01      0.99      0.97      1.00   1762.94      1.00
         p[126]      0.99      0.01      0.99      0.97      1.00   1762.94      1.00
         p[127]      0.98      0.02      0.98      0.94      1.00   1844.86      1.00
         p[128]      0.99      0.01      0.99      0.97      1.00   1847.53      1.00
         p[129]      0.98      0.02      0.98      0.94      1.00   1844.86      1.00
         p[130]      0.98      0.02      0.98      0.94      1.00   1844.86      1.00
         p[131]      0.99      0.01      0.99      0.97      1.00   1847.53      1.00
         p[132]      0.98      0.02      0.98      0.94      1.00   1844.86      1.00
         p[133]      0.99      0.01      0.99      0.97      1.00   1628.76      1.00
         p[134]      0.99      0.01      0.99      0.97      1.00   1628.76      1.00
         p[135]      0.99      0.01      0.99      0.97      1.00   1628.76      1.00
         p[136]      0.99      0.01      0.99      0.97      1.00   1628.76      1.00
         p[137]      0.97      0.02      0.98      0.94      1.00   1647.90      1.00
         p[138]      0.99      0.01      0.99      0.97      1.00   1628.76      1.00
         p[139]      0.99      0.01      0.99      0.97      1.00   1650.48      1.00
         p[140]      0.98      0.02      0.98      0.95      1.00   1657.39      1.00
         p[141]      0.99      0.01      0.99      0.97      1.00   1650.48      1.00
         p[142]      0.98      0.02      0.98      0.95      1.00   1657.39      1.00
         p[143]      0.99      0.01      0.99      0.97      1.00   1650.48      1.00
         p[144]      0.28      0.07      0.28      0.17      0.40   1746.12      1.00
         p[145]      0.40      0.08      0.40      0.26      0.53   1799.33      1.00
         p[146]      0.40      0.08      0.40      0.26      0.53   1799.33      1.00
         p[147]      0.40      0.08      0.40      0.26      0.53   1799.33      1.00
         p[148]      0.28      0.07      0.28      0.17      0.40   1746.12      1.00
         p[149]      0.28      0.07      0.28      0.17      0.40   1746.12      1.00
         p[150]      0.45      0.08      0.44      0.31      0.58   2476.50      1.00
         p[151]      0.32      0.07      0.32      0.21      0.45   2253.57      1.00
         p[152]      0.45      0.08      0.44      0.31      0.58   2476.50      1.00
         p[153]      0.45      0.08      0.44      0.31      0.58   2476.50      1.00
         p[154]      0.32      0.07      0.32      0.21      0.45   2253.57      1.00
         p[155]      0.32      0.07      0.32      0.21      0.45   2253.57      1.00
         p[156]      0.45      0.08      0.45      0.30      0.57   2695.76      1.00
         p[157]      0.33      0.07      0.32      0.21      0.44   2631.51      1.00
         p[158]      0.33      0.07      0.32      0.21      0.44   2631.51      1.00
         p[159]      0.33      0.07      0.32      0.21      0.44   2631.51      1.00
         p[160]      0.45      0.08      0.45      0.30      0.57   2695.76      1.00
         p[161]      0.45      0.08      0.45      0.30      0.57   2695.76      1.00
         p[162]      0.44      0.08      0.44      0.31      0.57   2470.94      1.00
         p[163]      0.32      0.07      0.31      0.21      0.43   2356.30      1.00
         p[164]      0.32      0.07      0.31      0.21      0.43   2356.30      1.00
         p[165]      0.32      0.07      0.31      0.21      0.43   2356.30      1.00
         p[166]      0.44      0.08      0.44      0.31      0.57   2470.94      1.00
         p[167]      0.44      0.08      0.44      0.31      0.57   2470.94      1.00
         p[168]      0.31      0.07      0.31      0.20      0.43   2383.11      1.00
         p[169]      0.43      0.08      0.43      0.29      0.56   2824.30      1.00
         p[170]      0.43      0.08      0.43      0.29      0.56   2824.30      1.00
         p[171]      0.31      0.07      0.31      0.20      0.43   2383.11      1.00
         p[172]      0.31      0.07      0.31      0.20      0.43   2383.11      1.00
         p[173]      0.43      0.08      0.43      0.29      0.56   2824.30      1.00
         p[174]      0.34      0.08      0.33      0.21      0.46   2124.63      1.00
         p[175]      0.34      0.08      0.33      0.21      0.46   2124.63      1.00
         p[176]      0.46      0.08      0.46      0.32      0.60   2562.13      1.00
         p[177]      0.46      0.08      0.46      0.32      0.60   2562.13      1.00
         p[178]      0.34      0.08      0.33      0.21      0.46   2124.63      1.00
         p[179]      0.46      0.08      0.46      0.32      0.60   2562.13      1.00
         p[180]      0.37      0.08      0.37      0.23      0.50   1693.49      1.00
         p[181]      0.22      0.06      0.22      0.12      0.32   1756.35      1.00
         p[182]      0.37      0.08      0.37      0.23      0.50   1693.49      1.00
         p[183]      0.22      0.06      0.22      0.12      0.32   1756.35      1.00
         p[184]      0.37      0.08      0.37      0.23      0.50   1693.49      1.00
         p[185]      0.22      0.06      0.22      0.12      0.32   1756.35      1.00
         p[186]      0.42      0.08      0.42      0.30      0.55   2457.62      1.00
         p[187]      0.42      0.08      0.42      0.30      0.55   2457.62      1.00
         p[188]      0.26      0.07      0.25      0.15      0.36   2275.67      1.00
         p[189]      0.42      0.08      0.42      0.30      0.55   2457.62      1.00
         p[190]      0.42      0.08      0.42      0.30      0.55   2457.62      1.00
         p[191]      0.42      0.08      0.42      0.30      0.55   2457.62      1.00
         p[192]      0.26      0.06      0.25      0.16      0.36   2535.10      1.00
         p[193]      0.42      0.08      0.42      0.30      0.56   2773.62      1.00
         p[194]      0.26      0.06      0.25      0.16      0.36   2535.10      1.00
         p[195]      0.42      0.08      0.42      0.30      0.56   2773.62      1.00
         p[196]      0.42      0.08      0.42      0.30      0.56   2773.62      1.00
         p[197]      0.26      0.06      0.25      0.16      0.36   2535.10      1.00
         p[198]      0.25      0.06      0.25      0.15      0.35   2703.44      1.00
         p[199]      0.25      0.06      0.25      0.15      0.35   2703.44      1.00
         p[200]      0.25      0.06      0.25      0.15      0.35   2703.44      1.00
         p[201]      0.41      0.08      0.41      0.28      0.54   2539.78      1.00
         p[202]      0.25      0.06      0.25      0.15      0.35   2703.44      1.00
         p[203]      0.25      0.06      0.25      0.15      0.35   2703.44      1.00
         p[204]      0.40      0.08      0.40      0.28      0.54   2557.58      1.00
         p[205]      0.40      0.08      0.40      0.28      0.54   2557.58      1.00
         p[206]      0.24      0.06      0.24      0.14      0.34   2430.97      1.00
         p[207]      0.40      0.08      0.40      0.28      0.54   2557.58      1.00
         p[208]      0.40      0.08      0.40      0.28      0.54   2557.58      1.00
         p[209]      0.40      0.08      0.40      0.28      0.54   2557.58      1.00
         p[210]      0.27      0.07      0.26      0.16      0.37   2202.43      1.00
         p[211]      0.27      0.07      0.26      0.16      0.37   2202.43      1.00
         p[212]      0.27      0.07      0.26      0.16      0.37   2202.43      1.00
         p[213]      0.43      0.08      0.43      0.31      0.57   2530.11      1.00
         p[214]      0.27      0.07      0.26      0.16      0.37   2202.43      1.00
         p[215]      0.27      0.07      0.26      0.16      0.37   2202.43      1.00
         p[216]      0.28      0.07      0.28      0.16      0.39   1935.18      1.00
         p[217]      0.40      0.08      0.39      0.28      0.54   2014.79      1.00
         p[218]      0.28      0.07      0.28      0.16      0.39   1935.18      1.00
         p[219]      0.28      0.07      0.28      0.16      0.39   1935.18      1.00
         p[220]      0.40      0.08      0.39      0.28      0.54   2014.79      1.00
         p[221]      0.40      0.08      0.39      0.28      0.54   2014.79      1.00
         p[222]      0.32      0.07      0.32      0.21      0.44   2377.01      1.00
         p[223]      0.44      0.08      0.44      0.31      0.57   2484.68      1.00
         p[224]      0.32      0.07      0.32      0.21      0.44   2377.01      1.00
         p[225]      0.44      0.08      0.44      0.31      0.57   2484.68      1.00
         p[226]      0.32      0.07      0.32      0.21      0.44   2377.01      1.00
         p[227]      0.44      0.08      0.44      0.31      0.57   2484.68      1.00
         p[228]      0.45      0.08      0.45      0.31      0.56   2325.25      1.00
         p[229]      0.33      0.07      0.32      0.20      0.44   2365.66      1.00
         p[230]      0.45      0.08      0.45      0.31      0.56   2325.25      1.00
         p[231]      0.45      0.08      0.45      0.31      0.56   2325.25      1.00
         p[232]      0.33      0.07      0.32      0.20      0.44   2365.66      1.00
         p[233]      0.33      0.07      0.32      0.20      0.44   2365.66      1.00
         p[234]      0.32      0.07      0.31      0.19      0.42   2561.93      1.00
         p[235]      0.44      0.08      0.44      0.30      0.56   2467.22      1.00
         p[236]      0.32      0.07      0.31      0.19      0.42   2561.93      1.00
         p[237]      0.44      0.08      0.44      0.30      0.56   2467.22      1.00
         p[238]      0.32      0.07      0.31      0.19      0.42   2561.93      1.00
         p[239]      0.44      0.08      0.44      0.30      0.56   2467.22      1.00
         p[240]      0.43      0.08      0.43      0.29      0.54   2580.77      1.00
         p[241]      0.43      0.08      0.43      0.29      0.54   2580.77      1.00
         p[242]      0.31      0.07      0.30      0.19      0.42   2487.87      1.00
         p[243]      0.31      0.07      0.30      0.19      0.42   2487.87      1.00
         p[244]      0.43      0.08      0.43      0.29      0.54   2580.77      1.00
         p[245]      0.31      0.07      0.30      0.19      0.42   2487.87      1.00
         p[246]      0.34      0.08      0.33      0.22      0.47   2147.22      1.00
         p[247]      0.34      0.08      0.33      0.22      0.47   2147.22      1.00
         p[248]      0.46      0.08      0.46      0.31      0.58   2081.71      1.00
         p[249]      0.46      0.08      0.46      0.31      0.58   2081.71      1.00
         p[250]      0.34      0.08      0.33      0.22      0.47   2147.22      1.00
         p[251]      0.46      0.08      0.46      0.31      0.58   2081.71      1.00
         p[252]      0.37      0.08      0.37      0.24      0.50   1574.46      1.00
         p[253]      0.22      0.06      0.22      0.12      0.31   1784.80      1.00
         p[254]      0.37      0.08      0.37      0.24      0.50   1574.46      1.00
         p[255]      0.22      0.06      0.22      0.12      0.31   1784.80      1.00
         p[256]      0.22      0.06      0.22      0.12      0.31   1784.80      1.00
         p[257]      0.22      0.06      0.22      0.12      0.31   1784.80      1.00
         p[258]      0.42      0.08      0.41      0.28      0.54   2386.98      1.00
         p[259]      0.42      0.08      0.41      0.28      0.54   2386.98      1.00
         p[260]      0.25      0.07      0.25      0.14      0.35   2191.08      1.00
         p[261]      0.42      0.08      0.41      0.28      0.54   2386.98      1.00
         p[262]      0.42      0.08      0.41      0.28      0.54   2386.98      1.00
         p[263]      0.42      0.08      0.41      0.28      0.54   2386.98      1.00
         p[264]      0.26      0.07      0.25      0.15      0.36   2238.29      1.00
         p[265]      0.26      0.07      0.25      0.15      0.36   2238.29      1.00
         p[266]      0.42      0.08      0.42      0.29      0.54   2355.10      1.00
         p[267]      0.26      0.07      0.25      0.15      0.36   2238.29      1.00
         p[268]      0.42      0.08      0.42      0.29      0.54   2355.10      1.00
         p[269]      0.42      0.08      0.42      0.29      0.54   2355.10      1.00
         p[270]      0.25      0.06      0.25      0.14      0.34   2583.84      1.00
         p[271]      0.25      0.06      0.25      0.14      0.34   2583.84      1.00
         p[272]      0.25      0.06      0.25      0.14      0.34   2583.84      1.00
         p[273]      0.25      0.06      0.25      0.14      0.34   2583.84      1.00
         p[274]      0.41      0.08      0.41      0.28      0.53   2430.25      1.00
         p[275]      0.25      0.06      0.25      0.14      0.34   2583.84      1.00
         p[276]      0.40      0.08      0.40      0.27      0.52   2302.77      1.00
         p[277]      0.24      0.06      0.24      0.14      0.34   2375.82      1.00
         p[278]      0.40      0.08      0.40      0.27      0.52   2302.77      1.00
         p[279]      0.40      0.08      0.40      0.27      0.52   2302.77      1.00
         p[280]      0.40      0.08      0.40      0.27      0.52   2302.77      1.00
         p[281]      0.40      0.08      0.40      0.27      0.52   2302.77      1.00
         p[282]      0.43      0.08      0.43      0.30      0.56   2054.02      1.00
         p[283]      0.27      0.07      0.26      0.16      0.38   2043.10      1.00
         p[284]      0.27      0.07      0.26      0.16      0.38   2043.10      1.00
         p[285]      0.43      0.08      0.43      0.30      0.56   2054.02      1.00
         p[286]      0.27      0.07      0.26      0.16      0.38   2043.10      1.00
         p[287]      0.27      0.07      0.26      0.16      0.38   2043.10      1.00
         p[288]      0.47      0.08      0.47      0.33      0.61   1758.23      1.00
         p[289]      0.35      0.08      0.34      0.22      0.48   1901.47      1.00
         p[290]      0.35      0.08      0.34      0.22      0.48   1901.47      1.00
         p[291]      0.35      0.08      0.34      0.22      0.48   1901.47      1.00
         p[292]      0.47      0.08      0.47      0.33      0.61   1758.23      1.00
         p[293]      0.47      0.08      0.47      0.33      0.61   1758.23      1.00
         p[294]      0.39      0.07      0.39      0.26      0.50   2924.27      1.00
         p[295]      0.39      0.07      0.39      0.26      0.50   2924.27      1.00
         p[296]      0.52      0.08      0.52      0.40      0.65   2897.19      1.00
         p[297]      0.52      0.08      0.52      0.40      0.65   2897.19      1.00
         p[298]      0.39      0.07      0.39      0.26      0.50   2924.27      1.00
         p[299]      0.52      0.08      0.52      0.40      0.65   2897.19      1.00
         p[300]      0.52      0.08      0.52      0.40      0.65   2571.34      1.00
         p[301]      0.52      0.08      0.52      0.40      0.65   2571.34      1.00
         p[302]      0.39      0.08      0.39      0.28      0.53   2784.91      1.00
         p[303]      0.52      0.08      0.52      0.40      0.65   2571.34      1.00
         p[304]      0.39      0.08      0.39      0.28      0.53   2784.91      1.00
         p[305]      0.39      0.08      0.39      0.28      0.53   2784.91      1.00
         p[306]      0.51      0.08      0.51      0.38      0.64   2886.85      1.00
         p[307]      0.38      0.08      0.38      0.26      0.50   3108.87      1.00
         p[308]      0.51      0.08      0.51      0.38      0.64   2886.85      1.00
         p[309]      0.51      0.08      0.51      0.38      0.64   2886.85      1.00
         p[310]      0.38      0.08      0.38      0.26      0.50   3108.87      1.00
         p[311]      0.38      0.08      0.38      0.26      0.50   3108.87      1.00
         p[312]      0.50      0.08      0.50      0.37      0.64   2847.71      1.00
         p[313]      0.50      0.08      0.50      0.37      0.64   2847.71      1.00
         p[314]      0.50      0.08      0.50      0.37      0.64   2847.71      1.00
         p[315]      0.37      0.07      0.37      0.25      0.49   2713.89      1.00
         p[316]      0.37      0.07      0.37      0.25      0.49   2713.89      1.00
         p[317]      0.37      0.07      0.37      0.25      0.49   2713.89      1.00
         p[318]      0.53      0.08      0.53      0.40      0.67   2639.26      1.00
         p[319]      0.53      0.08      0.53      0.40      0.67   2639.26      1.00
         p[320]      0.40      0.08      0.40      0.27      0.53   2890.94      1.00
         p[321]      0.53      0.08      0.53      0.40      0.67   2639.26      1.00
         p[322]      0.40      0.08      0.40      0.27      0.53   2890.94      1.00
         p[323]      0.40      0.08      0.40      0.27      0.53   2890.94      1.00
         p[324]      0.44      0.08      0.44      0.30      0.58   1693.51      1.00
         p[325]      0.28      0.07      0.27      0.16      0.38   1752.91      1.00
         p[326]      0.44      0.08      0.44      0.30      0.58   1693.51      1.00
         p[327]      0.28      0.07      0.27      0.16      0.38   1752.91      1.00
         p[328]      0.28      0.07      0.27      0.16      0.38   1752.91      1.00
         p[329]      0.44      0.08      0.44      0.30      0.58   1693.51      1.00
         p[330]      0.31      0.07      0.31      0.20      0.43   2771.67      1.00
         p[331]      0.49      0.08      0.49      0.37      0.62   2681.39      1.00
         p[332]      0.31      0.07      0.31      0.20      0.43   2771.67      1.00
         p[333]      0.49      0.08      0.49      0.37      0.62   2681.39      1.00
         p[334]      0.31      0.07      0.31      0.20      0.43   2771.67      1.00
         p[335]      0.49      0.08      0.49      0.37      0.62   2681.39      1.00
         p[336]      0.32      0.07      0.31      0.19      0.42   2694.66      1.00
         p[337]      0.49      0.08      0.49      0.36      0.62   2569.06      1.00
         p[338]      0.49      0.08      0.49      0.36      0.62   2569.06      1.00
         p[339]      0.32      0.07      0.31      0.19      0.42   2694.66      1.00
         p[340]      0.32      0.07      0.31      0.19      0.42   2694.66      1.00
         p[341]      0.49      0.08      0.49      0.36      0.62   2569.06      1.00
         p[342]      0.48      0.08      0.48      0.35      0.61   2871.36      1.00
         p[343]      0.48      0.08      0.48      0.35      0.61   2871.36      1.00
         p[344]      0.31      0.07      0.30      0.19      0.41   2968.49      1.00
         p[345]      0.31      0.07      0.30      0.19      0.41   2968.49      1.00
         p[346]      0.31      0.07      0.30      0.19      0.41   2968.49      1.00
         p[347]      0.48      0.08      0.48      0.35      0.61   2871.36      1.00
         p[348]      0.30      0.07      0.30      0.20      0.41   2872.66      1.00
         p[349]      0.47      0.08      0.47      0.35      0.61   2934.44      1.00
         p[350]      0.47      0.08      0.47      0.35      0.61   2934.44      1.00
         p[351]      0.30      0.07      0.30      0.20      0.41   2872.66      1.00
         p[352]      0.30      0.07      0.30      0.20      0.41   2872.66      1.00
         p[353]      0.30      0.07      0.30      0.20      0.41   2872.66      1.00
         p[354]      0.50      0.08      0.51      0.36      0.62   2469.97      1.00
         p[355]      0.50      0.08      0.51      0.36      0.62   2469.97      1.00
         p[356]      0.33      0.07      0.32      0.21      0.45   2547.21      1.00
         p[357]      0.33      0.07      0.32      0.21      0.45   2547.21      1.00
         p[358]      0.50      0.08      0.51      0.36      0.62   2469.97      1.00
         p[359]      0.50      0.08      0.51      0.36      0.62   2469.97      1.00
         p[360]      0.69      0.07      0.70      0.57      0.81   2114.05      1.00
         p[361]      0.57      0.08      0.57      0.43      0.70   1900.77      1.00
         p[362]      0.57      0.08      0.57      0.43      0.70   1900.77      1.00
         p[363]      0.69      0.07      0.70      0.57      0.81   2114.05      1.00
         p[364]      0.57      0.08      0.57      0.43      0.70   1900.77      1.00
         p[365]      0.69      0.07      0.70      0.57      0.81   2114.05      1.00
         p[366]      0.73      0.06      0.73      0.63      0.84   2586.84      1.00
         p[367]      0.73      0.06      0.73      0.63      0.84   2586.84      1.00
         p[368]      0.73      0.06      0.73      0.63      0.84   2586.84      1.00
         p[369]      0.62      0.08      0.62      0.50      0.75   2515.63      1.00
         p[370]      0.62      0.08      0.62      0.50      0.75   2515.63      1.00
         p[371]      0.62      0.08      0.62      0.50      0.75   2515.63      1.00
         p[372]      0.62      0.08      0.62      0.50      0.75   2639.47      1.00
         p[373]      0.62      0.08      0.62      0.50      0.75   2639.47      1.00
         p[374]      0.62      0.08      0.62      0.50      0.75   2639.47      1.00
         p[375]      0.73      0.06      0.74      0.63      0.84   2526.04      1.00
         p[376]      0.73      0.06      0.74      0.63      0.84   2526.04      1.00
         p[377]      0.73      0.06      0.74      0.63      0.84   2526.04      1.00
         p[378]      0.61      0.08      0.61      0.50      0.75   2639.28      1.00
         p[379]      0.73      0.07      0.73      0.63      0.84   2703.81      1.00
         p[380]      0.61      0.08      0.61      0.50      0.75   2639.28      1.00
         p[381]      0.73      0.07      0.73      0.63      0.84   2703.81      1.00
         p[382]      0.61      0.08      0.61      0.50      0.75   2639.28      1.00
         p[383]      0.73      0.07      0.73      0.63      0.84   2703.81      1.00
         p[384]      0.72      0.07      0.72      0.61      0.83   2712.26      1.00
         p[385]      0.60      0.08      0.60      0.47      0.72   2395.59      1.00
         p[386]      0.60      0.08      0.60      0.47      0.72   2395.59      1.00
         p[387]      0.72      0.07      0.72      0.61      0.83   2712.26      1.00
         p[388]      0.60      0.08      0.60      0.47      0.72   2395.59      1.00
         p[389]      0.72      0.07      0.72      0.61      0.83   2712.26      1.00
         p[390]      0.63      0.08      0.63      0.50      0.76   2257.84      1.00
         p[391]      0.63      0.08      0.63      0.50      0.76   2257.84      1.00
         p[392]      0.74      0.06      0.75      0.64      0.85   2206.09      1.00
         p[393]      0.74      0.06      0.75      0.64      0.85   2206.09      1.00
         p[394]      0.74      0.06      0.75      0.64      0.85   2206.09      1.00
         p[395]      0.63      0.08      0.63      0.50      0.76   2257.84      1.00
         p[396]      0.67      0.08      0.67      0.54      0.79   1727.15      1.00
         p[397]      0.49      0.09      0.49      0.36      0.64   2115.58      1.00
         p[398]      0.67      0.08      0.67      0.54      0.79   1727.15      1.00
         p[399]      0.67      0.08      0.67      0.54      0.79   1727.15      1.00
         p[400]      0.49      0.09      0.49      0.36      0.64   2115.58      1.00
         p[401]      0.49      0.09      0.49      0.36      0.64   2115.58      1.00
         p[402]      0.54      0.08      0.54      0.41      0.68   2730.54      1.00
         p[403]      0.54      0.08      0.54      0.41      0.68   2730.54      1.00
         p[404]      0.71      0.06      0.71      0.60      0.81   2638.90      1.00
         p[405]      0.71      0.06      0.71      0.60      0.81   2638.90      1.00
         p[406]      0.71      0.06      0.71      0.60      0.81   2638.90      1.00
         p[407]      0.71      0.06      0.71      0.60      0.81   2638.90      1.00
         p[408]      0.71      0.07      0.71      0.61      0.82   2725.68      1.00
         p[409]      0.71      0.07      0.71      0.61      0.82   2725.68      1.00
         p[410]      0.54      0.08      0.54      0.41      0.67   2777.35      1.00
         p[411]      0.71      0.07      0.71      0.61      0.82   2725.68      1.00
         p[412]      0.54      0.08      0.54      0.41      0.67   2777.35      1.00
         p[413]      0.54      0.08      0.54      0.41      0.67   2777.35      1.00
         p[414]      0.53      0.08      0.53      0.40      0.67   2957.59      1.00
         p[415]      0.53      0.08      0.53      0.40      0.67   2957.59      1.00
         p[416]      0.70      0.07      0.71      0.59      0.81   2588.76      1.00
         p[417]      0.70      0.07      0.71      0.59      0.81   2588.76      1.00
         p[418]      0.53      0.08      0.53      0.40      0.67   2957.59      1.00
         p[419]      0.70      0.07      0.71      0.59      0.81   2588.76      1.00
         p[420]      0.69      0.07      0.70      0.59      0.81   2374.09      1.00
         p[421]      0.69      0.07      0.70      0.59      0.81   2374.09      1.00
         p[422]      0.52      0.08      0.52      0.38      0.64   2711.30      1.00
         p[423]      0.52      0.08      0.52      0.38      0.64   2711.30      1.00
         p[424]      0.52      0.08      0.52      0.38      0.64   2711.30      1.00
         p[425]      0.69      0.07      0.70      0.59      0.81   2374.09      1.00
         p[426]      0.55      0.08      0.55      0.42      0.68   2299.49      1.00
         p[427]      0.55      0.08      0.55      0.42      0.68   2299.49      1.00
         p[428]      0.72      0.06      0.72      0.62      0.83   2217.09      1.00
         p[429]      0.55      0.08      0.55      0.42      0.68   2299.49      1.00
         p[430]      0.72      0.06      0.72      0.62      0.83   2217.09      1.00
         p[431]      0.55      0.08      0.55      0.42      0.68   2299.49      1.00
         p[432]      0.91      0.04      0.91      0.86      0.97   2269.88      1.00
         p[433]      0.85      0.05      0.86      0.77      0.94   2163.04      1.00
         p[434]      0.85      0.05      0.86      0.77      0.94   2163.04      1.00
         p[435]      0.91      0.04      0.91      0.86      0.97   2269.88      1.00
         p[436]      0.91      0.04      0.91      0.86      0.97   2269.88      1.00
         p[437]      0.85      0.05      0.86      0.77      0.94   2163.04      1.00
         p[438]      0.88      0.04      0.88      0.81      0.95   2341.62      1.00
         p[439]      0.88      0.04      0.88      0.81      0.95   2341.62      1.00
         p[440]      0.92      0.03      0.93      0.88      0.97   2519.72      1.00
         p[441]      0.88      0.04      0.88      0.81      0.95   2341.62      1.00
         p[442]      0.92      0.03      0.93      0.88      0.97   2519.72      1.00
         p[443]      0.92      0.03      0.93      0.88      0.97   2519.72      1.00
         p[444]      0.92      0.03      0.93      0.88      0.97   2419.00      1.00
         p[445]      0.92      0.03      0.93      0.88      0.97   2419.00      1.00
         p[446]      0.88      0.04      0.88      0.81      0.95   2404.52      1.00
         p[447]      0.88      0.04      0.88      0.81      0.95   2404.52      1.00
         p[448]      0.88      0.04      0.88      0.81      0.95   2404.52      1.00
         p[449]      0.92      0.03      0.93      0.88      0.97   2419.00      1.00
         p[450]      0.87      0.05      0.88      0.80      0.95   2505.14      1.00
         p[451]      0.92      0.03      0.92      0.87      0.97   2639.06      1.00
         p[452]      0.87      0.05      0.88      0.80      0.95   2505.14      1.00
         p[453]      0.87      0.05      0.88      0.80      0.95   2505.14      1.00
         p[454]      0.92      0.03      0.92      0.87      0.97   2639.06      1.00
         p[455]      0.92      0.03      0.92      0.87      0.97   2639.06      1.00
         p[456]      0.92      0.03      0.92      0.87      0.97   2601.86      1.00
         p[457]      0.87      0.05      0.87      0.80      0.94   2523.09      1.00
         p[458]      0.87      0.05      0.87      0.80      0.94   2523.09      1.00
         p[459]      0.87      0.05      0.87      0.80      0.94   2523.09      1.00
         p[460]      0.92      0.03      0.92      0.87      0.97   2601.86      1.00
         p[461]      0.92      0.03      0.92      0.87      0.97   2601.86      1.00
         p[462]      0.93      0.03      0.93      0.88      0.97   2352.84      1.00
         p[463]      0.88      0.04      0.89      0.82      0.95   2293.24      1.00
         p[464]      0.88      0.04      0.89      0.82      0.95   2293.24      1.00
         p[465]      0.88      0.04      0.89      0.82      0.95   2293.24      1.00
         p[466]      0.93      0.03      0.93      0.88      0.97   2352.84      1.00
         p[467]      0.93      0.03      0.93      0.88      0.97   2352.84      1.00
         p[468]      0.90      0.04      0.90      0.83      0.96   1995.58      1.00
         p[469]      0.81      0.06      0.81      0.71      0.91   2026.24      1.00
         p[470]      0.90      0.04      0.90      0.83      0.96   1995.58      1.00
         p[471]      0.81      0.06      0.81      0.71      0.91   2026.24      1.00
         p[472]      0.90      0.04      0.90      0.83      0.96   1995.58      1.00
         p[473]      0.90      0.04      0.90      0.83      0.96   1995.58      1.00
         p[474]      0.91      0.03      0.92      0.86      0.97   2346.70      1.00
         p[475]      0.83      0.06      0.84      0.74      0.92   2353.38      1.00
         p[476]      0.91      0.03      0.92      0.86      0.97   2346.70      1.00
         p[477]      0.83      0.06      0.84      0.74      0.92   2353.38      1.00
         p[478]      0.91      0.03      0.92      0.86      0.97   2346.70      1.00
         p[479]      0.83      0.06      0.84      0.74      0.92   2353.38      1.00
         p[480]      0.84      0.05      0.84      0.75      0.93   2276.64      1.00
         p[481]      0.91      0.03      0.92      0.87      0.96   2326.03      1.00
         p[482]      0.91      0.03      0.92      0.87      0.96   2326.03      1.00
         p[483]      0.84      0.05      0.84      0.75      0.93   2276.64      1.00
         p[484]      0.84      0.05      0.84      0.75      0.93   2276.64      1.00
         p[485]      0.91      0.03      0.92      0.87      0.96   2326.03      1.00
         p[486]      0.83      0.05      0.84      0.75      0.92   2346.18      1.00
         p[487]      0.83      0.05      0.84      0.75      0.92   2346.18      1.00
         p[488]      0.91      0.03      0.92      0.86      0.96   2338.71      1.00
         p[489]      0.83      0.05      0.84      0.75      0.92   2346.18      1.00
         p[490]      0.83      0.05      0.84      0.75      0.92   2346.18      1.00
         p[491]      0.83      0.05      0.84      0.75      0.92   2346.18      1.00
         p[492]      0.91      0.04      0.91      0.85      0.96   2416.22      1.00
         p[493]      0.83      0.06      0.83      0.73      0.92   2339.84      1.00
         p[494]      0.83      0.06      0.83      0.73      0.92   2339.84      1.00
         p[495]      0.91      0.04      0.91      0.85      0.96   2416.22      1.00
         p[496]      0.91      0.04      0.91      0.85      0.96   2416.22      1.00
         p[497]      0.91      0.04      0.91      0.85      0.96   2416.22      1.00
         p[498]      0.92      0.03      0.92      0.87      0.97   2208.57      1.00
         p[499]      0.92      0.03      0.92      0.87      0.97   2208.57      1.00
         p[500]      0.92      0.03      0.92      0.87      0.97   2208.57      1.00
         p[501]      0.84      0.05      0.85      0.76      0.93   2181.58      1.00
         p[502]      0.84      0.05      0.85      0.76      0.93   2181.58      1.00
         p[503]      0.84      0.05      0.85      0.76      0.93   2181.58      1.00
        sigma_a      2.04      0.64      1.93      1.06      2.99    735.09      1.01
        sigma_g      0.20      0.17      0.16      0.00      0.43    826.68      1.00
     z_block[0]     -0.69      0.91     -0.70     -2.20      0.83   1893.75      1.00
     z_block[1]      0.19      0.87      0.19     -1.20      1.65   2602.41      1.00
     z_block[2]      0.19      0.86      0.24     -1.18      1.64   2341.04      1.00
     z_block[3]      0.03      0.84      0.02     -1.46      1.31   1999.61      1.00
     z_block[4]     -0.13      0.84     -0.15     -1.56      1.19   2511.07      1.00
     z_block[5]      0.44      0.87      0.46     -0.91      1.94   2164.78      1.00

Number of divergences: 0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_62_5.png" src="../_images/notebooks_13_models_with_memory_62_5.png" />
</div>
</div>
</section>
<section id="Code-13.30">
<h3>Code 13.30<a class="headerlink" href="#Code-13.30" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neff_c</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">effective_sample_size</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mcmc_13_4</span><span class="o">.</span><span class="n">get_samples</span><span class="p">(</span><span class="n">group_by_chain</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">neff_nc</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">effective_sample_size</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mcmc_13_4nc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">(</span><span class="n">group_by_chain</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">par_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">keys_c</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_g&quot;</span><span class="p">]</span>
<span class="n">keys_nc</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;z_block&quot;</span><span class="p">,</span> <span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_g&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_c</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">neff_c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">par_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">par_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neff_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
<span class="n">neff_c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">neff_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_c</span><span class="p">])</span>
<span class="n">neff_nc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">neff_nc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_nc</span><span class="p">])</span>
<span class="n">neff_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">neff_c</span><span class="o">=</span><span class="n">neff_c</span><span class="p">,</span> <span class="n">neff_nc</span><span class="o">=</span><span class="n">neff_nc</span><span class="p">))</span>
<span class="n">neff_table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">par_names</span>
<span class="n">neff_table</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>neff_c</th>
      <th>neff_nc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>b_treatment[0]</th>
      <td>346.0</td>
      <td>988.0</td>
    </tr>
    <tr>
      <th>b_treatment[1]</th>
      <td>322.0</td>
      <td>1069.0</td>
    </tr>
    <tr>
      <th>b_treatment[2]</th>
      <td>373.0</td>
      <td>1098.0</td>
    </tr>
    <tr>
      <th>b_treatment[3]</th>
      <td>329.0</td>
      <td>1065.0</td>
    </tr>
    <tr>
      <th>a[0]</th>
      <td>329.0</td>
      <td>1119.0</td>
    </tr>
    <tr>
      <th>a[1]</th>
      <td>501.0</td>
      <td>1616.0</td>
    </tr>
    <tr>
      <th>a[2]</th>
      <td>334.0</td>
      <td>1256.0</td>
    </tr>
    <tr>
      <th>a[3]</th>
      <td>323.0</td>
      <td>1119.0</td>
    </tr>
    <tr>
      <th>a[4]</th>
      <td>337.0</td>
      <td>1201.0</td>
    </tr>
    <tr>
      <th>a[5]</th>
      <td>329.0</td>
      <td>1252.0</td>
    </tr>
    <tr>
      <th>a[6]</th>
      <td>408.0</td>
      <td>1540.0</td>
    </tr>
    <tr>
      <th>g[0]</th>
      <td>322.0</td>
      <td>1894.0</td>
    </tr>
    <tr>
      <th>g[1]</th>
      <td>627.0</td>
      <td>2602.0</td>
    </tr>
    <tr>
      <th>g[2]</th>
      <td>713.0</td>
      <td>2341.0</td>
    </tr>
    <tr>
      <th>g[3]</th>
      <td>692.0</td>
      <td>2000.0</td>
    </tr>
    <tr>
      <th>g[4]</th>
      <td>785.0</td>
      <td>2511.0</td>
    </tr>
    <tr>
      <th>g[5]</th>
      <td>496.0</td>
      <td>2165.0</td>
    </tr>
    <tr>
      <th>a_bar</th>
      <td>734.0</td>
      <td>434.0</td>
    </tr>
    <tr>
      <th>sigma_a</th>
      <td>523.0</td>
      <td>735.0</td>
    </tr>
    <tr>
      <th>sigma_g</th>
      <td>199.0</td>
      <td>827.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-13.31">
<h3>Code 13.31<a class="headerlink" href="#Code-13.31" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">actors</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">treatments</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">blocks</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">posterior_predictive_13_4</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">mcmc_13_4</span><span class="o">.</span><span class="n">get_samples</span><span class="p">())</span>
<span class="n">posterior_predictive_samples_13_4</span> <span class="o">=</span> <span class="n">posterior_predictive_13_4</span><span class="p">(</span>
    <span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">actor</span><span class="o">=</span><span class="n">actors</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="n">treatments</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">pulled_left</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
<span class="n">p_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">posterior_predictive_samples_13_4</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p_hpdi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">posterior_predictive_samples_13_4</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">p_mu</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">p_hpdi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p_hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x73ee11900a70&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_66_1.png" src="../_images/notebooks_13_models_with_memory_66_1.png" />
</div>
</div>
</section>
<section id="Code-13.32">
<h3>Code 13.32<a class="headerlink" href="#Code-13.32" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_13_4</span> <span class="o">=</span> <span class="n">mcmc_13_4</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_13_4</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;a&#39;: Array([-0.71510213,  7.32739828, -0.37870871, -0.6179993 , -0.34887882],      dtype=float64),
 &#39;a_bar&#39;: Array([ 1.46111947,  1.96014229,  2.21581003, -0.93247181, -0.19024935],      dtype=float64),
 &#39;b_treatment&#39;: Array([-0.17541539,  0.638745  , -0.82825929,  0.52302882,  0.01894794],      dtype=float64),
 &#39;g&#39;: Array([-0.3431927 , -0.00430556,  0.26356074, -0.24206806,  0.15480698],      dtype=float64),
 &#39;p&#39;: Array([0.22553271, 0.22553271, 0.39662448, 0.22553271, 0.39662448],      dtype=float64),
 &#39;sigma_a&#39;: Array([3.01784332, 2.30700334, 2.54231007, 2.0770246 , 2.95038645],      dtype=float64),
 &#39;sigma_g&#39;: Array([0.45736211, 0.52444785, 0.24090456, 0.18780988, 0.47831993],      dtype=float64)}
</pre></div></div>
</div>
</section>
<section id="Code-13.33">
<h3>Code 13.33<a class="headerlink" href="#Code-13.33" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][:,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: &gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_70_1.png" src="../_images/notebooks_13_models_with_memory_70_1.png" />
</div>
</div>
</section>
<section id="Code-13.34">
<h3>Code 13.34<a class="headerlink" href="#Code-13.34" title="Link to this heading">Â¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">p_link</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span>
        <span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][:,</span> <span class="n">actor</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">][:,</span> <span class="n">block</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">][:,</span> <span class="n">treatment</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-13.35">
<h3>Code 13.35<a class="headerlink" href="#Code-13.35" title="Link to this heading">Â¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_raw</span> <span class="o">=</span> <span class="n">p_link</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">actors</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>
<span class="n">p_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p_hpdi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-13.36">
<h3>Code 13.36<a class="headerlink" href="#Code-13.36" title="Link to this heading">Â¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">p_link_abar</span><span class="p">(</span><span class="n">treatment</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span>
        <span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">][:,</span> <span class="n">treatment</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-13.37">
<h3>Code 13.37<a class="headerlink" href="#Code-13.37" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">treatments</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">p_raw</span> <span class="o">=</span> <span class="n">p_link_abar</span><span class="p">(</span><span class="n">treatments</span><span class="p">)</span>
<span class="n">p_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p_hpdi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion pulled left&quot;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">treatments</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">p_mu</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">p_hpdi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p_hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x73ee0f1e9f10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_78_1.png" src="../_images/notebooks_13_models_with_memory_78_1.png" />
</div>
</div>
</section>
<section id="Code-13.38">
<h3>Code 13.38<a class="headerlink" href="#Code-13.38" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_sim</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
    <span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">],</span> <span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">p_link_asim</span><span class="p">(</span><span class="n">treatment</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span>
        <span class="n">a_sim</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">posterior_samples_13_4</span><span class="p">[</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">][:,</span> <span class="n">treatment</span><span class="p">]</span>
    <span class="p">)</span>


<span class="n">p_raw</span> <span class="o">=</span> <span class="n">p_link_asim</span><span class="p">(</span><span class="n">treatments</span><span class="p">)</span>
<span class="n">p_mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p_hpdi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion pulled left&quot;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">treatments</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">p_mu</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">p_hpdi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p_hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x73ee0d328b60&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_80_1.png" src="../_images/notebooks_13_models_with_memory_80_1.png" />
</div>
</div>
</section>
<section id="Code-13.39">
<h3>Code 13.39<a class="headerlink" href="#Code-13.39" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion pulled left&quot;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">treatments</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">p_raw</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_82_0.png" src="../_images/notebooks_13_models_with_memory_82_0.png" />
</div>
</div>
</section>
</section>
<section id="Easy">
<h2>Easy<a class="headerlink" href="#Easy" title="Link to this heading">Â¶</a></h2>
<section id="13E1">
<h3>13E1<a class="headerlink" href="#13E1" title="Link to this heading">Â¶</a></h3>
<ol class="loweralpha simple">
<li></li>
</ol>
</section>
<section id="13E2">
<h3>13E2<a class="headerlink" href="#13E2" title="Link to this heading">Â¶</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
y_i &amp; \sim Binom(1, p_i) \\
logit(p_i) = \alpha_{group[i]} + \beta x_i \\
\alpha_{group[i]} &amp; \sim \mathcal{N}(\bar{\alpha}, \sigma) \\
\beta &amp; \sim \mathcal{N}(0, 1) \\
\bar{\alpha} &amp; \sim \mathcal{N}(0, 10) \\
\sigma &amp; \sim Exp(1)
\end{align*}\end{split}\]</div>
</section>
<section id="13E3">
<h3>13E3<a class="headerlink" href="#13E3" title="Link to this heading">Â¶</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
y_i &amp; \sim \mathcal{N}(\mu_i, \sigma)  \\
\mu_i &amp; =  \alpha_{group[i]} + \beta x_i \\
\alpha_{group[i]} &amp; \sim \mathcal{N}(\bar{\alpha}, \sigma_{\bar{\alpha}}) \\
\beta &amp; \sim \mathcal{N}(0, 1) \\
\bar{\alpha} &amp; \sim \mathcal{N}(0, 10) \\
\sigma_{\bar{\alpha}} &amp; \sim Exp(1) \\
\sigma &amp; \sim HalfCauchy(0, 2)
\end{align*}\end{split}\]</div>
</section>
<section id="13E4">
<h3>13E4<a class="headerlink" href="#13E4" title="Link to this heading">Â¶</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
fishcaught &amp; \sim Poisson(\lambda_i) \\
log(\lambda_i) &amp; = \alpha_{country[i]} + \gamma_{agegroup[i]} + \beta Persons + \log(\tau_i) \\
\alpha_{country[i]} &amp; \sim \mathcal{N}(\bar{\alpha}, \sigma_{\bar{\alpha}}) \\
\gamma_{agegroup[i]} &amp; \sim \mathcal{N}(0, \sigma_{\bar{\gamma}}) \\
\bar{\alpha} &amp; \sim \mathcal{N}(0, 10) \\
\sigma_{\bar{\alpha}} &amp; \sim Exp(1) \\
\sigma_{\bar{\gamma}} &amp; \sim Exp(1)
\end{align*}\end{split}\]</div>
</section>
</section>
<section id="Medium">
<h2>Medium<a class="headerlink" href="#Medium" title="Link to this heading">Â¶</a></h2>
<section id="13M1">
<h3>13M1<a class="headerlink" href="#13M1" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/reedfrogs.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;pred&quot;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]]</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s2">&quot;big&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;tank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>density</th>
      <th>pred</th>
      <th>size</th>
      <th>surv</th>
      <th>propsurv</th>
      <th>tank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>0</td>
      <td>1</td>
      <td>9</td>
      <td>0.900000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1.000000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10</td>
      <td>0</td>
      <td>1</td>
      <td>7</td>
      <td>0.700000</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1.000000</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>0.900000</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>10</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>0.900000</td>
      <td>5</td>
    </tr>
    <tr>
      <th>6</th>
      <td>10</td>
      <td>0</td>
      <td>0</td>
      <td>10</td>
      <td>1.000000</td>
      <td>6</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10</td>
      <td>0</td>
      <td>0</td>
      <td>9</td>
      <td>0.900000</td>
      <td>7</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>0.400000</td>
      <td>8</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>9</td>
      <td>0.900000</td>
      <td>9</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>7</td>
      <td>0.700000</td>
      <td>10</td>
    </tr>
    <tr>
      <th>11</th>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
      <td>0.600000</td>
      <td>11</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10</td>
      <td>1</td>
      <td>0</td>
      <td>7</td>
      <td>0.700000</td>
      <td>12</td>
    </tr>
    <tr>
      <th>13</th>
      <td>10</td>
      <td>1</td>
      <td>0</td>
      <td>5</td>
      <td>0.500000</td>
      <td>13</td>
    </tr>
    <tr>
      <th>14</th>
      <td>10</td>
      <td>1</td>
      <td>0</td>
      <td>9</td>
      <td>0.900000</td>
      <td>14</td>
    </tr>
    <tr>
      <th>15</th>
      <td>10</td>
      <td>1</td>
      <td>0</td>
      <td>9</td>
      <td>0.900000</td>
      <td>15</td>
    </tr>
    <tr>
      <th>16</th>
      <td>25</td>
      <td>0</td>
      <td>1</td>
      <td>24</td>
      <td>0.960000</td>
      <td>16</td>
    </tr>
    <tr>
      <th>17</th>
      <td>25</td>
      <td>0</td>
      <td>1</td>
      <td>23</td>
      <td>0.920000</td>
      <td>17</td>
    </tr>
    <tr>
      <th>18</th>
      <td>25</td>
      <td>0</td>
      <td>1</td>
      <td>22</td>
      <td>0.880000</td>
      <td>18</td>
    </tr>
    <tr>
      <th>19</th>
      <td>25</td>
      <td>0</td>
      <td>1</td>
      <td>25</td>
      <td>1.000000</td>
      <td>19</td>
    </tr>
    <tr>
      <th>20</th>
      <td>25</td>
      <td>0</td>
      <td>0</td>
      <td>23</td>
      <td>0.920000</td>
      <td>20</td>
    </tr>
    <tr>
      <th>21</th>
      <td>25</td>
      <td>0</td>
      <td>0</td>
      <td>23</td>
      <td>0.920000</td>
      <td>21</td>
    </tr>
    <tr>
      <th>22</th>
      <td>25</td>
      <td>0</td>
      <td>0</td>
      <td>23</td>
      <td>0.920000</td>
      <td>22</td>
    </tr>
    <tr>
      <th>23</th>
      <td>25</td>
      <td>0</td>
      <td>0</td>
      <td>21</td>
      <td>0.840000</td>
      <td>23</td>
    </tr>
    <tr>
      <th>24</th>
      <td>25</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
      <td>0.240000</td>
      <td>24</td>
    </tr>
    <tr>
      <th>25</th>
      <td>25</td>
      <td>1</td>
      <td>1</td>
      <td>13</td>
      <td>0.520000</td>
      <td>25</td>
    </tr>
    <tr>
      <th>26</th>
      <td>25</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>0.160000</td>
      <td>26</td>
    </tr>
    <tr>
      <th>27</th>
      <td>25</td>
      <td>1</td>
      <td>1</td>
      <td>9</td>
      <td>0.360000</td>
      <td>27</td>
    </tr>
    <tr>
      <th>28</th>
      <td>25</td>
      <td>1</td>
      <td>0</td>
      <td>13</td>
      <td>0.520000</td>
      <td>28</td>
    </tr>
    <tr>
      <th>29</th>
      <td>25</td>
      <td>1</td>
      <td>0</td>
      <td>20</td>
      <td>0.800000</td>
      <td>29</td>
    </tr>
    <tr>
      <th>30</th>
      <td>25</td>
      <td>1</td>
      <td>0</td>
      <td>8</td>
      <td>0.320000</td>
      <td>30</td>
    </tr>
    <tr>
      <th>31</th>
      <td>25</td>
      <td>1</td>
      <td>0</td>
      <td>10</td>
      <td>0.400000</td>
      <td>31</td>
    </tr>
    <tr>
      <th>32</th>
      <td>35</td>
      <td>0</td>
      <td>1</td>
      <td>34</td>
      <td>0.971429</td>
      <td>32</td>
    </tr>
    <tr>
      <th>33</th>
      <td>35</td>
      <td>0</td>
      <td>1</td>
      <td>33</td>
      <td>0.942857</td>
      <td>33</td>
    </tr>
    <tr>
      <th>34</th>
      <td>35</td>
      <td>0</td>
      <td>1</td>
      <td>33</td>
      <td>0.942857</td>
      <td>34</td>
    </tr>
    <tr>
      <th>35</th>
      <td>35</td>
      <td>0</td>
      <td>1</td>
      <td>31</td>
      <td>0.885714</td>
      <td>35</td>
    </tr>
    <tr>
      <th>36</th>
      <td>35</td>
      <td>0</td>
      <td>0</td>
      <td>31</td>
      <td>0.885714</td>
      <td>36</td>
    </tr>
    <tr>
      <th>37</th>
      <td>35</td>
      <td>0</td>
      <td>0</td>
      <td>35</td>
      <td>1.000000</td>
      <td>37</td>
    </tr>
    <tr>
      <th>38</th>
      <td>35</td>
      <td>0</td>
      <td>0</td>
      <td>33</td>
      <td>0.942857</td>
      <td>38</td>
    </tr>
    <tr>
      <th>39</th>
      <td>35</td>
      <td>0</td>
      <td>0</td>
      <td>32</td>
      <td>0.914286</td>
      <td>39</td>
    </tr>
    <tr>
      <th>40</th>
      <td>35</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>0.114286</td>
      <td>40</td>
    </tr>
    <tr>
      <th>41</th>
      <td>35</td>
      <td>1</td>
      <td>1</td>
      <td>12</td>
      <td>0.342857</td>
      <td>41</td>
    </tr>
    <tr>
      <th>42</th>
      <td>35</td>
      <td>1</td>
      <td>1</td>
      <td>13</td>
      <td>0.371429</td>
      <td>42</td>
    </tr>
    <tr>
      <th>43</th>
      <td>35</td>
      <td>1</td>
      <td>1</td>
      <td>14</td>
      <td>0.400000</td>
      <td>43</td>
    </tr>
    <tr>
      <th>44</th>
      <td>35</td>
      <td>1</td>
      <td>0</td>
      <td>22</td>
      <td>0.628571</td>
      <td>44</td>
    </tr>
    <tr>
      <th>45</th>
      <td>35</td>
      <td>1</td>
      <td>0</td>
      <td>12</td>
      <td>0.342857</td>
      <td>45</td>
    </tr>
    <tr>
      <th>46</th>
      <td>35</td>
      <td>1</td>
      <td>0</td>
      <td>31</td>
      <td>0.885714</td>
      <td>46</td>
    </tr>
    <tr>
      <th>47</th>
      <td>35</td>
      <td>1</td>
      <td>0</td>
      <td>17</td>
      <td>0.485714</td>
      <td>47</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_factory</span><span class="p">(</span><span class="n">has_pred</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">has_size</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">has_interaction</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tank</span><span class="p">,</span> <span class="n">surv</span><span class="p">):</span>
        <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;tank&quot;</span><span class="p">,</span> <span class="mi">48</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>
        <span class="n">logit_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">tank</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">has_pred</span><span class="p">:</span>
            <span class="n">b_pred</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_pred&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">logit_p</span> <span class="o">+=</span> <span class="n">b_pred</span> <span class="o">*</span> <span class="n">pred</span>
        <span class="k">if</span> <span class="n">has_size</span><span class="p">:</span>
            <span class="n">b_size</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_size&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">logit_p</span> <span class="o">+=</span> <span class="n">b_size</span> <span class="o">*</span> <span class="n">size</span>
        <span class="k">if</span> <span class="n">has_interaction</span><span class="p">:</span>
            <span class="n">b_interaction</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_interaction&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">logit_p</span> <span class="o">+=</span> <span class="n">b_interaction</span> <span class="o">*</span> <span class="n">size</span> <span class="o">*</span> <span class="n">pred</span>

        <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
        <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;surv&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit_p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">surv</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>


<span class="n">mcmc_13m1_none</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span>
    <span class="n">NUTS</span><span class="p">(</span><span class="n">model_factory</span><span class="p">(</span><span class="n">has_pred</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
    <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mcmc_13m1_pred</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span>
    <span class="n">NUTS</span><span class="p">(</span><span class="n">model_factory</span><span class="p">(</span><span class="n">has_pred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
    <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mcmc_13m1_size</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span>
    <span class="n">NUTS</span><span class="p">(</span><span class="n">model_factory</span><span class="p">(</span><span class="n">has_pred</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
    <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mcmc_13m1_both</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span>
    <span class="n">NUTS</span><span class="p">(</span><span class="n">model_factory</span><span class="p">(</span><span class="n">has_pred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
    <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mcmc_13m1_interaction</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span>
    <span class="n">NUTS</span><span class="p">(</span><span class="n">model_factory</span><span class="p">(</span><span class="n">has_pred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_interaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
    <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mcmcs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="n">mcmc_13m1_none</span><span class="p">,</span>
    <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">mcmc_13m1_pred</span><span class="p">,</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">mcmc_13m1_size</span><span class="p">,</span>
    <span class="s2">&quot;both&quot;</span><span class="p">:</span> <span class="n">mcmc_13m1_both</span><span class="p">,</span>
    <span class="s2">&quot;interaction&quot;</span><span class="p">:</span> <span class="n">mcmc_13m1_interaction</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;density&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;tank&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tank&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;surv&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;surv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mcmc</span> <span class="ow">in</span> <span class="n">mcmcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6bbf4420b4ba49d7ad532f93945a0495", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "08f8e7d48ff64051a2a5614f84bbca8a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "05da0b9e4ab749a7a6f10f4c29151102", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "02052021b62e4e689551c1e9d214bc47", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "85b3578ba60c42f9a129b3c284a86e99", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "01023678be584ee9944e8f4804ec7269", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1fe6d00c229b4b13be58c96d1c8d04a9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8d6bc313c4da4180913cd9748ad8a378", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ab686b49922c4cf98cf5d78da2f0ab1a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "072173a9e2484c8e9d35a62c96c433e6", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0d8cbdf8e7974022842f6f87f258812c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1101db7636e740c3aca71b5047e97f13", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9da43dd4b46e48529d800c3007ed5260", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0b12cd3f646043c2b574bbb700530a17", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d062989da2f540fbb26d8b5037f1f7eb", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8ea409cb36b047ed978339207476778b", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cff2e723872b4a04b9e19170d21b1e20", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a52c24dd429e486ca8be1d784c2bbe3c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a122512c033c499a8d4e94e87dbc31d3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "224811b50b7243a68d3da4ec71231477", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s1">&#39;sigma_a&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mcmc</span> <span class="ow">in</span> <span class="n">mcmcs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
none           1.62
pred           0.82
size           1.61
both           0.78
interaction    0.74
dtype: object
</pre></div></div>
</div>
<p>Adding predictors reduce the need for <code class="docutils literal notranslate"><span class="pre">sigma_a</span></code> to capture variation accross tanks. In theory, if we had all the predictors, we wouldnât need multi level model.</p>
</section>
<section id="13M2">
<h3>13M2<a class="headerlink" href="#13M2" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mcmc</span> <span class="ow">in</span> <span class="n">mcmcs</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;waic&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_waic</th>
      <th>p_waic</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pred</th>
      <td>0</td>
      <td>-99.381421</td>
      <td>19.114837</td>
      <td>0.000000</td>
      <td>0.390966</td>
      <td>4.627337</td>
      <td>0.000000</td>
      <td>True</td>
      <td>log</td>
    </tr>
    <tr>
      <th>interaction</th>
      <td>1</td>
      <td>-99.759412</td>
      <td>19.026455</td>
      <td>0.377991</td>
      <td>0.243859</td>
      <td>4.717428</td>
      <td>1.633434</td>
      <td>True</td>
      <td>log</td>
    </tr>
    <tr>
      <th>none</th>
      <td>2</td>
      <td>-99.908876</td>
      <td>20.801456</td>
      <td>0.527455</td>
      <td>0.365175</td>
      <td>3.690200</td>
      <td>3.006671</td>
      <td>True</td>
      <td>log</td>
    </tr>
    <tr>
      <th>size</th>
      <td>3</td>
      <td>-100.116305</td>
      <td>21.004682</td>
      <td>0.734884</td>
      <td>0.000000</td>
      <td>3.674867</td>
      <td>2.873022</td>
      <td>True</td>
      <td>log</td>
    </tr>
    <tr>
      <th>both</th>
      <td>4</td>
      <td>-100.353438</td>
      <td>19.609777</td>
      <td>0.972017</td>
      <td>0.000000</td>
      <td>4.392856</td>
      <td>1.147543</td>
      <td>True</td>
      <td>log</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)),</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;b_pred&quot;</span><span class="p">,</span> <span class="s2">&quot;b_size&quot;</span><span class="p">,</span> <span class="s2">&quot;b_interaction&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mcmc</span> <span class="ow">in</span> <span class="n">mcmcs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;b_pred&quot;</span><span class="p">,</span> <span class="s2">&quot;b_size&quot;</span><span class="p">,</span> <span class="s2">&quot;b_interaction&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>none</th>
      <th>pred</th>
      <th>size</th>
      <th>both</th>
      <th>interaction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>b_pred</th>
      <td>nan</td>
      <td>-2.47</td>
      <td>nan</td>
      <td>-2.47</td>
      <td>-1.98</td>
    </tr>
    <tr>
      <th>b_size</th>
      <td>nan</td>
      <td>nan</td>
      <td>-0.40</td>
      <td>-0.48</td>
      <td>0.14</td>
    </tr>
    <tr>
      <th>b_interaction</th>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>-1.06</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Size doesnât matter</p>
</section>
<section id="13M3">
<h3>13M3<a class="headerlink" href="#13M3" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13m3</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">tank</span><span class="p">,</span> <span class="n">surv</span><span class="p">):</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;tank&quot;</span><span class="p">,</span> <span class="mi">48</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Cauchy</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>
    <span class="n">logit_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">tank</span><span class="p">]</span>

    <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;surv&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit_p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">surv</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;density&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;tank&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tank&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;surv&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;surv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13m3</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13m3</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13m3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b463b53435a046f99e0ef918099fbf7c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cfb2e0e43e0f411ba3cd22bc0162fd7b", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "05b0be57333640bf8b3a95a12dceb06c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "404599a10e5c46fc9c883dd76d514d8d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcmc_13m1_none</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;cauchy&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mcmc_13m3</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">result</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;cauchy&quot;</span><span class="p">]</span>
<span class="n">result</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: &gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_95_1.png" src="../_images/notebooks_13_models_with_memory_95_1.png" />
</div>
</div>
<p>Most of the time, the two are close, but the cauchy prior is comfortable with more extreme values. However, since weâre using a logit link, prob doesnât make a huge difference anyways: in probability space, we converge to 1.</p>
</section>
<section id="13M4">
<h3>13M4<a class="headerlink" href="#13M4" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/chimpanzees.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;prosoc_left&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
      <th>treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>499</th>
      <td>7</td>
      <td>4.0</td>
      <td>1</td>
      <td>6</td>
      <td>64</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>500</th>
      <td>7</td>
      <td>6.0</td>
      <td>1</td>
      <td>6</td>
      <td>66</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>501</th>
      <td>7</td>
      <td>3.0</td>
      <td>1</td>
      <td>6</td>
      <td>68</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>502</th>
      <td>7</td>
      <td>7.0</td>
      <td>1</td>
      <td>6</td>
      <td>70</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>503</th>
      <td>7</td>
      <td>2.0</td>
      <td>1</td>
      <td>6</td>
      <td>72</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
<p>504 rows Ã 9 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13m4</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">pulled_left</span><span class="p">):</span>
    <span class="c1"># hyper-priors</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">gamma_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;gamma_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">sigma_g</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_g&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># adaptive priors</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">reparam</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">reparam</span><span class="o">.</span><span class="n">LocScaleReparam</span><span class="p">(</span><span class="mi">0</span><span class="p">)}</span>
    <span class="p">):</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;actor&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">z_block</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;z_block&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">gamma_bar</span> <span class="o">+</span> <span class="n">z_block</span> <span class="o">*</span> <span class="n">sigma_g</span><span class="p">)</span>

    <span class="c1"># old fashioned priors</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">b_treatment</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_treatment&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="c1"># likelihood</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">actor</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_treatment</span><span class="p">[</span><span class="n">treatment</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">pulled_left</span><span class="p">)</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;treatment&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;block&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;pulled_left&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13m4</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13m4</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13m4</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">idata_13m4</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13m4</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span>
    <span class="n">idata_13m4</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma_bar&quot;</span><span class="p">],</span>
    <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;rank_bars&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "480aadf6bd6540a8b1993b09555882b5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d928caad4234461d9cb0bf9a36cd073f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7e6c64742dd744b9a565f2a3687629d1", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9bb3d6fc35e148bf91e82b5580760224", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_99_4.png" src="../_images/notebooks_13_models_with_memory_99_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_sample_13m4</span> <span class="o">=</span> <span class="n">mcmc_13m4</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">posterior_sample_13m4</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterior_sample_13m4</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x73ee25b848f0&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_100_1.png" src="../_images/notebooks_13_models_with_memory_100_1.png" />
</div>
</div>
<p>alpha and gammaa bar canât be separated, we can only know their sum.</p>
</section>
</section>
<section id="Hard">
<h2>Hard<a class="headerlink" href="#Hard" title="Link to this heading">Â¶</a></h2>
<section id="13H1">
<h3>13H1<a class="headerlink" href="#13H1" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/bangladesh.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>woman</th>
      <th>district</th>
      <th>use.contraception</th>
      <th>living.children</th>
      <th>age.centered</th>
      <th>urban</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>18.4400</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>-5.5599</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>1.4400</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>8.4400</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>-13.5590</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1929</th>
      <td>1930</td>
      <td>61</td>
      <td>0</td>
      <td>4</td>
      <td>14.4400</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1930</th>
      <td>1931</td>
      <td>61</td>
      <td>0</td>
      <td>3</td>
      <td>-4.5599</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1931</th>
      <td>1932</td>
      <td>61</td>
      <td>0</td>
      <td>4</td>
      <td>14.4400</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1932</th>
      <td>1933</td>
      <td>61</td>
      <td>0</td>
      <td>1</td>
      <td>-13.5600</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1933</th>
      <td>1934</td>
      <td>61</td>
      <td>0</td>
      <td>4</td>
      <td>10.4400</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>1934 rows Ã 6 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;district&quot;</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array([1, 2], dtype=int64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;district_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;district&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">codes</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>woman</th>
      <th>district</th>
      <th>use.contraception</th>
      <th>living.children</th>
      <th>age.centered</th>
      <th>urban</th>
      <th>district_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>18.4400</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>-5.5599</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>1.4400</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>8.4400</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>-13.5590</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1929</th>
      <td>1930</td>
      <td>61</td>
      <td>0</td>
      <td>4</td>
      <td>14.4400</td>
      <td>0</td>
      <td>59</td>
    </tr>
    <tr>
      <th>1930</th>
      <td>1931</td>
      <td>61</td>
      <td>0</td>
      <td>3</td>
      <td>-4.5599</td>
      <td>0</td>
      <td>59</td>
    </tr>
    <tr>
      <th>1931</th>
      <td>1932</td>
      <td>61</td>
      <td>0</td>
      <td>4</td>
      <td>14.4400</td>
      <td>0</td>
      <td>59</td>
    </tr>
    <tr>
      <th>1932</th>
      <td>1933</td>
      <td>61</td>
      <td>0</td>
      <td>1</td>
      <td>-13.5600</td>
      <td>0</td>
      <td>59</td>
    </tr>
    <tr>
      <th>1933</th>
      <td>1934</td>
      <td>61</td>
      <td>0</td>
      <td>4</td>
      <td>10.4400</td>
      <td>0</td>
      <td>59</td>
    </tr>
  </tbody>
</table>
<p>1934 rows Ã 7 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13h1a</span><span class="p">(</span><span class="n">district_id</span><span class="p">,</span> <span class="n">use_contraception</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;district&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">logit_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">district_id</span><span class="p">]</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;use_contraception&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">logit_p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">use_contraception</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">model_13h1b</span><span class="p">(</span><span class="n">district_id</span><span class="p">,</span> <span class="n">use_contraception</span><span class="p">):</span>
    <span class="n">a_bar</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a_bar&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;district&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">))</span>

    <span class="n">logit_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">district_id</span><span class="p">]</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;use_contraception&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">logit_p</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">use_contraception</span>
    <span class="p">)</span>


<span class="n">mcmc_13h1a</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13h1a</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13h1b</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13h1b</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;district_id&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;district_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;use_contraception&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;use.contraception&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13h1a</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">mcmc_13h1b</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">idata_13h1a</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13h1a</span><span class="p">)</span>
<span class="n">idata_13h1b</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13h1b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "69b5c736f13d46e788eb78ccf953e08f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6d3b3ce341304e5cb581bfe8c270cce5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bfed86e378f84a2fa82114e6f077f3b7", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "eef90575b2ca4fc9a52e3de2b5f2f2af", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2d739e4b61df4d898406b2c9286b2aca", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4d996c073c9e469b8748f6a370c296af", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c6e938d5ad7f42cc8da887f7846963e9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1744ac2868aa44c1b2490e86d9dcaaab", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">district_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<span class="n">posterior_predictive_samples_13h1a</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model_13h1a</span><span class="p">,</span> <span class="n">mcmc_13h1a</span><span class="o">.</span><span class="n">get_samples</span><span class="p">())(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">district_id</span><span class="o">=</span><span class="n">district_ids</span><span class="p">,</span> <span class="n">use_contraception</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_13h1b</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model_13h1b</span><span class="p">,</span> <span class="n">mcmc_13h1b</span><span class="o">.</span><span class="n">get_samples</span><span class="p">())(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">district_id</span><span class="o">=</span><span class="n">district_ids</span><span class="p">,</span> <span class="n">use_contraception</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>

<span class="n">p_mu_13h1a</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">posterior_predictive_samples_13h1a</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p_hpdi_13h1a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
    <span class="n">posterior_predictive_samples_13h1a</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
<span class="p">)</span>
<span class="n">p_mu_13h1b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">posterior_predictive_samples_13h1b</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p_hpdi_13h1b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span>
    <span class="n">posterior_predictive_samples_13h1b</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;district&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion use contraception&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">district_ids</span><span class="p">,</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;district_id&quot;</span><span class="p">)[</span><span class="s2">&quot;use.contraception&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(),</span>
    <span class="s2">&quot;x&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;observed&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">district_ids</span><span class="p">,</span> <span class="n">p_mu_13h1a</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;no pooling&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">district_ids</span><span class="p">,</span> <span class="n">p_hpdi_13h1a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p_hpdi_13h1a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">district_ids</span><span class="p">,</span> <span class="n">p_mu_13h1b</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;partial pooling&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">district_ids</span><span class="p">,</span> <span class="n">p_hpdi_13h1b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p_hpdi_13h1b</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x73ee0671fb60&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_107_1.png" src="../_images/notebooks_13_models_with_memory_107_1.png" />
</div>
</div>
<p>Partial pooling is more regularizing, pulling values towards the mean. Most extreme cases of disagrement occur when the observed value is extreme (near 1 or near 0). Partial pooling model regularizes harder.</p>
</section>
<section id="13H2">
<h3>13H2<a class="headerlink" href="#13H2" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/Trolley.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">codes</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>case</th>
      <th>response</th>
      <th>order</th>
      <th>id</th>
      <th>age</th>
      <th>male</th>
      <th>edu</th>
      <th>action</th>
      <th>intention</th>
      <th>contact</th>
      <th>story</th>
      <th>action2</th>
      <th>pid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>cfaqu</td>
      <td>4</td>
      <td>2</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>aqu</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cfbur</td>
      <td>3</td>
      <td>31</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>bur</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cfrub</td>
      <td>4</td>
      <td>16</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>rub</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cibox</td>
      <td>3</td>
      <td>32</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>box</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cibur</td>
      <td>3</td>
      <td>4</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>bur</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9925</th>
      <td>ilpon</td>
      <td>3</td>
      <td>23</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>pon</td>
      <td>0</td>
      <td>330</td>
    </tr>
    <tr>
      <th>9926</th>
      <td>ilsha</td>
      <td>6</td>
      <td>15</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>sha</td>
      <td>0</td>
      <td>330</td>
    </tr>
    <tr>
      <th>9927</th>
      <td>ilshi</td>
      <td>7</td>
      <td>7</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>shi</td>
      <td>0</td>
      <td>330</td>
    </tr>
    <tr>
      <th>9928</th>
      <td>ilswi</td>
      <td>2</td>
      <td>18</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>swi</td>
      <td>0</td>
      <td>330</td>
    </tr>
    <tr>
      <th>9929</th>
      <td>nfrub</td>
      <td>2</td>
      <td>17</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>rub</td>
      <td>1</td>
      <td>330</td>
    </tr>
  </tbody>
</table>
<p>9930 rows Ã 13 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13h2a</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">contact</span><span class="p">,</span> <span class="n">intention</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>

    <span class="n">cutpoints</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;cutpoints&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">6</span><span class="p">]),</span> <span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">OrderedTransform</span><span class="p">()</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">b_action</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_action&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b_contact</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_contact&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b_intention</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_intention&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="n">b_action</span> <span class="o">*</span> <span class="n">action</span> <span class="o">+</span> <span class="n">b_contact</span> <span class="o">*</span> <span class="n">contact</span> <span class="o">+</span> <span class="n">b_intention</span> <span class="o">*</span> <span class="n">intention</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">OrderedLogistic</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">cutpoints</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">response</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span> <span class="nf">model_13h2b</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">contact</span><span class="p">,</span> <span class="n">intention</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>

    <span class="n">cutpoints</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;cutpoints&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">6</span><span class="p">]),</span> <span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">OrderedTransform</span><span class="p">()</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="mi">331</span><span class="p">):</span>
        <span class="n">z_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;z_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">z_a</span> <span class="o">*</span> <span class="n">sigma_a</span><span class="p">)</span>
    <span class="n">b_action</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_action&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b_contact</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_contact&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b_intention</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_intention&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;phi&quot;</span><span class="p">,</span>
        <span class="n">a</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_action</span> <span class="o">*</span> <span class="n">action</span> <span class="o">+</span> <span class="n">b_contact</span> <span class="o">*</span> <span class="n">contact</span> <span class="o">+</span> <span class="n">b_intention</span> <span class="o">*</span> <span class="n">intention</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">OrderedLogistic</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">cutpoints</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">response</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="n">mcmc_13h2a</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13h2a</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc_13h2b</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13h2b</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">training_data_a</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;contact&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;contact&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;intention&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;intention&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">training_data_b</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;contact&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;contact&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;intention&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;intention&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13h2a</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="o">**</span><span class="n">training_data_a</span><span class="p">)</span>
<span class="n">mcmc_13h2b</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="o">**</span><span class="n">training_data_b</span><span class="p">)</span>
<span class="n">idata_13h2a</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13h2a</span><span class="p">)</span>
<span class="n">idata_13h2b</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13h2b</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span>
    <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s2">&quot;mcmc_13h2a&quot;</span><span class="p">:</span> <span class="n">idata_13h2a</span><span class="p">,</span> <span class="s2">&quot;mcmc_13h2b&quot;</span><span class="p">:</span> <span class="n">idata_13h2b</span><span class="p">},</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d0d29f4582b1471e934a267a981be00d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "493f8df296c04166a0f46088e4e57396", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bcb79c6b54854473b5f792f986a94d03", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7def1eba11fc4df68431051c0e1e849d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "80be38dd0d854e689a317bc2cc9d3d93", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d92d372a0fcb4ddbbf6770e27259e2c5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b3fdc7a75711482cb8d61ae3888e252d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bc24bf82c7bf4f009be8377d3be9c684", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Model comparison\nlower is better&#39;}, xlabel=&#39;elpd_loo (deviance)&#39;, ylabel=&#39;ranked models&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_111_9.png" src="../_images/notebooks_13_models_with_memory_111_9.png" />
</div>
</div>
<p>There is a lot of variation between individuals, so modelling it greatly improves prediction</p>
</section>
<section id="13H3">
<h3>13H3<a class="headerlink" href="#13H3" title="Link to this heading">Â¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/Trolley.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">codes</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;story_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;story&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">codes</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>case</th>
      <th>response</th>
      <th>order</th>
      <th>id</th>
      <th>age</th>
      <th>male</th>
      <th>edu</th>
      <th>action</th>
      <th>intention</th>
      <th>contact</th>
      <th>story</th>
      <th>action2</th>
      <th>pid</th>
      <th>story_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>cfaqu</td>
      <td>4</td>
      <td>2</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>aqu</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cfbur</td>
      <td>3</td>
      <td>31</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>bur</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cfrub</td>
      <td>4</td>
      <td>16</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>rub</td>
      <td>1</td>
      <td>0</td>
      <td>7</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cibox</td>
      <td>3</td>
      <td>32</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>box</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cibur</td>
      <td>3</td>
      <td>4</td>
      <td>96;434</td>
      <td>14</td>
      <td>0</td>
      <td>Middle School</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>bur</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9925</th>
      <td>ilpon</td>
      <td>3</td>
      <td>23</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>pon</td>
      <td>0</td>
      <td>330</td>
      <td>6</td>
    </tr>
    <tr>
      <th>9926</th>
      <td>ilsha</td>
      <td>6</td>
      <td>15</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>sha</td>
      <td>0</td>
      <td>330</td>
      <td>8</td>
    </tr>
    <tr>
      <th>9927</th>
      <td>ilshi</td>
      <td>7</td>
      <td>7</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>shi</td>
      <td>0</td>
      <td>330</td>
      <td>9</td>
    </tr>
    <tr>
      <th>9928</th>
      <td>ilswi</td>
      <td>2</td>
      <td>18</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>swi</td>
      <td>0</td>
      <td>330</td>
      <td>11</td>
    </tr>
    <tr>
      <th>9929</th>
      <td>nfrub</td>
      <td>2</td>
      <td>17</td>
      <td>98;299</td>
      <td>66</td>
      <td>1</td>
      <td>Graduate Degree</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>rub</td>
      <td>1</td>
      <td>330</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
<p>9930 rows Ã 14 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13h3</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">story_id</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">contact</span><span class="p">,</span> <span class="n">intention</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>

    <span class="n">cutpoints</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;cutpoints&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">6</span><span class="p">]),</span> <span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">OrderedTransform</span><span class="p">()</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="mi">331</span><span class="p">):</span>
        <span class="n">z_a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;z_a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">z_a</span> <span class="o">*</span> <span class="n">sigma_a</span><span class="p">)</span>
    <span class="n">sigma_story</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma_story&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;story_id&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span>
        <span class="n">z_story</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;z_story&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">a_story</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;story&quot;</span><span class="p">,</span> <span class="n">z_story</span> <span class="o">*</span> <span class="n">sigma_story</span><span class="p">)</span>
    <span class="n">b_action</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_action&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b_contact</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_contact&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b_intention</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b_intention&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;phi&quot;</span><span class="p">,</span>
        <span class="n">a</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">a_story</span><span class="p">[</span><span class="n">story_id</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">b_action</span> <span class="o">*</span> <span class="n">action</span>
        <span class="o">+</span> <span class="n">b_contact</span> <span class="o">*</span> <span class="n">contact</span>
        <span class="o">+</span> <span class="n">b_intention</span> <span class="o">*</span> <span class="n">intention</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">OrderedLogistic</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">cutpoints</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">response</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="n">mcmc_13h3</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">NUTS</span><span class="p">(</span><span class="n">model_13h3</span><span class="p">),</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">training_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;story_id&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;story_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;contact&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;contact&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;intention&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;intention&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mcmc_13h3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="o">**</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">idata_13h3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_numpyro</span><span class="p">(</span><span class="n">mcmc_13h3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3a6efa56bf7743d5bf213d545e3cce48", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ea273390747a4122be6238a625c4c749", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d574bd0a40324b2fb373fe795c7e263e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2b39d45e511745c3a1063194afed3ab3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span>
    <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;mcmc_13h2b&quot;</span><span class="p">:</span> <span class="n">idata_13h2b</span><span class="p">,</span> <span class="s2">&quot;mcmc_13h3&quot;</span><span class="p">:</span> <span class="n">idata_13h3</span><span class="p">},</span>
        <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span>
        <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;waic&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Model comparison\nlower is better&#39;}, xlabel=&#39;elpd_waic (deviance)&#39;, ylabel=&#39;ranked models&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_13_models_with_memory_116_2.png" src="../_images/notebooks_13_models_with_memory_116_2.png" />
</div>
</div>
<p>Variation among stories is meaningful, and help us explain variability further.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">

          <div class="sidebar-resize-handle"></div>

<h3><a href="../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="02_small_and_large_worlds.html">Chapter 2: Small Worlds And Large Worlds</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_sampling_the_imaginary.html">Chapter 3: Sampling the Imaginary</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_geocentric_models.html">Chapter 4: Geocentric Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_the_many_variables_and_the_spurious_waffles.html">Chapter 5: The Many Variables And The Spurious Waffles</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_the_haunted_dag_and_the_causal_terror.html">Chapter 6: The Haunted DAG &amp; The Causal Terror</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_ulysse_s_copmpass.html">Chapter 7: Ulysseâs Compass</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_conditional_manatees.html">Chapter 8: Conditional Manatees</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_markov_chain_monte_carlo.html">Chapter 9: Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_big_entropy_and_the_generalized_linear_model.html">Chapter 10: Big Entropy and the Generalized Linear Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_god_spiked_the_integers.html">Chapter 11: God Spiked the Integers</a></li>
<li class="toctree-l1"><a class="reference internal" href="12_monsters_and_mixtures.html">Chapter 12: Monsters and Mixtures</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Chapter 13: Models With Memory</a></li>
</ul>

<div><hr class="docutils"></div>
<ul>
  <li class="toctree-l1"><a class="reference internal" href="../genindex.html" accesskey="I">General Index</a></li>
</ul>
<div id="ethical-ad-placement"></div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <nav class="relbar">
      <a class="previous" href="12_monsters_and_mixtures.html" aria-label="Previous topic" >
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>
        </div>
        <div class="title">
          <span class="text">
            <span class="direction">previous</span>
            Chapter 12: Monsters and Mixtures
          </span>
        </div>
      </a>
    </nav>

    <footer role="contentinfo">
      &#169; Copyright 2022, Ludovic Tiako.
      Created using <a class="reference external" href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
      <a class="reference external" href="https://insipid-sphinx-theme.readthedocs.io/">Insipid Theme</a>.
    </footer>
  </body>
</html>