<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Chapter 7: Ulysse’s Compass &#8212; Statistical Rethinking</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/insipid.css?v=b2d00be7" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

    <script src="../_static/documentation_options.js?v=63867087"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script defer src="../_static/insipid.js"></script>
    <script defer src="../_static/insipid-sidebar.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Chapter 8: Conditional Manatees" href="08_conditional_manatees.html" />
    <link rel="prev" title="Chapter 6: The Haunted DAG &amp; The Causal Terror" href="06_the_haunted_dag_and_the_causal_terror.html" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
  </head><body>
    <script type="text/javascript">
        document.body.classList.add('js');
    </script>
    <input type="checkbox" id="sidebar-checkbox" style="display: none;">
    <label id="overlay" for="sidebar-checkbox"></label>
    <div class="sidebar-resize-handle"></div>
    <script type="text/javascript">
        try {
            let sidebar = localStorage.getItem('sphinx-sidebar');
            const sidebar_width = localStorage.getItem('sphinx-sidebar-width');
            if (sidebar_width) {
                document.documentElement.style.setProperty('--sidebar-width', sidebar_width);
            }
            // show sidebar on wide screen
            if (!sidebar && window.matchMedia('(min-width: 100rem)').matches) {
                sidebar = 'visible';
                // NB: We don't store the value in localStorage!
            }
            if (sidebar === 'visible') {
                document.getElementById('sidebar-checkbox').checked = true;
            }
        } catch(e) {
            console.info(e);
        }
    </script>
    <header id="topbar-placeholder">
      <div id="topbar">
        <div id="titlebar">
          <div class="buttons">
            <label for="sidebar-checkbox" id="sidebar-button" role="button" tabindex="0" aria-controls="sphinxsidebar" accesskey="M">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>
            </label>
            <button id="search-button" type="button" title="Search" aria-label="Search" aria-expanded="false" aria-controls="search-form" accesskey="S">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
            </button>
          </div>
          <div class="title">
            <a class="parent" href="../index.html" accesskey="U">Statistical Rethinking</a>
            <a class="top" href="#">Chapter 7: Ulysse’s Compass</a>
          </div>
          <div class="buttons">
            <button id="fullscreen-button" type="button" aria-hidden="true">
              <span class="enable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M212.686 315.314L120 408l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C10.697 480 0 469.255 0 456V344c0-21.382 25.803-32.09 40.922-16.971L72 360l92.686-92.686c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.249 6.248 6.249 16.378 0 22.627zm22.628-118.628L328 104l-32.922-31.029C279.958 57.851 290.666 32 312.048 32h112C437.303 32 448 42.745 448 56v112c0 21.382-25.803 32.09-40.922 16.971L376 152l-92.686 92.686c-6.248 6.248-16.379 6.248-22.627 0l-25.373-25.373c-6.249-6.248-6.249-16.378 0-22.627z"/></svg>
              </span>
              <span class="disable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M4.686 427.314L104 328l-32.922-31.029C55.958 281.851 66.666 256 88.048 256h112C213.303 256 224 266.745 224 280v112c0 21.382-25.803 32.09-40.922 16.971L152 376l-99.314 99.314c-6.248 6.248-16.379 6.248-22.627 0L4.686 449.941c-6.248-6.248-6.248-16.379 0-22.627zM443.314 84.686L344 184l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C234.697 256 224 245.255 224 232V120c0-21.382 25.803-32.09 40.922-16.971L296 136l99.314-99.314c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.248 6.248 6.248 16.379 0 22.627z"/></svg>
              </span>
            </button>
          </div>
        </div>
        <div id="searchbox" role="search">
          <form id="search-form" class="search" style="display: none" action="../search.html" method="get">
            <input type="search" name="q" placeholder="Search ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <button>Go</button>
          </form>
        </div>
      </div>
    </header>
    <nav>
      <a href="06_the_haunted_dag_and_the_causal_terror.html" class="nav-icon previous" title="previous:&#13;Chapter 6: The Haunted DAG &amp; The Causal Terror" aria-label="Previous topic" accesskey="P" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6 0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>
      </a>
      <a href="08_conditional_manatees.html" class="nav-icon next" title="next:&#13;Chapter 8: Conditional Manatees" aria-label="Next topic" accesskey="N" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg>
      </a>
    </nav>

    <nav class="relbar">
      <a class="previous" href="06_the_haunted_dag_and_the_causal_terror.html" aria-label="Previous topic" >
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>
        </div>
        <div class="title">
          <span class="text">
            <span class="direction">previous</span>
            Chapter 6: The Haunted DAG &amp; The Causal Terror
          </span>
        </div>
      </a>
      <a class="next" href="08_conditional_manatees.html" aria-label="Next topic" >
        <div class="title">
          <span class="text">
            <span class="direction">next</span>
            Chapter 8: Conditional Manatees
          </span>
        </div>
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"/></svg>
        </div>
      </a>
    </nav>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<section id="Chapter-7:-Ulysse's-Compass">
<h1>Chapter 7: Ulysse’s Compass<a class="headerlink" href="#Chapter-7:-Ulysse's-Compass" title="Link to this heading">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> jupyter_black

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="kn">from</span> <span class="nn">jax.scipy.special</span> <span class="kn">import</span> <span class="n">logsumexp</span>
<span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">SVI</span>
<span class="kn">from</span> <span class="nn">numpyro.infer.autoguide</span> <span class="kn">import</span> <span class="n">AutoLaplaceApproximation</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">84735</span>
<span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

<span class="n">optim</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:jax._src.xla_bridge:An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">depth</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Code">
<h2>Code<a class="headerlink" href="#Code" title="Link to this heading">¶</a></h2>
<section id="Code-7.1">
<h3>Code 7.1<a class="headerlink" href="#Code-7.1" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;afarensis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;africanus&quot;</span><span class="p">,</span>
            <span class="s2">&quot;habilis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;boisei&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rudolfensis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ergaster&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sapiens&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;brain&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">438</span><span class="p">,</span> <span class="mi">452</span><span class="p">,</span> <span class="mi">612</span><span class="p">,</span> <span class="mi">521</span><span class="p">,</span> <span class="mi">752</span><span class="p">,</span> <span class="mi">871</span><span class="p">,</span> <span class="mi">1350</span><span class="p">],</span>
        <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">37.0</span><span class="p">,</span> <span class="mf">35.5</span><span class="p">,</span> <span class="mf">34.5</span><span class="p">,</span> <span class="mf">41.5</span><span class="p">,</span> <span class="mf">55.5</span><span class="p">,</span> <span class="mf">61.0</span><span class="p">,</span> <span class="mf">53.5</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>species</th>
      <th>brain</th>
      <th>mass</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>afarensis</td>
      <td>438</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>africanus</td>
      <td>452</td>
      <td>35.5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>habilis</td>
      <td>612</td>
      <td>34.5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>boisei</td>
      <td>521</td>
      <td>41.5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>rudolfensis</td>
      <td>752</td>
      <td>55.5</td>
    </tr>
    <tr>
      <th>5</th>
      <td>ergaster</td>
      <td>871</td>
      <td>61.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>sapiens</td>
      <td>1350</td>
      <td>53.5</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-7.2">
<h3>Code 7.2<a class="headerlink" href="#Code-7.2" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-7.3">
<h3>Code 7.3<a class="headerlink" href="#Code-7.3" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_7_1</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">brain</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">brain</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;brain&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">brain</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">brain</span>


<span class="n">guide_7_1</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_7_1</span><span class="p">)</span>
<span class="n">svi_7_1</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_7_1</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide_7_1</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">mass</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">brain</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="o">=</span><span class="mi">2_500</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">posterior_samples_7_1</span> <span class="o">=</span> <span class="n">guide_7_1</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_7_1</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_500</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_7_1</span><span class="p">),</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████████████| 2500/2500 [00:00&lt;00:00, 2777.19it/s, init loss: 39.9668, avg. loss [2376-2500]: 8.7021]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.53      0.07      0.53      0.42      0.63  10570.15      1.00
         b      0.17      0.07      0.17      0.05      0.29  10475.57      1.00
     sigma      0.19      0.06      0.18      0.10      0.27   9272.35      1.00

</pre></div></div>
</div>
</section>
<section id="Code-7.4">
<h3>Code 7.4<a class="headerlink" href="#Code-7.4" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_7_1_OLS</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># posterior_samples_7_1_OLS = dist.Normal(model_7_1_OLS.params[&#39;brain&#39;],</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-7.5">
<h3>Code 7.5<a class="headerlink" href="#Code-7.5" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">residuals_7_1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">posterior_samples_7_1</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;predictions_7_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posterior_samples_7_1</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;residuals_7_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">residuals_7_1</span>
<span class="n">r2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;residuals_7_1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R2: </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>species</th>
      <th>brain</th>
      <th>mass</th>
      <th>mass_std</th>
      <th>brain_std</th>
      <th>predictions_7_1</th>
      <th>residuals_7_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>afarensis</td>
      <td>438</td>
      <td>37.0</td>
      <td>-0.779467</td>
      <td>0.324444</td>
      <td>0.396795</td>
      <td>-0.072350</td>
    </tr>
    <tr>
      <th>1</th>
      <td>africanus</td>
      <td>452</td>
      <td>35.5</td>
      <td>-0.917020</td>
      <td>0.334815</td>
      <td>0.373456</td>
      <td>-0.038641</td>
    </tr>
    <tr>
      <th>2</th>
      <td>habilis</td>
      <td>612</td>
      <td>34.5</td>
      <td>-1.008722</td>
      <td>0.453333</td>
      <td>0.357896</td>
      <td>0.095437</td>
    </tr>
    <tr>
      <th>3</th>
      <td>boisei</td>
      <td>521</td>
      <td>41.5</td>
      <td>-0.366808</td>
      <td>0.385926</td>
      <td>0.466812</td>
      <td>-0.080886</td>
    </tr>
    <tr>
      <th>4</th>
      <td>rudolfensis</td>
      <td>752</td>
      <td>55.5</td>
      <td>0.917020</td>
      <td>0.557037</td>
      <td>0.684645</td>
      <td>-0.127608</td>
    </tr>
    <tr>
      <th>5</th>
      <td>ergaster</td>
      <td>871</td>
      <td>61.0</td>
      <td>1.421380</td>
      <td>0.645185</td>
      <td>0.770222</td>
      <td>-0.125037</td>
    </tr>
    <tr>
      <th>6</th>
      <td>sapiens</td>
      <td>1350</td>
      <td>53.5</td>
      <td>0.733616</td>
      <td>1.000000</td>
      <td>0.653526</td>
      <td>0.346474</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
R2: 0.49004324784641295
</pre></div></div>
</div>
</section>
<section id="Code-7.6">
<h3>Code 7.6<a class="headerlink" href="#Code-7.6" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">r2_is_bad</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">):</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">posterior_samples</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">residuals</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>


<span class="n">r2_is_bad</span><span class="p">(</span><span class="n">posterior_samples_7_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.49004324784641295
</pre></div></div>
</div>
</section>
<section id="Code-7.7">
<h3>Code 7.7<a class="headerlink" href="#Code-7.7" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_7_2</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">brain</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="mi">2</span><span class="p">,)))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mass</span><span class="p">,</span> <span class="n">mass</span><span class="o">**</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">brain</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;brain&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">brain</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">brain</span>


<span class="n">guide_7_2</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_7_2</span><span class="p">)</span>
<span class="n">svi_7_2</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_7_2</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide_7_2</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">mass</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">brain</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">posterior_samples_7_2</span> <span class="o">=</span> <span class="n">guide_7_2</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_7_2</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_7_2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████████| 10000/10000 [00:02&lt;00:00, 3859.59it/s, init loss: 51.5194, avg. loss [9501-10000]: 10.3358]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.64      0.14      0.64      0.42      0.85   5130.30      1.00
      b[0]      0.22      0.08      0.22      0.09      0.35   5042.04      1.00
      b[1]     -0.08      0.14     -0.08     -0.29      0.14   4978.21      1.00
     sigma      0.18      0.06      0.17      0.09      0.26   4965.51      1.00

</pre></div></div>
</div>
</section>
<section id="Code-7.8">
<h3>Code 7.8<a class="headerlink" href="#Code-7.8" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_factory</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">brain</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="n">order</span><span class="p">,)))</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
            <span class="s2">&quot;mu&quot;</span><span class="p">,</span>
            <span class="n">a</span>
            <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">)])</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="n">brain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span> <span class="mf">0.001</span>
        <span class="p">)</span>
        <span class="n">brain</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;brain&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">brain</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">brain</span>

    <span class="n">guide</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span>
    <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">jrng</span><span class="p">,</span>
        <span class="n">mass</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">brain</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="o">=</span><span class="mi">5_000</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">posterior_samples</span> <span class="o">=</span> <span class="n">guide</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">svi</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5000</span><span class="p">,))</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
        <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]),</span>
        <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
        <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s2">&quot;guide&quot;</span><span class="p">:</span> <span class="n">guide</span><span class="p">,</span>
        <span class="s2">&quot;svi&quot;</span><span class="p">:</span> <span class="n">svi</span><span class="p">,</span>
        <span class="s2">&quot;posterior_samples&quot;</span><span class="p">:</span> <span class="n">posterior_samples</span><span class="p">,</span>
    <span class="p">}</span>


<span class="n">_7_3</span> <span class="o">=</span> <span class="n">model_factory</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">_7_4</span> <span class="o">=</span> <span class="n">model_factory</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">_7_5</span> <span class="o">=</span> <span class="n">model_factory</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████████████| 5000/5000 [00:01&lt;00:00, 3509.10it/s, init loss: 41.3992, avg. loss [4751-5000]: 9.0012]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.53      0.13      0.53      0.33      0.73   4915.68      1.00
      b[0]      0.42      0.16      0.42      0.16      0.68   4227.15      1.00
      b[1]      0.06      0.16      0.06     -0.20      0.30   4948.92      1.00
      b[2]     -0.23      0.15     -0.23     -0.47     -0.00   4498.22      1.00
     sigma      0.15      0.05      0.15      0.08      0.22   5254.10      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 5000/5000 [00:01&lt;00:00, 3316.72it/s, init loss: 45.8430, avg. loss [4751-5000]: 10.8289]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.85      0.20      0.85      0.53      1.16   4859.62      1.00
      b[0]      0.83      0.26      0.84      0.44      1.26   4801.93      1.00
      b[1]     -0.94      0.55     -0.95     -1.80     -0.04   4893.22      1.00
      b[2]     -0.75      0.31     -0.76     -1.26     -0.28   4810.24      1.00
      b[3]      0.65      0.35      0.66      0.11      1.20   4853.25      1.00
     sigma      0.12      0.04      0.11      0.06      0.17   4951.62      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 5000/5000 [00:01&lt;00:00, 3535.29it/s, init loss: 60.6947, avg. loss [4751-5000]: 11.6199]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.96      0.11      0.96      0.78      1.14   5028.22      1.00
      b[0]      1.68      0.26      1.69      1.28      2.11   4841.44      1.00
      b[1]     -0.67      0.31     -0.68     -1.16     -0.18   4880.17      1.00
      b[2]     -2.79      0.55     -2.79     -3.70     -1.94   4758.65      1.00
      b[3]      0.11      0.24      0.11     -0.29      0.48   4819.06      1.00
      b[4]      1.07      0.28      1.07      0.62      1.51   4721.34      1.00
     sigma      0.07      0.05      0.06      0.01      0.13   4625.16      1.00

</pre></div></div>
</div>
</section>
<section id="Code-7.9">
<h3>Code 7.9<a class="headerlink" href="#Code-7.9" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_7_6</span> <span class="o">=</span> <span class="n">model_factory</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████| 5000/5000 [00:01&lt;00:00, 3479.44it/s, init loss: 239.2814, avg. loss [4751-5000]: 24.9259]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.82      0.84      0.81     -0.54      2.14   5198.65      1.00
      b[0]      1.43      2.78      1.43     -3.24      5.65   4871.02      1.00
      b[1]      0.01      4.13     -0.01     -7.25      6.08   5182.49      1.00
      b[2]     -2.08      6.30     -2.16    -12.30      7.69   4643.86      1.00
      b[3]     -0.98      7.12     -0.99    -12.42     10.29   5150.62      1.00
      b[4]      0.61      3.99      0.59     -5.75      6.90   4584.22      1.00
      b[5]      0.51      3.55      0.49     -5.26      6.07   5172.57      1.00
     sigma      1.85      2.42      1.11      0.04      3.90   4693.84      1.00

</pre></div></div>
</div>
</section>
<section id="Code-7.10">
<h3>Code 7.10<a class="headerlink" href="#Code-7.10" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mass_std</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">posterior_predictive_7_1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model_7_1</span><span class="p">,</span> <span class="n">posterior_samples_7_1</span><span class="p">)</span>
<span class="n">posterior_predictive_samples_7_1</span> <span class="o">=</span> <span class="n">posterior_predictive_7_1</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass_std</span><span class="p">,</span> <span class="n">brain</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
<span class="n">mu_mean</span> <span class="o">=</span> <span class="n">posterior_predictive_samples_7_1</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mu_ci</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">posterior_predictive_samples_7_1</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mass_std</span><span class="p">,</span> <span class="n">mu_mean</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">mass_std</span><span class="p">,</span> <span class="n">mu_ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu_ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PolyCollection at 0x7c43713e16a0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_23_1.png" src="../_images/notebooks_07_ulysse_s_copmpass_23_1.png" />
</div>
</div>
</section>
<section id="Code-7.11">
<h3>Code 7.11<a class="headerlink" href="#Code-7.11" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">df_minus_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-7.12">
<h3>Code 7.12<a class="headerlink" href="#Code-7.12" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
<span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array(0.61086434, dtype=float32)
</pre></div></div>
</div>
</section>
<section id="Code-7.13">
<h3>Code 7.13<a class="headerlink" href="#Code-7.13" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lppd</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_site</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">posterior_samples</span> <span class="o">=</span> <span class="n">guide</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
        <span class="n">jrng</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,)</span>
    <span class="p">)</span>
    <span class="n">logprob</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
        <span class="n">guide</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
        <span class="n">posterior_samples</span><span class="p">,</span>
        <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
    <span class="p">)[</span><span class="n">return_site</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">logprob</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logprob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">lppd</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_7_1</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="n">svi_7_1</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;brain&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
    <span class="n">return_site</span><span class="o">=</span><span class="s2">&quot;brain&quot;</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array([ 0.6126852 ,  0.64878654,  0.5431175 ,  0.6278982 ,  0.4596014 ,
        0.42311287, -0.83332634], dtype=float32)
</pre></div></div>
</div>
</section>
<section id="Code-7.14">
<h3>Code 7.14<a class="headerlink" href="#Code-7.14" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lppd</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_site</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">posterior_samples</span> <span class="o">=</span> <span class="n">guide</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
        <span class="n">jrng</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,)</span>
    <span class="p">)</span>
    <span class="n">logprob</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
        <span class="n">guide</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
        <span class="n">posterior_samples</span><span class="p">,</span>
        <span class="o">**</span><span class="n">inputs</span><span class="p">,</span>
    <span class="p">)[</span><span class="n">return_site</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">logprob</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logprob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="Code-7.15">
<h3>Code 7.15<a class="headerlink" href="#Code-7.15" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lppds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="n">_model</span> <span class="o">=</span> <span class="n">model_factory</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="c1"># _, jrng = jax.random.split(jrng)</span>
    <span class="n">_lppd</span> <span class="o">=</span> <span class="n">lppd</span><span class="p">(</span>
        <span class="n">jrng</span><span class="p">,</span>
        <span class="n">guide</span><span class="o">=</span><span class="n">_model</span><span class="p">[</span><span class="s2">&quot;guide&quot;</span><span class="p">],</span>
        <span class="n">params</span><span class="o">=</span><span class="n">_model</span><span class="p">[</span><span class="s2">&quot;svi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;brain&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
        <span class="n">return_site</span><span class="o">=</span><span class="s2">&quot;brain&quot;</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">lppds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_lppd</span><span class="p">)))</span>
<span class="n">lppds</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 5000/5000 [00:01&lt;00:00, 3374.63it/s, init loss: 140.6424, avg. loss [4751-5000]: 3.6504]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.53      0.07      0.53      0.42      0.64   5115.94      1.00
      b[0]      0.17      0.07      0.17      0.05      0.29   4138.12      1.00
     sigma      0.19      0.06      0.18      0.10      0.27   5014.89      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 5000/5000 [00:01&lt;00:00, 3361.47it/s, init loss: 121.2008, avg. loss [4751-5000]: 6.6319]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.61      0.14      0.61      0.39      0.82   5064.44      1.00
      b[0]      0.19      0.08      0.20      0.06      0.33   4908.77      1.00
      b[1]     -0.10      0.14     -0.10     -0.32      0.12   4974.54      1.00
     sigma      0.18      0.06      0.18      0.10      0.27   5052.47      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 5000/5000 [00:01&lt;00:00, 3499.62it/s, init loss: 361.6368, avg. loss [4751-5000]: 8.8995]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.53      0.13      0.52      0.32      0.73   5125.14      1.00
      b[0]      0.42      0.17      0.42      0.15      0.69   5114.98      1.00
      b[1]      0.06      0.16      0.06     -0.18      0.33   5092.10      1.00
      b[2]     -0.23      0.15     -0.23     -0.47      0.02   5172.35      1.00
     sigma      0.15      0.05      0.15      0.08      0.22   4668.61      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████| 5000/5000 [00:01&lt;00:00, 3511.74it/s, init loss: 604.9111, avg. loss [4751-5000]: 10.8738]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.84      0.20      0.84      0.52      1.17   5269.25      1.00
      b[0]      0.82      0.27      0.82      0.39      1.25   5118.11      1.00
      b[1]     -0.92      0.57     -0.92     -1.83     -0.01   5251.15      1.00
      b[2]     -0.74      0.32     -0.75     -1.25     -0.24   5202.24      1.00
      b[3]      0.63      0.36      0.64      0.05      1.19   5202.74      1.00
     sigma      0.12      0.04      0.12      0.06      0.18   4116.31      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████| 5000/5000 [00:01&lt;00:00, 3439.79it/s, init loss: 374.5667, avg. loss [4751-5000]: 11.2023]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.97      0.06      0.97      0.87      1.06   4943.27      1.00
      b[0]      1.68      0.14      1.68      1.46      1.91   4996.98      1.00
      b[1]     -0.69      0.17     -0.69     -0.94     -0.42   4827.07      1.00
      b[2]     -2.78      0.29     -2.79     -3.26     -2.32   4937.77      1.00
      b[3]      0.11      0.13      0.11     -0.10      0.30   4746.00      1.00
      b[4]      1.07      0.15      1.07      0.83      1.30   4644.29      1.00
     sigma      0.04      0.01      0.03      0.02      0.05   4526.73      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████| 5000/5000 [00:01&lt;00:00, 3450.45it/s, init loss: 901.0758, avg. loss [4751-5000]: 24.2480]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.92      0.71      0.92     -0.18      2.07   4598.10      1.00
      b[0]      1.65      1.68      1.63     -0.99      4.35   5105.75      1.00
      b[1]     -0.62      3.54     -0.59     -6.21      5.13   4186.98      1.00
      b[2]     -2.71      4.16     -2.66     -9.16      4.13   4619.13      1.00
      b[3]      0.03      5.63      0.02     -9.15      8.83   4167.72      1.00
      b[4]      1.02      2.64      1.01     -3.19      5.30   4257.93      1.00
      b[5]      0.05      2.64      0.08     -4.06      4.34   4138.81      1.00
     sigma      0.68      0.83      0.42      0.02      1.42   5005.15      1.00

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2.4747753143310547,
 2.5710973739624023,
 3.650806427001953,
 5.180877685546875,
 13.968978881835938,
 -2.801992416381836]
</pre></div></div>
</div>
</section>
<section id="Code-7.16">
<h3>Code 7.16<a class="headerlink" href="#Code-7.16" title="Link to this heading">¶</a></h3>
<p>Can’t be bothered</p>
</section>
<section id="Code-7.17">
<h3>Code 7.17<a class="headerlink" href="#Code-7.17" title="Link to this heading">¶</a></h3>
<p>Can’t be bothered</p>
</section>
<section id="Code-7.18">
<h3>Code 7.18<a class="headerlink" href="#Code-7.18" title="Link to this heading">¶</a></h3>
<p>Can’t be bothered</p>
</section>
<section id="Code-7.19">
<h3>Code 7.19<a class="headerlink" href="#Code-7.19" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/cars.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="s2">&quot;distance&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>speed</th>
      <th>distance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>4</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4</td>
      <td>10</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7</td>
      <td>22</td>
    </tr>
    <tr>
      <th>5</th>
      <td>8</td>
      <td>16</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_waic</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">speed</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">distance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distance</span>


<span class="n">guide_waic</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_waic</span><span class="p">)</span>
<span class="n">svi_waic</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_waic</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide_waic</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">speed</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">distance</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="o">=</span><span class="mi">5_000</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">posterior_samples_waic</span> <span class="o">=</span> <span class="n">guide_waic</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_waic</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_waic</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████| 5000/5000 [00:01&lt;00:00, 3166.83it/s, init loss: 1353371.2500, avg. loss [4751-5000]: 229.6863]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a     -4.26      6.57     -4.06    -14.33      6.67    910.84      1.00
         b      3.16      0.40      3.15      2.51      3.78    958.17      1.00
     sigma     14.01      1.21     13.99     12.08     15.90   1064.40      1.00

</pre></div></div>
</div>
</section>
<section id="Code-7.20">
<h3>Code 7.20<a class="headerlink" href="#Code-7.20" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logprob</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">posterior_samples_waic</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">posterior_samples_waic</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="o">.</span><span class="n">T</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">logprob</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>990</th>
      <th>991</th>
      <th>992</th>
      <th>993</th>
      <th>994</th>
      <th>995</th>
      <th>996</th>
      <th>997</th>
      <th>998</th>
      <th>999</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-3.629718</td>
      <td>-3.684560</td>
      <td>-3.596066</td>
      <td>-3.669690</td>
      <td>-3.731843</td>
      <td>-3.801685</td>
      <td>-3.476952</td>
      <td>-3.387431</td>
      <td>-3.603139</td>
      <td>-3.471394</td>
      <td>...</td>
      <td>-4.137332</td>
      <td>-3.935643</td>
      <td>-3.585229</td>
      <td>-3.535434</td>
      <td>-4.138996</td>
      <td>-3.615272</td>
      <td>-3.491270</td>
      <td>-3.665351</td>
      <td>-4.180484</td>
      <td>-3.706675</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-3.444975</td>
      <td>-3.632281</td>
      <td>-3.658929</td>
      <td>-3.756455</td>
      <td>-3.637693</td>
      <td>-3.503613</td>
      <td>-3.850882</td>
      <td>-3.667214</td>
      <td>-3.542099</td>
      <td>-3.562260</td>
      <td>...</td>
      <td>-3.752282</td>
      <td>-3.621354</td>
      <td>-3.599550</td>
      <td>-3.645258</td>
      <td>-3.688401</td>
      <td>-3.598408</td>
      <td>-3.641121</td>
      <td>-3.662130</td>
      <td>-3.885534</td>
      <td>-3.421345</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-4.139722</td>
      <td>-3.992113</td>
      <td>-3.892215</td>
      <td>-3.885522</td>
      <td>-4.062891</td>
      <td>-4.279980</td>
      <td>-3.557196</td>
      <td>-3.619896</td>
      <td>-4.029455</td>
      <td>-3.729861</td>
      <td>...</td>
      <td>-4.599494</td>
      <td>-4.389538</td>
      <td>-3.936423</td>
      <td>-3.796491</td>
      <td>-4.616188</td>
      <td>-3.937617</td>
      <td>-3.772468</td>
      <td>-3.946512</td>
      <td>-4.451802</td>
      <td>-4.233172</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-3.478562</td>
      <td>-3.677278</td>
      <td>-3.691564</td>
      <td>-3.786630</td>
      <td>-3.669137</td>
      <td>-3.494777</td>
      <td>-3.907384</td>
      <td>-3.740273</td>
      <td>-3.576341</td>
      <td>-3.690196</td>
      <td>...</td>
      <td>-3.662150</td>
      <td>-3.581232</td>
      <td>-3.637528</td>
      <td>-3.705020</td>
      <td>-3.575135</td>
      <td>-3.651668</td>
      <td>-3.684454</td>
      <td>-3.708522</td>
      <td>-3.802642</td>
      <td>-3.436655</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-3.551445</td>
      <td>-3.653720</td>
      <td>-3.603130</td>
      <td>-3.674049</td>
      <td>-3.690737</td>
      <td>-3.636400</td>
      <td>-3.459224</td>
      <td>-3.385133</td>
      <td>-3.592130</td>
      <td>-3.457028</td>
      <td>...</td>
      <td>-3.937515</td>
      <td>-3.775614</td>
      <td>-3.586579</td>
      <td>-3.535266</td>
      <td>-3.858096</td>
      <td>-3.595495</td>
      <td>-3.496110</td>
      <td>-3.652098</td>
      <td>-3.972148</td>
      <td>-3.549774</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 1000 columns</p>
</div></div>
</div>
</section>
<section id="Code-7.21">
<h3>Code 7.21<a class="headerlink" href="#Code-7.21" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lppd</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">logprob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">posterior_samples_waic</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">lppd</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array([-3.6979318, -3.625092 , -4.0384912, -3.6411977, -3.6396234,
       -4.0618114, -3.7818491, -3.5776255, -3.695709 , -4.017172 ,
       -3.5832663, -4.5316973, -4.029094 , -3.7948267, -3.6424248,
       -3.8545039, -3.5819216, -3.5819216, -3.7893867, -4.0539527,
       -3.5997784, -4.591117 , -7.4521   , -4.9139514, -4.305003 ,
       -3.872773 , -4.0796423, -3.6599274, -4.3351336, -3.788149 ,
       -3.5627542, -3.849329 , -3.5937212, -4.9521384, -6.0250726,
       -4.550875 , -3.8079486, -3.9493885, -5.364433 , -3.8712156,
       -3.6903672, -3.590053 , -3.6338656, -3.577682 , -4.095565 ,
       -3.5944946, -4.5984335, -4.699437 , -9.077726 , -3.8442519],      dtype=float32)
</pre></div></div>
</div>
</section>
<section id="Code-7.22">
<h3>Code 7.22<a class="headerlink" href="#Code-7.22" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pWAIC</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">logprob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pWAIC</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array([0.04271119, 0.0153652 , 0.08299039, 0.01353036, 0.01978975,
       0.05975391, 0.02826124, 0.00904567, 0.01285752, 0.03736907,
       0.01003468, 0.05772198, 0.03109323, 0.02072776, 0.01354725,
       0.01956068, 0.00931279, 0.00931279, 0.0118799 , 0.02272627,
       0.00967725, 0.07162474, 0.7725155 , 0.0656068 , 0.02986871,
       0.01277356, 0.0209015 , 0.00993058, 0.03472175, 0.01259883,
       0.00723182, 0.01555479, 0.00777722, 0.09810159, 0.26312327,
       0.06920974, 0.01598435, 0.02271168, 0.20900778, 0.02277338,
       0.01237857, 0.00803181, 0.01088416, 0.00829181, 0.07528339,
       0.00948727, 0.15722741, 0.17413726, 1.529935  , 0.05333252],      dtype=float32)
</pre></div></div>
</div>
</section>
<section id="Code-7.23">
<h3>Code 7.23<a class="headerlink" href="#Code-7.23" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lppd</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pWAIC</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array(426.16818, dtype=float32)
</pre></div></div>
</div>
</section>
<section id="Code-7.24">
<h3>Code 7.24<a class="headerlink" href="#Code-7.24" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">waic_vec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">lppd</span> <span class="o">-</span> <span class="n">pWAIC</span><span class="p">)</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">waic_vec</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array(17.15335, dtype=float32)
</pre></div></div>
</div>
</section>
<section id="Code-7.25">
<h3>Code 7.25<a class="headerlink" href="#Code-7.25" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of plants</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># simulate initial heights</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,))</span>

<span class="c1"># assign treatmens and simulate fungus and growth</span>
<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">treatment</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">fungus</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">treatment</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">h1</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fungus</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;h0&quot;</span><span class="p">:</span> <span class="n">h0</span><span class="p">,</span> <span class="s2">&quot;h1&quot;</span><span class="p">:</span> <span class="n">h1</span><span class="p">,</span> <span class="s2">&quot;treatment&quot;</span><span class="p">:</span> <span class="n">treatment</span><span class="p">,</span> <span class="s2">&quot;fungus&quot;</span><span class="p">:</span> <span class="n">fungus</span><span class="p">})</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">model_6_6</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">h1</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">h1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h1</span>


<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">guide_6_6</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_6_6</span><span class="p">)</span>
<span class="n">svi_6_6</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_6_6</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_6_6</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">h0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">h1</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>
<span class="n">posterior_samples_6_6</span> <span class="o">=</span> <span class="n">guide_6_6</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_6_6</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_6_6</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">model_6_7</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">fungus</span><span class="p">,</span> <span class="n">h1</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
    <span class="n">beta_treatment</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">beta_fungus</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_fungus&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
        <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_treatment</span> <span class="o">*</span> <span class="n">treatment</span> <span class="o">+</span> <span class="n">beta_fungus</span> <span class="o">*</span> <span class="n">fungus</span>
    <span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">h1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h1</span>


<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">guide_6_7</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_6_7</span><span class="p">)</span>
<span class="n">svi_6_7</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_6_7</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_6_7</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">h0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">treatment</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">fungus</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;fungus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">h1</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>
<span class="n">posterior_samples_6_7</span> <span class="o">=</span> <span class="n">guide_6_7</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_6_7</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_6_7</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">model_6_8</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">h1</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
    <span class="n">beta_treatment</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_treatment</span> <span class="o">*</span> <span class="n">treatment</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">h1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h1</span>


<span class="n">_</span><span class="p">,</span> <span class="n">jrng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jrng</span><span class="p">)</span>
<span class="n">guide_6_8</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_6_8</span><span class="p">)</span>
<span class="n">svi_6_8</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_6_8</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_6_8</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">h0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">treatment</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">h1</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>
<span class="n">posterior_samples_6_8</span> <span class="o">=</span> <span class="n">guide_6_8</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_6_8</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_6_8</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>h0</th>
      <th>h1</th>
      <th>treatment</th>
      <th>fungus</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4.916372</td>
      <td>10.434927</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9.092189</td>
      <td>13.633933</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10.738547</td>
      <td>10.773833</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7.541627</td>
      <td>12.445154</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>13.056141</td>
      <td>15.595195</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████| 2500/2500 [00:00&lt;00:00, 2802.67it/s, init loss: 422.4401, avg. loss [2376-2500]: 866.1056]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         p      0.00      0.00      0.00      0.00      0.00    969.81      1.00
     sigma     28.76      3.29     28.51     23.36     33.45   1017.39      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████| 2500/2500 [00:00&lt;00:00, 2529.31it/s, init loss: 49529.8945, avg. loss [2376-2500]: 233.2943]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                      mean       std    median      5.5%     94.5%     n_eff     r_hat
           alpha      1.44      0.03      1.44      1.39      1.49    801.70      1.00
     beta_fungus     -0.31      0.04     -0.31     -0.38     -0.25   1029.91      1.00
  beta_treatment      0.02      0.04      0.02     -0.04      0.09    766.75      1.00
           sigma      1.71      0.18      1.70      1.42      1.97    965.52      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████████| 2500/2500 [00:00&lt;00:00, 2699.48it/s, init loss: 3436.6699, avg. loss [2376-2500]: 206.3653]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                      mean       std    median      5.5%     94.5%     n_eff     r_hat
           alpha      1.33      0.02      1.33      1.29      1.37    914.95      1.00
  beta_treatment      0.15      0.03      0.15      0.09      0.20    911.49      1.00
           sigma      1.82      0.13      1.82      1.62      2.02   1037.50      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logprob_6_7</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_6_7</span><span class="p">,</span>
    <span class="n">posterior_samples_6_7</span><span class="p">,</span>
    <span class="n">treatment</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">fungus</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;fungus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">h0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">h1</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">az_6_7</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sample_stats</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">:</span> <span class="n">logprob_6_7</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]})</span>
<span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">az_6_7</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Computed from 1000 posterior samples and 100 observations log-likelihood matrix.

              Estimate       SE
deviance_waic   359.53     8.36
p_waic            2.63        -
</pre></div></div>
</div>
</section>
<section id="Code-7.26">
<h3>Code 7.26<a class="headerlink" href="#Code-7.26" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logprob_6_6</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_6_6</span><span class="p">,</span>
    <span class="n">posterior_samples_6_6</span><span class="p">,</span>
    <span class="n">h0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">h1</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">az_6_6</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sample_stats</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">:</span> <span class="n">logprob_6_6</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]})</span>
<span class="n">logprob_6_8</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_6_8</span><span class="p">,</span>
    <span class="n">posterior_samples_6_8</span><span class="p">,</span>
    <span class="n">treatment</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">h0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">h1</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">az_6_8</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sample_stats</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">:</span> <span class="n">logprob_6_8</span><span class="p">[</span><span class="s2">&quot;h1&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]})</span>
<span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;model_6_6&quot;</span><span class="p">:</span> <span class="n">az_6_6</span><span class="p">,</span> <span class="s2">&quot;model_6_7&quot;</span><span class="p">:</span> <span class="n">az_6_7</span><span class="p">,</span> <span class="s2">&quot;model_6_8&quot;</span><span class="p">:</span> <span class="n">az_6_8</span><span class="p">},</span>
    <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;waic&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_waic</th>
      <th>p_waic</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>model_6_7</th>
      <td>0</td>
      <td>359.534103</td>
      <td>2.626647</td>
      <td>0.000000</td>
      <td>1.000000e+00</td>
      <td>8.357750</td>
      <td>0.000000</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>model_6_8</th>
      <td>1</td>
      <td>409.555401</td>
      <td>2.992141</td>
      <td>50.021299</td>
      <td>4.064067e-10</td>
      <td>14.378290</td>
      <td>14.397061</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>model_6_6</th>
      <td>2</td>
      <td>880.914237</td>
      <td>0.720432</td>
      <td>521.380135</td>
      <td>0.000000e+00</td>
      <td>0.778659</td>
      <td>8.443789</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</section>
<section id="Code-7.27">
<h2>Code 7.27<a class="headerlink" href="#Code-7.27" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">waic_6_7</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">az_6_7</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">waic_6_8</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">az_6_8</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">waic_6_7_minus_6_8</span> <span class="o">=</span> <span class="n">waic_6_7</span><span class="p">[</span><span class="s2">&quot;waic_i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">waic_6_8</span><span class="p">[</span><span class="s2">&quot;waic_i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">num_posterior_samples</span> <span class="o">=</span> <span class="n">waic_6_7</span><span class="p">[</span><span class="s2">&quot;waic_i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_posterior_samples</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">waic_6_7_minus_6_8</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array(14.39706, dtype=float32)
</pre></div></div>
</div>
<section id="Code-7.28">
<h3>Code 7.28<a class="headerlink" href="#Code-7.28" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">55</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">*</span> <span class="mf">2.6</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array([26.400002, 83.6     ], dtype=float32, weak_type=True)
</pre></div></div>
</div>
</section>
<section id="Code-7.29">
<h3>Code 7.29<a class="headerlink" href="#Code-7.29" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_7_1</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;model_6_6&quot;</span><span class="p">:</span> <span class="n">az_6_6</span><span class="p">,</span> <span class="s2">&quot;model_6_7&quot;</span><span class="p">:</span> <span class="n">az_6_7</span><span class="p">,</span> <span class="s2">&quot;model_6_8&quot;</span><span class="p">:</span> <span class="n">az_6_8</span><span class="p">},</span>
    <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;waic&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">compare_7_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Model comparison\nlower is better&#39;}, xlabel=&#39;elpd_waic (deviance)&#39;, ylabel=&#39;ranked models&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_58_2.png" src="../_images/notebooks_07_ulysse_s_copmpass_58_2.png" />
</div>
</div>
</section>
<section id="Code-7.30">
<h3>Code 7.30<a class="headerlink" href="#Code-7.30" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">waic_6_6</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">az_6_6</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">waic_6_6_minus_6_8</span> <span class="o">=</span> <span class="n">waic_6_6</span><span class="p">[</span><span class="s2">&quot;waic_i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">waic_6_8</span><span class="p">[</span><span class="s2">&quot;waic_i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">num_posterior_samples</span> <span class="o">=</span> <span class="n">waic_6_6</span><span class="p">[</span><span class="s2">&quot;waic_i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_posterior_samples</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">waic_6_6_minus_6_8</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array(14.467875, dtype=float32)
</pre></div></div>
</div>
</section>
<section id="Code-7.31">
<h3>Code 7.31<a class="headerlink" href="#Code-7.31" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">waics</span> <span class="o">=</span> <span class="p">[</span><span class="n">waic_6_6</span><span class="p">,</span> <span class="n">waic_6_7</span><span class="p">,</span> <span class="n">waic_6_8</span><span class="p">]</span>
<span class="n">dse</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waics</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waics</span><span class="p">)):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">waics</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;waic_i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">waics</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;waic_i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">dse</span> <span class="o">=</span> <span class="n">dse</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_posterior_samples</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">diff</span><span class="p">)))</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">dse</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model_6_6&quot;</span><span class="p">,</span> <span class="s2">&quot;model_6_7&quot;</span><span class="p">,</span> <span class="s2">&quot;model_6_8&quot;</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model_6_6&quot;</span><span class="p">,</span> <span class="s2">&quot;model_6_7&quot;</span><span class="p">,</span> <span class="s2">&quot;model_6_8&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_6_6</th>
      <th>model_6_7</th>
      <th>model_6_8</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>model_6_6</th>
      <td>0.000000</td>
      <td>8.443789</td>
      <td>14.467875</td>
    </tr>
    <tr>
      <th>model_6_7</th>
      <td>8.443789</td>
      <td>0.000000</td>
      <td>14.397060</td>
    </tr>
    <tr>
      <th>model_6_8</th>
      <td>14.467875</td>
      <td>14.397060</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Code-7.32">
<h3>Code 7.32<a class="headerlink" href="#Code-7.32" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/WaffleDivorce.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MedianAgeMarriage&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Divorce&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Marriage&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">model_5_1</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_age_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;divorce&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">divorce</span>


<span class="n">guide_5_1</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_1</span><span class="p">)</span>
<span class="n">svi_5_1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_1</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_1</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_000</span><span class="p">)</span>
<span class="n">posterior_samples_5_1</span> <span class="o">=</span> <span class="n">guide_5_1</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_1</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_5_1</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">logprob_5_1</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_5_1</span><span class="p">,</span>
    <span class="n">posterior_samples_5_1</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">az_5_1</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_5_1</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;divorce&quot;</span><span class="p">:</span> <span class="n">logprob_5_1</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">model_5_2</span><span class="p">(</span>
    <span class="n">marriage</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_marriage&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_marriage_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_marriage</span> <span class="o">*</span> <span class="n">marriage</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;divorce&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">divorce</span>


<span class="n">guide_5_2</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_2</span><span class="p">)</span>
<span class="n">svi_5_2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_2</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_2</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_000</span><span class="p">)</span>
<span class="n">posterior_samples_5_2</span> <span class="o">=</span> <span class="n">guide_5_2</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_2</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_5_2</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">logprob_5_2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_5_2</span><span class="p">,</span>
    <span class="n">posterior_samples_5_2</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">az_5_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_5_2</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;divorce&quot;</span><span class="p">:</span> <span class="n">logprob_5_2</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">model_5_3</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span>
    <span class="n">marriage</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_age_prior</span><span class="p">))</span>
    <span class="n">beta_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_marriage&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_marriage_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span> <span class="o">+</span> <span class="n">beta_marriage</span> <span class="o">*</span> <span class="n">marriage</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;divorce&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">divorce</span>


<span class="n">guide_5_3</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_3</span><span class="p">)</span>
<span class="n">svi_5_3</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_3</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_3</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">(),</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_000</span><span class="p">)</span>
<span class="n">posterior_samples_5_3</span> <span class="o">=</span> <span class="n">guide_5_3</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_3</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_5_3</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">logprob_5_3</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_5_3</span><span class="p">,</span>
    <span class="n">posterior_samples_5_3</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">az_5_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_5_3</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;divorce&quot;</span><span class="p">:</span> <span class="n">logprob_5_3</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████| 2000/2000 [00:00&lt;00:00, 2661.93it/s, init loss: 215.7631, avg. loss [1901-2000]: 60.6676]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
     alpha     -0.01      0.10     -0.00     -0.16      0.15    914.61      1.00
  beta_age     -0.57      0.11     -0.57     -0.72     -0.39    994.82      1.00
     sigma      0.80      0.08      0.80      0.68      0.93   1035.65      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████| 2000/2000 [00:00&lt;00:00, 2554.46it/s, init loss: 135.7295, avg. loss [1901-2000]: 67.5574]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                     mean       std    median      5.5%     94.5%     n_eff     r_hat
          alpha      0.01      0.10      0.01     -0.16      0.17    914.61      1.00
  beta_marriage      0.34      0.12      0.34      0.17      0.54    994.78      1.00
          sigma      0.90      0.09      0.89      0.77      1.03   1037.36      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████| 2000/2000 [00:00&lt;00:00, 2371.38it/s, init loss: 236.0262, avg. loss [1901-2000]: 60.7879]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                     mean       std    median      5.5%     94.5%     n_eff     r_hat
          alpha      0.00      0.10      0.00     -0.16      0.16  10093.27      1.00
       beta_age     -0.61      0.15     -0.61     -0.86     -0.37   9929.34      1.00
  beta_marriage     -0.07      0.15     -0.07     -0.31      0.18  10240.39      1.00
          sigma      0.80      0.08      0.79      0.67      0.93  10207.13      1.00

</pre></div></div>
</div>
</section>
<section id="Code-7.33">
<h3>Code 7.33<a class="headerlink" href="#Code-7.33" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_7_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;model_5_1&quot;</span><span class="p">:</span> <span class="n">az_5_1</span><span class="p">,</span> <span class="s2">&quot;model_5_2&quot;</span><span class="p">:</span> <span class="n">az_5_2</span><span class="p">,</span> <span class="s2">&quot;model_5_3&quot;</span><span class="p">:</span> <span class="n">az_5_3</span><span class="p">},</span>
    <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;waic&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">compare_7_2</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">compare_7_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_waic</th>
      <th>p_waic</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>model_5_1</th>
      <td>0</td>
      <td>125.904084</td>
      <td>3.820621</td>
      <td>0.000000</td>
      <td>0.88644</td>
      <td>13.440003</td>
      <td>0.000000</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>model_5_3</th>
      <td>1</td>
      <td>128.588442</td>
      <td>5.447977</td>
      <td>2.684358</td>
      <td>0.00000</td>
      <td>14.047844</td>
      <td>1.042510</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>model_5_2</th>
      <td>2</td>
      <td>139.559212</td>
      <td>3.170320</td>
      <td>13.655128</td>
      <td>0.11356</td>
      <td>10.896493</td>
      <td>9.897777</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Model comparison\nlower is better&#39;}, xlabel=&#39;elpd_waic (deviance)&#39;, ylabel=&#39;ranked models&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_66_3.png" src="../_images/notebooks_07_ulysse_s_copmpass_66_3.png" />
</div>
</div>
</section>
<section id="Code-7.34">
<h3>Code 7.34<a class="headerlink" href="#Code-7.34" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">waic_5_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">az_5_3</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
<span class="n">psis_5_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">az_5_3</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
<span class="n">penalty_5_3</span> <span class="o">=</span> <span class="n">az_5_3</span><span class="o">.</span><span class="n">log_likelihood</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;draw&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">waic_5_3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psis_5_3</span><span class="o">.</span><span class="n">pareto_k</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">penalty_5_3</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PSIS k value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;pWAIC&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:1647: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail.
See http://arxiv.org/abs/1507.04544 for details
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:792: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.70 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Computed from 10000 posterior samples and 50 observations log-likelihood matrix.

              Estimate       SE
deviance_waic   128.59    14.05
p_waic            5.45        -

There has been a warning during the calculation. Please check the results.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;pWAIC&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_68_3.png" src="../_images/notebooks_07_ulysse_s_copmpass_68_3.png" />
</div>
</div>
</section>
<section id="Code-7.35">
<h3>Code 7.35<a class="headerlink" href="#Code-7.35" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_3t</span><span class="p">(</span>
    <span class="n">age</span><span class="p">,</span>
    <span class="n">marriage</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">beta_age_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">beta_marriage_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">sigma_prior</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">divorce</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">alpha_prior</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_age_prior</span><span class="p">))</span>
    <span class="n">beta_marriage</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_marriage&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">**</span><span class="n">beta_marriage_prior</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span> <span class="o">+</span> <span class="n">beta_marriage</span> <span class="o">*</span> <span class="n">marriage</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="o">**</span><span class="n">sigma_prior</span><span class="p">))</span>
    <span class="n">divorce</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;divorce&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">mu</span><span class="p">,</span>
            <span class="n">sigma</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">divorce</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">divorce</span>


<span class="n">guide_5_3t</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_5_3t</span><span class="p">)</span>
<span class="n">svi_5_3t</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_5_3t</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_5_3t</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_000</span><span class="p">)</span>
<span class="n">posterior_samples_5_3t</span> <span class="o">=</span> <span class="n">guide_5_3t</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_5_3t</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_5_3t</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">logprob_5_3t</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_5_3t</span><span class="p">,</span>
    <span class="n">posterior_samples_5_3t</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">marriage</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">divorce</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">az_5_3t</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_5_3t</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;divorce&quot;</span><span class="p">:</span> <span class="n">logprob_5_3t</span><span class="p">[</span><span class="s2">&quot;divorce&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">az_5_3t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████| 2000/2000 [00:00&lt;00:00, 2260.75it/s, init loss: 147.9849, avg. loss [1901-2000]: 63.4598]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                     mean       std    median      5.5%     94.5%     n_eff     r_hat
          alpha      0.01      0.10      0.01     -0.15      0.17  10093.27      1.00
       beta_age     -0.71      0.14     -0.71     -0.93     -0.50   9974.97      1.00
  beta_marriage      0.01      0.21      0.00     -0.32      0.35  10224.71      1.00
          sigma      0.57      0.09      0.57      0.43      0.70  10161.44      1.00

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Computed from 10000 posterior samples and 50 observations log-likelihood matrix.

         Estimate       SE
elpd_loo   -66.62     5.70
p_loo        6.47        -
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.70]   (good)       50  100.0%
   (0.70, 1]   (bad)         0    0.0%
   (1, Inf)   (very bad)    0    0.0%
</pre></div></div>
</div>
</section>
</section>
<section id="Easy">
<h2>Easy<a class="headerlink" href="#Easy" title="Link to this heading">¶</a></h2>
<section id="7E1">
<h3>7E1<a class="headerlink" href="#7E1" title="Link to this heading">¶</a></h3>
<p>The measure of uncertainty should: - be continuous - increase as the number of possibilities increase - additive: the uncertainty on two events should be the sum of the uncertainty of eache event</p>
</section>
<section id="7E2">
<h3>7E2<a class="headerlink" href="#7E2" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
<span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array(0.61086434, dtype=float32)
</pre></div></div>
</div>
</section>
<section id="7E3">
<h3>7E3<a class="headerlink" href="#7E3" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
<span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array(1.3762267, dtype=float32)
</pre></div></div>
</div>
</section>
<section id="7E4">
<h3>7E4<a class="headerlink" href="#7E4" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">])</span>
<span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array(1.0986123, dtype=float32)
</pre></div></div>
</div>
</section>
</section>
<section id="Medium">
<h2>Medium<a class="headerlink" href="#Medium" title="Link to this heading">¶</a></h2>
<section id="7M1">
<h3>7M1<a class="headerlink" href="#7M1" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">AIC</span> <span class="pre">=</span> <span class="pre">-2</span> <span class="pre">(log_score</span> <span class="pre">-</span> <span class="pre">p)</span></code> where <code class="docutils literal notranslate"><span class="pre">p</span></code> is the number of parameters <code class="docutils literal notranslate"><span class="pre">WAIC</span> <span class="pre">=</span> <span class="pre">-2</span> <span class="pre">(lppd</span> <span class="pre">-</span> <span class="pre">waic_penalty)</span></code> where <code class="docutils literal notranslate"><span class="pre">waic_penalty</span></code> is the variance of the log likelihood of the observation over the posterior distribution.</p>
<p><code class="docutils literal notranslate"><span class="pre">AIC</span></code> assumes flat priors and that oos is drawn from same distribution as is.</p>
</section>
<section id="7M2">
<h3>7M2<a class="headerlink" href="#7M2" title="Link to this heading">¶</a></h3>
<p>Model selection picks a “best” mode, vs model comparison tries to see where models agree or disagree. Model selection discard the uncertainty as to which is the right model.</p>
</section>
<section id="7M3">
<h3>7M3<a class="headerlink" href="#7M3" title="Link to this heading">¶</a></h3>
<p>Because the information criterion are a sum (rather than an average) of log likelihoods.</p>
</section>
<section id="7M4">
<h3>7M4<a class="headerlink" href="#7M4" title="Link to this heading">¶</a></h3>
<p>A stronger prior reduces the amount of freedoem in the training process, thus reducing the effective number of parameters.</p>
</section>
<section id="7M5">
<h3>7M5<a class="headerlink" href="#7M5" title="Link to this heading">¶</a></h3>
<p>Informative priors make the training process more skeptical of otherwise surprising data, reigning in tendancy of the model to draw to much from it.</p>
</section>
<section id="7M6">
<h3>7M6<a class="headerlink" href="#7M6" title="Link to this heading">¶</a></h3>
<p>Overly informative priors prevent the model from adjusting to contradictory data.</p>
</section>
</section>
<section id="Hard">
<h2>Hard<a class="headerlink" href="#Hard" title="Link to this heading">¶</a></h2>
<section id="7H1">
<h3>7H1<a class="headerlink" href="#7H1" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/Laffer.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;tax_rate&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;tax_revenue&quot;</span><span class="p">])</span>
<span class="n">rates</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">30</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">model_7h1_linear</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">revenue</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">rate</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;revenue&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">revenue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revenue</span>


<span class="n">guide_7h1_linear</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_7h1_linear</span><span class="p">)</span>
<span class="n">svi_7h1_linear</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_7h1_linear</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_7h1_linear</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_000</span><span class="p">)</span>
<span class="n">posterior_samples_7h1_linear</span> <span class="o">=</span> <span class="n">guide_7h1_linear</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_7h1_linear</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_7h1_linear</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">posterior_predictive_7h1_linear</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_7h1_linear</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">posterior_samples_7h1_linear</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_7h1_linear</span> <span class="o">=</span> <span class="n">posterior_predictive_7h1_linear</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">rates</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mu_mean_7h1_linear</span> <span class="o">=</span> <span class="n">posterior_predictive_samples_7h1_linear</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">logprob_7h1_linear</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_7h1_linear</span><span class="p">,</span>
    <span class="n">posterior_samples_7h1_linear</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">idata_7h1_linear</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_7h1_linear</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;revenue&quot;</span><span class="p">:</span> <span class="n">logprob_7h1_linear</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">model_7h1_curved</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">revenue</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">rate</span> <span class="o">+</span> <span class="n">b2</span> <span class="o">*</span> <span class="n">rate</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;revenue&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">revenue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revenue</span>


<span class="n">guide_7h1_curved</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_7h1_curved</span><span class="p">)</span>
<span class="n">svi_7h1_curved</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_7h1_curved</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_7h1_curved</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_000</span><span class="p">)</span>
<span class="n">posterior_samples_7h1_curved</span> <span class="o">=</span> <span class="n">guide_7h1_curved</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_7h1_curved</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_7h1_curved</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">posterior_predictive_7h1_curved</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_7h1_curved</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">posterior_samples_7h1_curved</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_7h1_curved</span> <span class="o">=</span> <span class="n">posterior_predictive_7h1_curved</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">rates</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mu_mean_7h1_curved</span> <span class="o">=</span> <span class="n">posterior_predictive_samples_7h1_curved</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">logprob_7h1_curved</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_7h1_curved</span><span class="p">,</span>
    <span class="n">posterior_samples_7h1_curved</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">idata_7h1_curved</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_7h1_curved</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;divorce&quot;</span><span class="p">:</span> <span class="n">logprob_7h1_curved</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 2000/2000 [00:00&lt;00:00, 2338.09it/s, init loss: 86.1699, avg. loss [1901-2000]: 39.8162]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a     -0.02      0.13     -0.02     -0.22      0.19    914.61      1.00
         b      0.28      0.16      0.28      0.06      0.56    994.91      1.00
     sigma      0.95      0.12      0.94      0.76      1.15   1037.03      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 2000/2000 [00:00&lt;00:00, 2560.16it/s, init loss: 91.1880, avg. loss [1901-2000]: 38.9388]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.07      0.14      0.07     -0.16      0.29   1008.94      1.00
         b      0.10      0.20      0.11     -0.22      0.40   1022.58      1.00
        b2     -0.21      0.11     -0.20     -0.39     -0.04    951.15      1.00
     sigma      0.89      0.12      0.88      0.70      1.06    839.98      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;revenue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">mu_mean_7h1_linear</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">mu_mean_7h1_curved</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7c4320181b20&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_89_1.png" src="../_images/notebooks_07_ulysse_s_copmpass_89_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_7h1</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="n">idata_7h1_linear</span><span class="p">,</span> <span class="s2">&quot;curved&quot;</span><span class="p">:</span> <span class="n">idata_7h1_curved</span><span class="p">},</span>
    <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;loo&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">compare_7h1</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">compare_7h1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:792: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.67 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:792: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.67 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_loo</th>
      <th>p_loo</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>linear</th>
      <td>0</td>
      <td>87.509323</td>
      <td>5.297136</td>
      <td>0.000000</td>
      <td>0.630838</td>
      <td>20.542279</td>
      <td>0.000000</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>curved</th>
      <td>1</td>
      <td>89.735589</td>
      <td>7.455492</td>
      <td>2.226266</td>
      <td>0.369162</td>
      <td>25.347745</td>
      <td>5.042696</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Model comparison\nlower is better&#39;}, xlabel=&#39;elpd_loo (deviance)&#39;, ylabel=&#39;ranked models&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_90_3.png" src="../_images/notebooks_07_ulysse_s_copmpass_90_3.png" />
</div>
</div>
<p>Can’t distinguish betwee linear and curved model.</p>
</section>
<section id="7H2">
<h3>7H2<a class="headerlink" href="#7H2" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">idata_7h1_linear</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;pareto_k&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:792: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.67 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>11</th>
      <td>1.155245</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.557212</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.310158</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.300436</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.228620</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">idata_7h1_curved</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;pareto_k&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:792: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.67 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>11</th>
      <td>1.456577</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.491925</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.384493</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.367777</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.346864</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The high tax revenue country (# 11) is an outlier in both models.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/Laffer.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;tax_rate&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;tax_revenue&quot;</span><span class="p">])</span>
<span class="n">rates</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">30</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">model_7h2_linear</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">revenue</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">rate</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;revenue&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">revenue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revenue</span>


<span class="n">guide_7h2_linear</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_7h2_linear</span><span class="p">)</span>
<span class="n">svi_7h2_linear</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_7h2_linear</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_7h2_linear</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_000</span><span class="p">)</span>
<span class="n">posterior_samples_7h2_linear</span> <span class="o">=</span> <span class="n">guide_7h2_linear</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_7h2_linear</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_7h2_linear</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">posterior_predictive_7h2_linear</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_7h2_linear</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">posterior_samples_7h2_linear</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_7h2_linear</span> <span class="o">=</span> <span class="n">posterior_predictive_7h2_linear</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">rates</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mu_mean_7h2_linear</span> <span class="o">=</span> <span class="n">posterior_predictive_samples_7h2_linear</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">logprob_7h2_linear</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_7h2_linear</span><span class="p">,</span>
    <span class="n">posterior_samples_7h2_linear</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">idata_7h2_linear</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_7h2_linear</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;revenue&quot;</span><span class="p">:</span> <span class="n">logprob_7h2_linear</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">model_7h2_curved</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">revenue</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">rate</span> <span class="o">+</span> <span class="n">b2</span> <span class="o">*</span> <span class="n">rate</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">revenue</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;revenue&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">revenue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revenue</span>


<span class="n">guide_7h2_curved</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_7h2_curved</span><span class="p">)</span>
<span class="n">svi_7h2_curved</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_7h2_curved</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_7h2_curved</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_000</span><span class="p">)</span>
<span class="n">posterior_samples_7h2_curved</span> <span class="o">=</span> <span class="n">guide_7h2_curved</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_7h2_curved</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_7h2_curved</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">posterior_predictive_7h2_curved</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_7h2_curved</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">posterior_samples_7h2_curved</span>
<span class="p">)</span>
<span class="n">posterior_predictive_samples_7h2_curved</span> <span class="o">=</span> <span class="n">posterior_predictive_7h2_curved</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">rates</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mu_mean_7h2_curved</span> <span class="o">=</span> <span class="n">posterior_predictive_samples_7h2_curved</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">logprob_7h2_curved</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_7h2_curved</span><span class="p">,</span>
    <span class="n">posterior_samples_7h2_curved</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">revenue</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">idata_7h2_curved</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_7h2_curved</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;divorce&quot;</span><span class="p">:</span> <span class="n">logprob_7h1_curved</span><span class="p">[</span><span class="s2">&quot;revenue&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 2000/2000 [00:00&lt;00:00, 2502.88it/s, init loss: 72.8578, avg. loss [1901-2000]: 35.0810]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a     -0.11      0.10     -0.11     -0.27      0.05    914.61      1.00
         b      0.25      0.13      0.25      0.07      0.47    994.49      1.00
     sigma      0.46      0.10      0.45      0.31      0.61   1024.54      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████| 2000/2000 [00:00&lt;00:00, 2576.26it/s, init loss: 73.5360, avg. loss [1901-2000]: 33.3718]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a     -0.09      0.13     -0.09     -0.30      0.10   1008.94      1.00
         b      0.08      0.15      0.08     -0.15      0.33   1012.61      1.00
        b2     -0.22      0.23     -0.22     -0.58      0.13    921.73      1.00
     sigma      0.45      0.17      0.42      0.19      0.67    765.92      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;revenue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">mu_mean_7h1_linear</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">mu_mean_7h1_curved</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">mu_mean_7h2_linear</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">mu_mean_7h2_curved</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7c431cf869f0&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_97_1.png" src="../_images/notebooks_07_ulysse_s_copmpass_97_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_7h2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="n">idata_7h1_linear</span><span class="p">,</span>
        <span class="s2">&quot;curved&quot;</span><span class="p">:</span> <span class="n">idata_7h1_curved</span><span class="p">,</span>
        <span class="s2">&quot;linear_t&quot;</span><span class="p">:</span> <span class="n">idata_7h2_linear</span><span class="p">,</span>
        <span class="s2">&quot;curved_t&quot;</span><span class="p">:</span> <span class="n">idata_7h2_curved</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;loo&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">compare_7h2</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">compare_7h2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:792: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.67 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:792: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.67 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
/home/ltiako/.local/share/hatch/env/virtual/rethinking/ANFAH7h_/rethinking/lib/python3.12/site-packages/arviz/stats/stats.py:792: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.67 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_loo</th>
      <th>p_loo</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>linear_t</th>
      <td>0</td>
      <td>74.833714</td>
      <td>3.626794</td>
      <td>0.000000</td>
      <td>6.473104e-01</td>
      <td>12.725665</td>
      <td>0.000000</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>linear</th>
      <td>1</td>
      <td>87.509323</td>
      <td>5.297136</td>
      <td>12.675609</td>
      <td>3.278450e-16</td>
      <td>20.542279</td>
      <td>12.595333</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>curved</th>
      <td>2</td>
      <td>89.735589</td>
      <td>7.455492</td>
      <td>14.901875</td>
      <td>1.058069e-01</td>
      <td>25.347745</td>
      <td>17.004461</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>curved_t</th>
      <td>3</td>
      <td>89.735589</td>
      <td>7.455492</td>
      <td>14.901875</td>
      <td>2.468827e-01</td>
      <td>25.347745</td>
      <td>17.004461</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Model comparison\nlower is better&#39;}, xlabel=&#39;elpd_loo (deviance)&#39;, ylabel=&#39;ranked models&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_98_3.png" src="../_images/notebooks_07_ulysse_s_copmpass_98_3.png" />
</div>
</div>
</section>
<section id="7H3">
<h3>7H3<a class="headerlink" href="#7H3" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Island 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Island 2&quot;</span><span class="p">,</span> <span class="s2">&quot;Island 3&quot;</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Species A&quot;</span><span class="p">,</span> <span class="s2">&quot;Species B&quot;</span><span class="p">,</span> <span class="s2">&quot;Species C&quot;</span><span class="p">,</span> <span class="s2">&quot;Species D&quot;</span><span class="p">,</span> <span class="s2">&quot;Species D&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Species A</th>
      <th>Species B</th>
      <th>Species C</th>
      <th>Species D</th>
      <th>Species D</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Island 1</th>
      <td>0.20</td>
      <td>0.20</td>
      <td>0.20</td>
      <td>0.200</td>
      <td>0.200</td>
    </tr>
    <tr>
      <th>Island 2</th>
      <td>0.80</td>
      <td>0.10</td>
      <td>0.05</td>
      <td>0.025</td>
      <td>0.025</td>
    </tr>
    <tr>
      <th>Island 3</th>
      <td>0.05</td>
      <td>0.15</td>
      <td>0.70</td>
      <td>0.050</td>
      <td>0.050</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Array([1.609438  , 0.74300396, 0.9836004 ], dtype=float32)
</pre></div></div>
</div>
<p>The first (second) island has the most (least) uncertainty as to the distribution of species.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kl_divergences</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">kl_divergences</span> <span class="o">=</span> <span class="n">kl_divergences</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">q</span><span class="p">)))</span>
<span class="n">kl_divergences</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kl_divergences</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">kl_divergences</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Island 1</th>
      <th>Island 2</th>
      <th>Island 3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Island 1</th>
      <td>0.000000</td>
      <td>0.970406</td>
      <td>0.638760</td>
    </tr>
    <tr>
      <th>Island 2</th>
      <td>0.866434</td>
      <td>0.000000</td>
      <td>2.010914</td>
    </tr>
    <tr>
      <th>Island 3</th>
      <td>0.625838</td>
      <td>1.838845</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Island 1 predicts the other best because it has the higher entropy. So it is the least surprised when it’s contradicted.</p>
</section>
<section id="id1">
<h3>7H3<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sim_happiness</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1977</span><span class="p">,</span> <span class="n">N_years</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">N_births</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">aom</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
    <span class="c1"># age existing individuals &amp; newborns</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_years</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">N_births</span><span class="p">)</span>
    <span class="c1"># sim happiness trait - never changes</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N_births</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">N_years</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># not yet married</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_years</span> <span class="o">*</span> <span class="n">N_births</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_M</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="c1"># for each person over 17, chance get married</span>
        <span class="n">married</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">A</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">married</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="n">aom</span><span class="p">,</span> <span class="n">max_age</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">update_M</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="c1"># mortality</span>
    <span class="n">deaths</span> <span class="o">=</span> <span class="n">A</span> <span class="o">&gt;</span> <span class="n">max_age</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="o">~</span><span class="n">deaths</span><span class="p">]</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="o">~</span><span class="n">deaths</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="o">~</span><span class="n">deaths</span><span class="p">]</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="s2">&quot;married&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="s2">&quot;happiness&quot;</span><span class="p">:</span> <span class="n">H</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="n">df</span> <span class="o">=</span> <span class="n">sim_happiness</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1977</span><span class="p">,</span> <span class="n">N_years</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">17</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df2</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">65</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">model_6_9</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">married</span><span class="p">,</span> <span class="n">happiness</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;married&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">[</span><span class="n">married</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">happiness</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;happiness&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">happiness</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">happiness</span>


<span class="n">guide_6_9</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_6_9</span><span class="p">)</span>
<span class="n">svi_6_9</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_6_9</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_6_9</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">married</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;married&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">happiness</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;happiness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
<span class="n">posterior_samples_6_9</span> <span class="o">=</span> <span class="n">guide_6_9</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_6_9</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2_500</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_6_9</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">log_likelihood_6_9</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_6_9</span><span class="p">,</span>
    <span class="n">posterior_samples_6_9</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">married</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;married&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">happiness</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;happiness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">idata_6_9</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_6_9</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;happiness&quot;</span><span class="p">:</span> <span class="n">log_likelihood_6_9</span><span class="p">[</span><span class="s2">&quot;happiness&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">model_6_10</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">happiness</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">beta_age</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;beta_age&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_age</span> <span class="o">*</span> <span class="n">age</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">happiness</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;happiness&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">happiness</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">happiness</span>


<span class="n">guide_6_10</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_6_10</span><span class="p">)</span>
<span class="n">svi_6_10</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_6_10</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide_6_10</span><span class="p">,</span>
    <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">happiness</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;happiness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
<span class="n">posterior_samples_6_10</span> <span class="o">=</span> <span class="n">guide_6_10</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
    <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_6_10</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2_500</span><span class="p">,)</span>
<span class="p">)</span>
<span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
    <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_6_10</span><span class="p">),</span>
    <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">log_likelihood_6_10</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
    <span class="n">model_6_10</span><span class="p">,</span>
    <span class="n">posterior_samples_6_10</span><span class="p">,</span>
    <span class="n">age</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">happiness</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;happiness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">idata_6_10</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_6_10</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;happiness&quot;</span><span class="p">:</span> <span class="n">log_likelihood_6_10</span><span class="p">[</span><span class="s2">&quot;happiness&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████████| 5000/5000 [00:05&lt;00:00, 906.17it/s, init loss: 2664.9004, avg. loss [4751-5000]: 1384.9645]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
  alpha[0]     -0.22      0.06     -0.22     -0.32     -0.11   2369.02      1.00
  alpha[1]      1.21      0.09      1.21      1.07      1.35   2501.88      1.00
  beta_age     -0.71      0.12     -0.71     -0.90     -0.53   2493.77      1.00
     sigma      1.03      0.02      1.03      1.00      1.07   2580.85      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████| 5000/5000 [00:01&lt;00:00, 3382.17it/s, init loss: 1717.2987, avg. loss [4751-5000]: 1553.0374]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
     alpha     -0.04      0.08     -0.04     -0.16      0.08   2452.62      1.00
  beta_age     -0.04      0.13     -0.04     -0.26      0.16   2484.95      1.00
     sigma      1.22      0.03      1.22      1.17      1.26   2497.23      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_7h3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;model_6_9&quot;</span><span class="p">:</span> <span class="n">idata_6_9</span><span class="p">,</span>
        <span class="s2">&quot;model_6_10&quot;</span><span class="p">:</span> <span class="n">idata_6_10</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;loo&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">compare_7h3</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">compare_7h3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_loo</th>
      <th>p_loo</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>model_6_9</th>
      <td>0</td>
      <td>2765.444190</td>
      <td>3.495195</td>
      <td>0.000000</td>
      <td>1.000000e+00</td>
      <td>34.181813</td>
      <td>0.000000</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>model_6_10</th>
      <td>1</td>
      <td>3104.690769</td>
      <td>2.408655</td>
      <td>339.246579</td>
      <td>1.149203e-09</td>
      <td>27.706663</td>
      <td>32.793319</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Model comparison\nlower is better&#39;}, xlabel=&#39;elpd_loo (deviance)&#39;, ylabel=&#39;ranked models&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_107_2.png" src="../_images/notebooks_07_ulysse_s_copmpass_107_2.png" />
</div>
</div>
<p>The confounded model is much better at predicting. Even though marriage doesn’t cause happiness, being married is statistically associated with being happy.</p>
</section>
<section id="7H5">
<h3>7H5<a class="headerlink" href="#7H5" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/foxes.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;avgfood&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;groupsize&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span>

<span class="n">Xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">]],</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">]],</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">]],</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;F&quot;</span><span class="p">]],</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">]]]</span>
<span class="n">idata_7h5</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">Xs</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">model_7h5</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="n">guide_7h5</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">model_7h5</span><span class="p">)</span>
    <span class="n">svi_7h5</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_7h5</span><span class="p">,</span>
        <span class="n">guide</span><span class="o">=</span><span class="n">guide_7h5</span><span class="p">,</span>
        <span class="n">optim</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jrng</span><span class="p">,</span> <span class="mi">2_500</span><span class="p">)</span>
    <span class="n">posterior_samples_7h5</span> <span class="o">=</span> <span class="n">guide_7h5</span><span class="o">.</span><span class="n">sample_posterior</span><span class="p">(</span>
        <span class="n">jrng</span><span class="p">,</span> <span class="n">svi_7h5</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2_500</span><span class="p">,)</span>
    <span class="p">)</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">print_summary</span><span class="p">(</span>
        <span class="n">prune_return_sites</span><span class="p">(</span><span class="n">posterior_samples_7h5</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]),</span>
        <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
        <span class="n">group_by_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">log_likelihood_7h5</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">(</span>
        <span class="n">model_7h5</span><span class="p">,</span>
        <span class="n">posterior_samples_7h5</span><span class="p">,</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">idata_7h5</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="n">posterior</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posterior_samples_7h5</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="n">log_likelihood</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">log_likelihood_7h5</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████| 2500/2500 [00:01&lt;00:00, 2292.41it/s, init loss: 347.9059, avg. loss [2376-2500]: 159.4646]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.01      0.08      0.01     -0.10      0.15   2586.74      1.00
      b[0]      0.32      0.21      0.32     -0.05      0.61   2486.21      1.00
      b[1]     -0.62      0.18     -0.61     -0.90     -0.32   2528.42      1.00
      b[2]      0.30      0.17      0.30      0.02      0.58   2480.12      1.00
     sigma      0.94      0.06      0.94      0.84      1.03   2582.27      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████| 2500/2500 [00:01&lt;00:00, 2487.71it/s, init loss: 347.3550, avg. loss [2376-2500]: 160.3276]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.01      0.08      0.01     -0.11      0.13   2369.02      1.00
      b[0]      0.50      0.18      0.51      0.21      0.78   2461.81      1.00
      b[1]     -0.54      0.18     -0.54     -0.82     -0.25   2475.63      1.00
     sigma      0.92      0.06      0.91      0.82      1.01   2554.65      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████| 2500/2500 [00:00&lt;00:00, 2643.51it/s, init loss: 336.5728, avg. loss [2376-2500]: 160.0212]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.01      0.08      0.01     -0.11      0.15   2369.02      1.00
      b[0]     -0.49      0.15     -0.49     -0.74     -0.26   2462.02      1.00
      b[1]      0.40      0.15      0.40      0.17      0.66   2477.58      1.00
     sigma      0.97      0.07      0.97      0.87      1.08   2604.23      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████| 2500/2500 [00:00&lt;00:00, 2751.14it/s, init loss: 376.6222, avg. loss [2376-2500]: 164.7577]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a      0.00      0.08     -0.00     -0.13      0.13   2452.62      1.00
      b[0]     -0.02      0.09     -0.02     -0.17      0.11   2373.27      1.00
     sigma      0.94      0.06      0.93      0.84      1.02   2511.08      1.00

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████| 2500/2500 [00:01&lt;00:00, 2382.15it/s, init loss: 368.0105, avg. loss [2376-2500]: 164.6754]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

                mean       std    median      5.5%     94.5%     n_eff     r_hat
         a     -0.00      0.08     -0.00     -0.13      0.13   2452.62      1.00
      b[0]      0.02      0.09      0.02     -0.13      0.16   2373.27      1.00
     sigma      1.00      0.07      0.99      0.88      1.10   2510.91      1.00

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_7h5</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">Xs</span><span class="p">],</span> <span class="n">idata_7h5</span><span class="p">)),</span>
    <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;loo&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">compare_7h5</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">compare_7h5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>elpd_loo</th>
      <th>p_loo</th>
      <th>elpd_diff</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>FGA</th>
      <td>0</td>
      <td>323.824064</td>
      <td>4.883369</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>15.811094</td>
      <td>0.000000</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>GA</th>
      <td>1</td>
      <td>323.915248</td>
      <td>3.562463</td>
      <td>0.091184</td>
      <td>5.371548e-01</td>
      <td>14.868673</td>
      <td>3.016054</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>FG</th>
      <td>2</td>
      <td>325.047902</td>
      <td>4.007474</td>
      <td>1.223838</td>
      <td>4.628452e-01</td>
      <td>16.606496</td>
      <td>3.933400</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>A</th>
      <td>3</td>
      <td>333.739234</td>
      <td>2.640863</td>
      <td>9.915170</td>
      <td>1.070896e-15</td>
      <td>13.642306</td>
      <td>6.832758</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>F</th>
      <td>4</td>
      <td>334.815024</td>
      <td>2.757669</td>
      <td>10.990960</td>
      <td>0.000000e+00</td>
      <td>15.507010</td>
      <td>6.999877</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Model comparison\nlower is better&#39;}, xlabel=&#39;elpd_loo (deviance)&#39;, ylabel=&#39;ranked models&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_07_ulysse_s_copmpass_111_2.png" src="../_images/notebooks_07_ulysse_s_copmpass_111_2.png" />
</div>
</div>
<p>Models using just food or just area have the weakest predictive power since they’re confounded (negatively correlated and each correlated to the outcome) The remaining models are hard to distinguish from one another.</p>
</section>
</section>
</section>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">

          <div class="sidebar-resize-handle"></div>

<h3><a href="../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="02_small_and_large_worlds.html">Chapter 2: Small Worlds And Large Worlds</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_sampling_the_imaginary.html">Chapter 3: Sampling the Imaginary</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_geocentric_models.html">Chapter 4: Geocentric Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_the_many_variables_and_the_spurious_waffles.html">Chapter 5: The Many Variables And The Spurious Waffles</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_the_haunted_dag_and_the_causal_terror.html">Chapter 6: The Haunted DAG &amp; The Causal Terror</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Chapter 7: Ulysse’s Compass</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_conditional_manatees.html">Chapter 8: Conditional Manatees</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_markov_chain_monte_carlo.html">Chapter 9: Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_big_entropy_and_the_generalized_linear_model.html">Chapter 10: Big Entropy and the Generalized Linear Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_god_spiked_the_integers.html">Chapter 11: God Spiked the Integers</a></li>
<li class="toctree-l1"><a class="reference internal" href="12_monsters_and_mixtures.html">Chapter 12: Monsters and Mixtures</a></li>
</ul>

<div><hr class="docutils"></div>
<ul>
  <li class="toctree-l1"><a class="reference internal" href="../genindex.html" accesskey="I">General Index</a></li>
</ul>
<div id="ethical-ad-placement"></div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <nav class="relbar">
      <a class="previous" href="06_the_haunted_dag_and_the_causal_terror.html" aria-label="Previous topic" >
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>
        </div>
        <div class="title">
          <span class="text">
            <span class="direction">previous</span>
            Chapter 6: The Haunted DAG &amp; The Causal Terror
          </span>
        </div>
      </a>
      <a class="next" href="08_conditional_manatees.html" aria-label="Next topic" >
        <div class="title">
          <span class="text">
            <span class="direction">next</span>
            Chapter 8: Conditional Manatees
          </span>
        </div>
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"/></svg>
        </div>
      </a>
    </nav>

    <footer role="contentinfo">
      &#169; Copyright 2022, Ludovic Tiako.
      Created using <a class="reference external" href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
      <a class="reference external" href="https://insipid-sphinx-theme.readthedocs.io/">Insipid Theme</a>.
    </footer>
  </body>
</html>